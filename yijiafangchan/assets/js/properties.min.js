/**
 * 楼盘展示页面专用JavaScript - 优化版
 * 优化内容：代码压缩、性能优化、防抖处理
 */
class PropertiesPage{constructor(){this.allProperties=[];this.filteredProperties=[];this.currentPage=1;this.pageSize=9;this.viewMode="grid";this.filters={type:"",price:"",area:"",sort:"default"};this.debounceTimer=null;this.init()}init(){if(window.performance){performance.mark("properties-init-start")}this.loadAllProperties();this.setupEventListeners();this.setupViewToggle();if(window.performance){performance.mark("properties-init-end");performance.measure("properties-initialization","properties-init-start","properties-init-end");console.log("[性能] 楼盘页面初始化完成")}}loadAllProperties(){this.allProperties=[{id:1,title:"维罗纳花园",location:"大丰区维罗纳步行街",type:"new",price:8800,priceUnit:"/㎡起",area:"89-128",rooms:"2-4室",floor:"18层",image:"assets/images/property-1.jpg",badge:"热销",description:"位于维罗纳步行街核心地段，交通便利，配套完善",features:["南北通透","精装修","地铁沿线","商业配套"]},{id:2,title:"建发珺和府",location:"大丰区新城区",type:"new",price:9200,priceUnit:"/㎡起",area:"108-138",rooms:"3-4室",floor:"26层",image:"assets/images/property-2.jpg",badge:"新盘",description:"大丰唯一建发品牌项目，品质住宅典范",features:["品牌开发商","高层视野","智能化","会所配套"]},{id:3,title:"月湖花城",location:"大丰区南环路",type:"second-hand",price:7500,priceUnit:"/㎡",area:"125",rooms:"3室2厅",floor:"11/18层",image:"assets/images/property-3.jpg",badge:"精装",description:"成熟社区，精装修，拎包入住",features:["拎包入住","成熟社区","学区房","交通便利"]},{id:4,title:"杰仕豪庭",location:"大丰区人民路",type:"second-hand",price:8200,priceUnit:"/㎡",area:"142",rooms:"4室2厅",floor:"8/15层",image:"assets/images/property-4.jpg",badge:"优质",description:"黄金地段，成熟配套，投资自住两相宜",features:["黄金地段","户型方正","采光良好","配套成熟"]},{id:5,title:"馥桂名居",location:"大丰区西环路",type:"rental",price:2200,priceUnit:"/月",area:"90",rooms:"2室1厅",floor:"6/12层",image:"assets/images/property-5.jpg",badge:"急租",description:"精装两房，家电齐全，拎包入住",features:["家电齐全","拎包入住","交通便利","周边配套"]},{id:6,title:"阳光水岸",location:"大丰区东方路",type:"rental",price:3500,priceUnit:"/月",area:"120",rooms:"3室2厅",floor:"12/20层",image:"assets/images/property-6.jpg",badge:"豪装",description:"豪华装修三房，视野开阔，环境优美",features:["豪华装修","家电齐全","环境优美","视野开阔"]},{id:7,title:"碧桂园",location:"大丰区南阳镇",type:"new",price:7800,priceUnit:"/㎡起",area:"89-142",rooms:"2-4室",floor:"33层",image:"assets/images/property-7.jpg",badge:"特惠",description:"品牌开发商，品质保证，特惠价格",features:["品牌开发商","品质保证","特惠价格","环境优美"]},{id:8,title:"恒大名都",location:"大丰区幸福路",type:"new",price:8500,priceUnit:"/㎡起",area:"106-143",rooms:"3-4室",floor:"32层",image:"assets/images/property-8.jpg",badge:"热销",description:"恒大品质，精工筑家，品质生活",features:["品牌开发商","精工筑家","品质生活","配套完善"]},{id:9,title:"东方明珠",location:"大丰区黄海路",type:"second-hand",price:7200,priceUnit:"/㎡",area:"118",rooms:"3室2厅",floor:"9/18层",image:"assets/images/property-9.jpg",badge:"满五唯一",description:"满五唯一，税费低，黄金地段",features:["满五唯一","税费低","黄金地段","配套完善"]},{id:10,title:"绿地世纪城",location:"大丰区健康路",type:"second-hand",price:7800,priceUnit:"/㎡",area:"135",rooms:"3室2厅",floor:"15/28层",image:"assets/images/property-10.jpg",badge:"急售",description:"业主急售，价格可谈，视野开阔",features:["业主急售","价格可谈","视野开阔","环境优美"]},{id:11,title:"万科城市花园",location:"大丰区人民南路",type:"rental",price:2800,priceUnit:"/月",area:"100",rooms:"3室1厅",floor:"8/15层",image:"assets/images/property-11.jpg",badge:"近地铁",description:"近地铁，交通便利，家电齐全",features:["近地铁","交通便利","家电齐全","拎包入住"]},{id:12,title:"保利花园",location:"大丰区幸福路",type:"rental",price:4000,priceUnit:"/月",area:"150",rooms:"4室2厅",floor:"18/33层",image:"assets/images/property-12.jpg",badge:"豪装",description:"豪华装修四房，品质小区，环境优美",features:["豪华装修","品质小区","环境优美","配套完善"]}];this.filterProperties();this.renderProperties()}setupEventListeners(){document.querySelectorAll(".filter-option").forEach(option=>{option.addEventListener("click",e=>{const filterType=e.target.dataset.filterType;const filterValue=e.target.dataset.filterValue;this.applyFilter(filterType,filterValue);e.preventDefault()})});document.getElementById("sort-select").addEventListener("change",e=>{this.filters.sort=e.target.value;this.filterProperties();this.renderProperties()});document.getElementById("search-input").addEventListener("input",this.debounce(e=>{const searchTerm=e.target.value.toLowerCase();if(searchTerm.length>0){this.filteredProperties=this.allProperties.filter(property=>property.title.toLowerCase().includes(searchTerm)||property.location.toLowerCase().includes(searchTerm)||property.description.toLowerCase().includes(searchTerm));this.renderProperties()}else{this.filterProperties();this.renderProperties()}},300));document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){this.refreshView()}});window.addEventListener("resize",this.debounce(()=>{this.adjustLayout()},200))}debounce(func,delay){return(...args)=>{clearTimeout(this.debounceTimer);this.debounceTimer=setTimeout(()=>{func.apply(this,args)},delay)}}setupViewToggle(){const gridViewBtn=document.getElementById("grid-view");const listViewBtn=document.getElementById("list-view");gridViewBtn.addEventListener("click",()=>{this.viewMode="grid";gridViewBtn.classList.add("active");listViewBtn.classList.remove("active");this.renderProperties()});listViewBtn.addEventListener("click",()=>{this.viewMode="list";listViewBtn.classList.add("active");gridViewBtn.classList.remove("active");this.renderProperties()})}applyFilter(filterType,filterValue){if(this.filters[filterType]===filterValue){this.filters[filterType]=""}else{this.filters[filterType]=filterValue}document.querySelectorAll(`.filter-option[data-filter-type="${filterType}"]`).forEach(option=>{if(option.dataset.filterValue===filterValue){option.classList.toggle("active")}else{option.classList.remove("active")}});this.filterProperties();this.renderProperties()}filterProperties(){this.filteredProperties=this.allProperties.filter(property=>{let matchesType=true;let matchesPrice=true;let matchesArea=true;if(this.filters.type&&property.type!==this.filters.type){matchesType=false}if(this.filters.price){const price=parseInt(property.price);if(this.filters.price==="<8000"&&price>=8000){matchesPrice=false}else if(this.filters.price==="8000-9000"&&(price<8000||price>9000)){matchesPrice=false}else if(this.filters.price===">9000"&&price<=9000){matchesPrice=false}}if(this.filters.area){const areaRange=property.area.split("-");const minArea=parseInt(areaRange[0]);const maxArea=areaRange.length>1?parseInt(areaRange[1]):minArea;if(this.filters.area==="<100"&&minArea>=100){matchesArea=false}else if(this.filters.area==="100-120"&&(maxArea<100||minArea>120)){matchesArea=false}else if(this.filters.area===">120"&&maxArea<=120){matchesArea=false}}return matchesType&&matchesPrice&&matchesArea});this.sortProperties()}sortProperties(){switch(this.filters.sort){case"price-asc":this.filteredProperties.sort((a,b)=>a.price-b.price);break;case"price-desc":this.filteredProperties.sort((a,b)=>b.price-a.price);break;case"area-asc":this.filteredProperties.sort((a,b)=>{const areaA=parseInt(a.area.split("-")[0]);const areaB=parseInt(b.area.split("-")[0]);return areaA-areaB});break;case"area-desc":this.filteredProperties.sort((a,b)=>{const areaA=parseInt(a.area.split("-")[0]);const areaB=parseInt(b.area.split("-")[0]);return areaB-areaA});break;default:this.filteredProperties.sort((a,b)=>a.id-b.id)}}renderProperties(){const propertiesContainer=document.getElementById("properties-container");propertiesContainer.innerHTML="";const totalPages=Math.ceil(this.filteredProperties.length/this.pageSize);const startIndex=(this.currentPage-1)*this.pageSize;const endIndex=Math.min(startIndex+this.pageSize,this.filteredProperties.length);const currentProperties=this.filteredProperties.slice(startIndex,endIndex);if(currentProperties.length===0){propertiesContainer.innerHTML=`<div class="col-12 text-center py-5"><h3>没有找到符合条件的房源</h3><p>请尝试调整筛选条件</p></div>`;return}if(this.viewMode==="grid"){propertiesContainer.classList.add("row");propertiesContainer.classList.add("row-cols-1");propertiesContainer.classList.add("row-cols-md-2");propertiesContainer.classList.add("row-cols-lg-3");propertiesContainer.classList.add("g-4");currentProperties.forEach(property=>{const propertyCard=this.createPropertyCard(property);propertiesContainer.appendChild(propertyCard)})}else{propertiesContainer.classList.remove("row-cols-md-2");propertiesContainer.classList.remove("row-cols-lg-3");propertiesContainer.classList.add("row");currentProperties.forEach(property=>{const propertyListItem=this.createPropertyListItem(property);propertiesContainer.appendChild(propertyListItem)})}this.renderPagination(totalPages)}createPropertyCard(property){const col=document.createElement("div");col.className="col";col.innerHTML=`
            <div class="card h-100 property-card">
                ${property.badge?`<span class="badge bg-primary position-absolute top-0 end-0 m-2">${property.badge}</span>`:""}
                <img src="${property.image}" class="card-img-top" alt="${property.title}">
                <div class="card-body">
                    <h5 class="card-title">${property.title}</h5>
                    <p class="card-text text-muted"><i class="fas fa-map-marker-alt"></i> ${property.location}</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="price">${property.price}<small>${property.priceUnit}</small></span>
                        <span class="area">${property.area}㎡</span>
                    </div>
                    <p class="card-text">${property.description}</p>
                    <div class="property-features">
                        ${property.features.map(feature=>`<span class="badge bg-light text-dark me-1 mb-1">${feature}</span>`).join("")}
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${property.rooms} | ${property.floor}</small>
                        <a href="property-detail.html?id=${property.id}" class="btn btn-sm btn-outline-primary">查看详情</a>
                    </div>
                </div>
            </div>
        `;return col}createPropertyListItem(property){const row=document.createElement("div");row.className="col-12 mb-4";row.innerHTML=`
            <div class="card property-list-item">
                <div class="row g-0">
                    <div class="col-md-4 position-relative">
                        ${property.badge?`<span class="badge bg-primary position-absolute top-0 end-0 m-2">${property.badge}</span>`:""}
                        <img src="${property.image}" class="img-fluid rounded-start h-100 w-100 object-fit-cover" alt="${property.title}" loading="lazy">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body h-100 d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">${property.title}</h5>
                                <span class="price">${property.price}<small>${property.priceUnit}</small></span>
                            </div>
                            <p class="card-text text-muted"><i class="fas fa-map-marker-alt"></i> ${property.location}</p>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="area">${property.area}㎡ | ${property.rooms} | ${property.floor}</span>
                            </div>
                            <p class="card-text flex-grow-1">${property.description}</p>
                            <div class="property-features mb-3">
                                ${property.features.map(feature=>`<span class="badge bg-light text-dark me-1 mb-1">${feature}</span>`).join("")}
                            </div>
                            <a href="property-detail.html?id=${property.id}" class="btn btn-outline-primary">查看详情</a>
                        </div>
                    </div>
                </div>
            </div>
        `;return row}refreshView(){if(window.performance){performance.mark("refresh-view-start")}this.filterProperties();this.renderProperties();if(window.performance){performance.mark("refresh-view-end");performance.measure("properties-refresh","refresh-view-start","refresh-view-end")}}adjustLayout(){const width=window.innerWidth;if(width<768&&this.viewMode==="grid"){document.getElementById("properties-container").classList.remove("row-cols-md-2","row-cols-lg-3");document.getElementById("properties-container").classList.add("row-cols-1")}else if(width>=768&&width<992&&this.viewMode==="grid"){document.getElementById("properties-container").classList.remove("row-cols-1","row-cols-lg-3");document.getElementById("properties-container").classList.add("row-cols-md-2")}else if(width>=992&&this.viewMode==="grid"){document.getElementById("properties-container").classList.remove("row-cols-1");document.getElementById("properties-container").classList.add("row-cols-md-2","row-cols-lg-3")}}renderPagination(totalPages){const paginationContainer=document.getElementById("pagination-container");paginationContainer.innerHTML="";if(totalPages<=1){return}const pagination=document.createElement("nav");pagination.setAttribute("aria-label","Page navigation");const paginationList=document.createElement("ul");paginationList.className="pagination justify-content-center";const prevPageItem=document.createElement("li");prevPageItem.className=`page-item ${this.currentPage===1?"disabled":""}`;prevPageItem.innerHTML=`<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;prevPageItem.addEventListener("click",e=>{if(this.currentPage>1){this.currentPage--;this.renderProperties()}e.preventDefault()});paginationList.appendChild(prevPageItem);for(let i=1;i<=totalPages;i++){const pageItem=document.createElement("li");pageItem.className=`page-item ${i===this.currentPage?"active":""}`;pageItem.innerHTML=`<a class="page-link" href="#">${i}</a>`;pageItem.addEventListener("click",e=>{this.currentPage=i;this.renderProperties();e.preventDefault()});paginationList.appendChild(pageItem)}const nextPageItem=document.createElement("li");nextPageItem.className=`page-item ${this.currentPage===totalPages?"disabled":""}`;nextPageItem.innerHTML=`<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;nextPageItem.addEventListener("click",e=>{if(this.currentPage<totalPages){this.currentPage++;this.renderProperties()}e.preventDefault()});paginationList.appendChild(nextPageItem);pagination.appendChild(paginationList);paginationContainer.appendChild(pagination)}}document.addEventListener("DOMContentLoaded",()=>{window.propertiesPage=new PropertiesPage()});