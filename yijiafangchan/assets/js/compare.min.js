/**
 * 房产对比系统 - 优化版
 * 支持多个房产信息的并排对比分析
 */

class PropertyCompare {
    constructor() {
        this.properties = [];
        this.selectedProperties = [];
        this.maxCompareCount = 4;
        
        this.init();
    }
    
    /**
     * 初始化对比系统
     */
    init() {
        this.loadPropertyData();
        this.renderPropertySelector();
        this.bindEvents();
        this.updateUI();
        
        console.log('[PropertyCompare] 房产对比系统初始化完成');
    }
    
    /**
     * 绑定事件监听
     */
    bindEvents() {
        // 绑定清空对比按钮
        const clearBtn = document.getElementById('clear-compare');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => this.clearCompare());
        }
        
        // 绑定生成报告按钮
        const reportBtn = document.getElementById('generate-report');
        if (reportBtn) {
            reportBtn.addEventListener('click', () => this.generateReport());
        }
    }
    
    /**
     * 加载房产数据
     */
    loadPropertyData() {
        // 扩展房产数据，包含更多对比信息
        this.properties = [
            {
                id: 1,
                name: '金桂花园',
                type: 'house',
                price: 150,
                priceUnit: '万',
                location: '大丰区新丰镇',
                area: '120㎡',
                buildYear: '2022',
                floors: '18层',
                households: '288户',
                developer: '宜家房产',
                image: 'assets/images/property1.jpg',
                features: ['精装修', '学区房', '地铁沿线', '停车位'],
                avgPrice: 12500,
                totalPrice: 150,
                downPayment: 45,
                greenRate: '40%',
                parkingRate: '1:1.2',
                propertyFee: '2.5元/㎡/月',
                schoolDistrict: '大丰第一小学',
                subway: '地铁1号线',
                busLines: '101路、201路、301路',
                hospitals: '大丰人民医院',
                shopping: '万达广场',
                description: '金桂花园位于大丰区新丰镇，是宜家房产开发的高品质住宅小区，拥有优质的社区环境和完善的配套设施。'
            },
            {
                id: 2,
                name: '阳光水岸',
                type: 'apartment',
                price: 120,
                priceUnit: '万',
                location: '盐城市亭湖区',
                area: '89㎡',
                buildYear: '2021',
                floors: '24层',
                households: '480户',
                developer: '恒大地产',
                image: 'assets/images/property2.jpg',
                features: ['河景房', '配套齐全', '交通便利'],
                avgPrice: 13500,
                totalPrice: 120,
                downPayment: 36,
                greenRate: '35%',
                parkingRate: '1:1',
                propertyFee: '2.2元/㎡/月',
                schoolDistrict: '亭湖实验学校',
                subway: '暂无',
                busLines: '102路、202路',
                hospitals: '亭湖区人民医院',
                shopping: '万达广场、吾悦广场',
                description: '阳光水岸位于盐城市亭湖区，临近水系，环境优美，是城市中心区域的品质住宅。'
            },
            {
                id: 3,
                name: '翡翠公馆',
                type: 'villa',
                price: 280,
                priceUnit: '万',
                location: '盐城市城南新区',
                area: '180㎡',
                buildYear: '2023',
                floors: '3层',
                households: '120户',
                developer: '碧桂园',
                image: 'assets/images/property3.jpg',
                features: ['花园洋房', '低密度', '智能家居', '双车位'],
                avgPrice: 15600,
                totalPrice: 280,
                downPayment: 84,
                greenRate: '45%',
                parkingRate: '1:2',
                propertyFee: '3.5元/㎡/月',
                schoolDistrict: '城南实验学校',
                subway: '地铁2号线',
                busLines: '103路、203路、303路',
                hospitals: '城南医院',
                shopping: '印象城',
                description: '翡翠公馆是城南新区的高端别墅项目，拥有宽敞的居住空间和私家花园，是追求品质生活的理想选择。'
            },
            {
                id: 4,
                name: '滨海名苑',
                type: 'house',
                price: 135,
                priceUnit: '万',
                location: '滨海县城区',
                area: '110㎡',
                buildYear: '2022',
                floors: '18层',
                households: '360户',
                developer: '宜家房产',
                image: 'assets/images/property4.jpg',
                features: ['海景房', '配套齐全', '交通便利'],
                avgPrice: 12300,
                totalPrice: 135,
                downPayment: 40.5,
                greenRate: '38%',
                parkingRate: '1:1.1',
                propertyFee: '2.3元/㎡/月',
                schoolDistrict: '滨海实验学校',
                subway: '暂无',
                busLines: '104路、204路',
                hospitals: '滨海人民医院',
                shopping: '滨海购物中心',
                description: '滨海名苑位于滨海县城区，临近海岸线，拥有优美的海景视野和完善的生活配套。'
            },
            {
                id: 5,
                name: '东方明珠',
                type: 'apartment',
                price: 165,
                priceUnit: '万',
                location: '盐城市城东新区',
                area: '130㎡',
                buildYear: '2023',
                floors: '32层',
                households: '640户',
                developer: '万科地产',
                image: 'assets/images/property5.jpg',
                features: ['高层景观', '智能家居', '健身房', '游泳池'],
                avgPrice: 12700,
                totalPrice: 165,
                downPayment: 49.5,
                greenRate: '42%',
                parkingRate: '1:1.3',
                propertyFee: '2.8元/㎡/月',
                schoolDistrict: '城东第一小学',
                subway: '地铁1号线',
                busLines: '105路、205路、305路',
                hospitals: '城东医院',
                shopping: '东方购物中心',
                description: '东方明珠是城东新区的地标性建筑，拥有开阔的视野和现代化的社区配套，是城市新兴区域的品质住宅。'
            },
            {
                id: 6,
                name: '御景华府',
                type: 'villa',
                price: 320,
                priceUnit: '万',
                location: '盐城市开发区',
                area: '220㎡',
                buildYear: '2023',
                floors: '3层',
                households: '80户',
                developer: '华润置地',
                image: 'assets/images/property6.jpg',
                features: ['独栋别墅', '私家花园', '智能家居', '双车位'],
                avgPrice: 14500,
                totalPrice: 320,
                downPayment: 96,
                greenRate: '50%',
                parkingRate: '1:2.5',
                propertyFee: '4.0元/㎡/月',
                schoolDistrict: '开发区实验学校',
                subway: '地铁3号线',
                busLines: '106路、206路、306路',
                hospitals: '开发区医院',
                shopping: '华润万象城',
                description: '御景华府是盐城市开发区的高端别墅项目，拥有宽敞的居住空间和私密的生活环境，是高端人士的理想居所。'
            }
        ];
    }
    
    /**
     * 渲染房产选择器
     */
    renderPropertySelector() {
        const container = document.getElementById('property-selector');
        if (!container) return;
        
        let html = '';
        
        this.properties.forEach(property => {
            html += `
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <img src="${property.image}" class="card-img-top" alt="${property.name}" loading="lazy">
                        <div class="card-body">
                            <h5 class="card-title">${property.name}</h5>
                            <p class="card-text">${property.location} | ${property.area}</p>
                            <p class="card-text text-primary fw-bold">${property.price}${property.priceUnit}</p>
                            <div class="d-flex flex-wrap mb-2">
                                ${property.features.map(feature => `<span class="badge bg-secondary me-1 mb-1">${feature}</span>`).join('')}
                            </div>
                            <button class="btn btn-primary add-to-compare" data-id="${property.id}">添加到对比</button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // 添加事件监听
        document.querySelectorAll('.add-to-compare').forEach(button => {
            button.addEventListener('click', (e) => {
                const propertyId = parseInt(e.target.getAttribute('data-id'));
                this.addToCompare(propertyId);
            });
        });
    }
    
    /**
     * 添加到对比
     */
    addToCompare(propertyId) {
        // 检查是否已经在对比列表中
        if (this.selectedProperties.some(p => p.id === propertyId)) {
            alert('该房产已在对比列表中');
            return;
        }
        
        // 检查是否超过最大对比数量
        if (this.selectedProperties.length >= this.maxCompareCount) {
            alert(`最多只能对比${this.maxCompareCount}个房产`);
            return;
        }
        
        // 查找房产并添加到对比列表
        const property = this.properties.find(p => p.id === propertyId);
        if (property) {
            this.selectedProperties.push(property);
            this.updateCompareTable();
            this.updateUI();
        }
    }
    
    /**
     * 从对比中移除
     */
    removeFromCompare(propertyId) {
        this.selectedProperties = this.selectedProperties.filter(p => p.id !== propertyId);
        this.updateCompareTable();
        this.updateUI();
    }
    
    /**
     * 清空对比
     */
    clearCompare() {
        this.selectedProperties = [];
        this.updateCompareTable();
        this.updateUI();
    }
    
    /**
     * 更新对比表格
     */
    updateCompareTable() {
        const container = document.getElementById('compare-table-container');
        if (!container) return;
        
        if (this.selectedProperties.length === 0) {
            container.innerHTML = '<div class="alert alert-info">请选择要对比的房产</div>';
            return;
        }
        
        let html = `
            <table class="table table-bordered compare-table">
                <thead>
                    <tr>
                        <th>对比项</th>
                        ${this.selectedProperties.map(p => `<th>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${p.name}</span>
                                <button class="btn btn-sm btn-danger remove-from-compare" data-id="${p.id}">移除</button>
                            </div>
                        </th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>图片</td>
                        ${this.selectedProperties.map(p => `<td><img src="${p.image}" class="img-fluid" alt="${p.name}" style="max-height: 150px;"></td>`).join('')}
                    </tr>
                    <tr>
                        <td>价格</td>
                        ${this.selectedProperties.map(p => `<td class="text-primary fw-bold">${p.price}${p.priceUnit}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>均价</td>
                        ${this.selectedProperties.map(p => `<td>${p.avgPrice}元/㎡</td>`).join('')}
                    </tr>
                    <tr>
                        <td>首付</td>
                        ${this.selectedProperties.map(p => `<td>${p.downPayment}万元</td>`).join('')}
                    </tr>
                    <tr>
                        <td>位置</td>
                        ${this.selectedProperties.map(p => `<td>${p.location}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>面积</td>
                        ${this.selectedProperties.map(p => `<td>${p.area}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>类型</td>
                        ${this.selectedProperties.map(p => `<td>${this.getPropertyTypeName(p.type)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>建成年份</td>
                        ${this.selectedProperties.map(p => `<td>${p.buildYear}年</td>`).join('')}
                    </tr>
                    <tr>
                        <td>楼层</td>
                        ${this.selectedProperties.map(p => `<td>${p.floors}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>户数</td>
                        ${this.selectedProperties.map(p => `<td>${p.households}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>开发商</td>
                        ${this.selectedProperties.map(p => `<td>${p.developer}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>绿化率</td>
                        ${this.selectedProperties.map(p => `<td>${p.greenRate}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>车位比</td>
                        ${this.selectedProperties.map(p => `<td>${p.parkingRate}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>物业费</td>
                        ${this.selectedProperties.map(p => `<td>${p.propertyFee}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>学区</td>
                        ${this.selectedProperties.map(p => `<td>${p.schoolDistrict}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>地铁</td>
                        ${this.selectedProperties.map(p => `<td>${p.subway}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>公交</td>
                        ${this.selectedProperties.map(p => `<td>${p.busLines}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>医院</td>
                        ${this.selectedProperties.map(p => `<td>${p.hospitals}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>购物</td>
                        ${this.selectedProperties.map(p => `<td>${p.shopping}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>特色</td>
                        ${this.selectedProperties.map(p => `<td>
                            <div class="d-flex flex-wrap">
                                ${p.features.map(feature => `<span class="badge bg-secondary me-1 mb-1">${feature}</span>`).join('')}
                            </div>
                        </td>`).join('')}
                    </tr>
                    <tr>
                        <td>描述</td>
                        ${this.selectedProperties.map(p => `<td>${p.description}</td>`).join('')}
                    </tr>
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;
        
        // 添加移除按钮事件监听
        document.querySelectorAll('.remove-from-compare').forEach(button => {
            button.addEventListener('click', (e) => {
                const propertyId = parseInt(e.target.getAttribute('data-id'));
                this.removeFromCompare(propertyId);
            });
        });
    }
    
    /**
     * 获取房产类型名称
     */
    getPropertyTypeName(type) {
        const typeMap = {
            'house': '普通住宅',
            'apartment': '公寓',
            'villa': '别墅'
        };
        return typeMap[type] || '未知';
    }
    
    /**
     * 更新UI状态
     */
    updateUI() {
        // 更新对比按钮状态
        document.querySelectorAll('.add-to-compare').forEach(button => {
            const propertyId = parseInt(button.getAttribute('data-id'));
            if (this.selectedProperties.some(p => p.id === propertyId)) {
                button.disabled = true;
                button.textContent = '已添加';
            } else {
                button.disabled = false;
                button.textContent = '添加到对比';
            }
        });
        
        // 更新对比区域显示状态
        const compareSection = document.getElementById('compare-section');
        if (compareSection) {
            if (this.selectedProperties.length > 0) {
                compareSection.classList.remove('d-none');
            } else {
                compareSection.classList.add('d-none');
            }
        }
        
        // 更新清空按钮状态
        const clearBtn = document.getElementById('clear-compare');
        if (clearBtn) {
            clearBtn.disabled = this.selectedProperties.length === 0;
        }
        
        // 更新生成报告按钮状态
        const reportBtn = document.getElementById('generate-report');
        if (reportBtn) {
            reportBtn.disabled = this.selectedProperties.length === 0;
        }
    }
    
    /**
     * 生成对比报告
     */
    generateReport() {
        if (this.selectedProperties.length === 0) {
            alert('请先添加要对比的房产');
            return;
        }
        
        // 创建一个新窗口用于打印报告
        const reportWindow = window.open('', '_blank');
        
        // 报告HTML内容
        let reportContent = `
            <!DOCTYPE html>
            <html lang="zh-CN">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>房产对比报告 - 宜家房产</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: 20px; }
                    .report-header { margin-bottom: 30px; }
                    .property-card { margin-bottom: 20px; }
                    .compare-table th, .compare-table td { padding: 10px; }
                    @media print {
                        .no-print { display: none; }
                        a[href]:after { content: none !important; }
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="report-header text-center">
                        <h1>房产对比报告</h1>
                        <p class="text-muted">生成时间: ${new Date().toLocaleString()}</p>
                    </div>
                    
                    <div class="row mb-4">
        `;
        
        // 添加房产卡片
        this.selectedProperties.forEach(property => {
            reportContent += `
                <div class="col-md-${12 / this.selectedProperties.length}">
                    <div class="card property-card">
                        <img src="${property.image}" class="card-img-top" alt="${property.name}">
                        <div class="card-body">
                            <h5 class="card-title">${property.name}</h5>
                            <p class="card-text">${property.location} | ${property.area}</p>
                            <p class="card-text text-primary fw-bold">${property.price}${property.priceUnit}</p>
                            <div class="d-flex flex-wrap mb-2">
                                ${property.features.map(feature => `<span class="badge bg-secondary me-1 mb-1">${feature}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        reportContent += `
                    </div>
                    
                    <h2 class="mb-3">详细对比</h2>
        `;
        
        // 添加对比表格
        reportContent += `
            <table class="table table-bordered compare-table">
                <thead>
                    <tr>
                        <th>对比项</th>
                        ${this.selectedProperties.map(p => `<th>${p.name}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>价格</td>
                        ${this.selectedProperties.map(p => `<td class="text-primary fw-bold">${p.price}${p.priceUnit}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>均价</td>
                        ${this.selectedProperties.map(p => `<td>${p.avgPrice}元/㎡</td>`).join('')}
                    </tr>
                    <tr>
                        <td>首付</td>
                        ${this.selectedProperties.map(p => `<td>${p.downPayment}万元</td>`).join('')}
                    </tr>
                    <tr>
                        <td>位置</td>
                        ${this.selectedProperties.map(p => `<td>${p.location}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>面积</td>
                        ${this.selectedProperties.map(p => `<td>${p.area}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>类型</td>
                        ${this.selectedProperties.map(p => `<td>${this.getPropertyTypeName(p.type)}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>建成年份</td>
                        ${this.selectedProperties.map(p => `<td>${p.buildYear}年</td>`).join('')}
                    </tr>
                    <tr>
                        <td>楼层</td>
                        ${this.selectedProperties.map(p => `<td>${p.floors}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>户数</td>
                        ${this.selectedProperties.map(p => `<td>${p.households}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>开发商</td>
                        ${this.selectedProperties.map(p => `<td>${p.developer}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>绿化率</td>
                        ${this.selectedProperties.map(p => `<td>${p.greenRate}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>车位比</td>
                        ${this.selectedProperties.map(p => `<td>${p.parkingRate}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>物业费</td>
                        ${this.selectedProperties.map(p => `<td>${p.propertyFee}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>学区</td>
                        ${this.selectedProperties.map(p => `<td>${p.schoolDistrict}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>地铁</td>
                        ${this.selectedProperties.map(p => `<td>${p.subway}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>公交</td>
                        ${this.selectedProperties.map(p => `<td>${p.busLines}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>医院</td>
                        ${this.selectedProperties.map(p => `<td>${p.hospitals}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>购物</td>
                        ${this.selectedProperties.map(p => `<td>${p.shopping}</td>`).join('')}
                    </tr>
                    <tr>
                        <td>特色</td>
                        ${this.selectedProperties.map(p => `<td>
                            <div class="d-flex flex-wrap">
                                ${p.features.map(feature => `<span class="badge bg-secondary me-1 mb-1">${feature}</span>`).join('')}
                            </div>
                        </td>`).join('')}
                    </tr>
                    <tr>
                        <td>描述</td>
                        ${this.selectedProperties.map(p => `<td>${p.description}</td>`).join('')}
                    </tr>
                </tbody>
            </table>
        `;
        
        // 添加结尾和打印按钮
        reportContent += `
                    <div class="text-center mt-4 no-print">
                        <button class="btn btn-primary" onclick="window.print()">打印报告</button>
                        <button class="btn btn-secondary ms-2" onclick="window.close()">关闭</button>
                    </div>
                    
                    <footer class="mt-5 text-center text-muted">
                        <p>© ${new Date().getFullYear()} 宜家房产 - 专业房产对比服务</p>
                    </footer>
                </div>
                
                <script>
                    // 自动打开打印对话框
                    window.onload = function() {
                        // 延迟一秒，确保页面完全加载
                        setTimeout(function() {
                            window.print();
                        }, 1000);
                    };
                </script>
            </body>
            </html>
        `;
        
        // 写入报告内容到新窗口
        reportWindow.document.write(reportContent);
        reportWindow.document.close();
    }
}

// 初始化对比系统
document.addEventListener('DOMContentLoaded', function() {
    window.propertyCompare = new PropertyCompare();
});