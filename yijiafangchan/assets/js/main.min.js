// 宜家房产 - 优化JavaScript v1.0
"use strict";

// 性能优化工具函数
const throttle=(func,limit=100)=>{let lastFunc,lastRan;return function(){const context=this,args=arguments;if(!lastRan){func.apply(context,args);lastRan=Date.now()}else{clearTimeout(lastFunc);lastFunc=setTimeout(function(){if((Date.now()-lastRan)>=limit){func.apply(context,args);lastRan=Date.now()}},limit-((Date.now()-lastRan)||0))}}}

const debounce=(func,delay=300)=>{let timer;return function(){const context=this,args=arguments;clearTimeout(timer);timer=setTimeout(()=>func.apply(context,args),delay)}}

// 宜家房产应用类
class YijiaRealEstate{
  constructor(){this.properties=[];this.filteredProperties=[];this.currentFilter='all';}
  
  // 楼盘数据
  loadProperties(){this.properties=[{id:1,title:"维罗纳花园",location:"大丰区维罗纳步行街",type:"new",price:"8800",priceUnit:"/㎡起",image:"assets/images/property-1.jpg",features:{rooms:"2-4室",area:"89-128㎡",floor:"18层"},badge:"热销",description:"位于维罗纳步行街核心地段，交通便利，配套完善"},{id:2,title:"建发珺和府",location:"大丰区新城区",type:"new",price:"9200",priceUnit:"/㎡起",image:"assets/images/property-2.jpg",features:{rooms:"3-4室",area:"108-138㎡",floor:"26层"},badge:"新盘",description:"大丰唯一建发品牌项目，品质住宅典范"},{id:3,title:"月湖花城",location:"大丰区南环路",type:"second-hand",price:"7500",priceUnit:"/㎡",image:"assets/images/property-3.jpg",features:{rooms:"3室2厅",area:"125㎡",floor:"11/18层"},badge:"精装",description:"成熟社区，精装修，拎包入住"},{id:4,title:"杰仕豪庭",location:"大丰区人民路",type:"second-hand",price:"8200",priceUnit:"/㎡",image:"assets/images/property-4.jpg",features:{rooms:"4室2厅",area:"142㎡",floor:"8/15层"},badge:"优质",description:"黄金地段，成熟配套，投资自住两相宜"},{id:5,title:"馥桂名居",location:"大丰区西环路",type:"rental",price:"2800",priceUnit:"/月",image:"assets/images/property-5.jpg",features:{rooms:"2室1厅",area:"85㎡",floor:"6/12层"},badge:"出租",description:"精装修，家电齐全，随时看房"},{id:6,title:"荣沁苑",location:"大丰区东环路",type:"rental",price:"1800",priceUnit:"/月",image:"assets/images/property-6.jpg",features:{rooms:"1室1厅",area:"55㎡",floor:"3/6层"},badge:"出租",description:"单身公寓，配套完善，交通便利"}];this.filteredProperties=[...this.properties];this.renderProperties()}
  
  // 设置滚动效果
  setupScrollEffects(){const fadeElements=document.querySelectorAll('.fade-in-up, .fade-in-left, .fade-in-right');if(fadeElements.length===0)return;const fadeInObserver=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){entry.target.classList.add('visible');fadeInObserver.unobserve(entry.target)}})},{threshold:0.1,rootMargin:'0px 0px -50px 0px'});fadeElements.forEach(el=>{fadeInObserver.observe(el)})}
  
  // 设置回到顶部按钮
  setupBackToTop(){const backToTopBtn=document.getElementById('backToTop');if(!backToTopBtn)return;window.addEventListener('scroll',()=>{if(window.pageYOffset>300){backToTopBtn.classList.add('show')}else{backToTopBtn.classList.remove('show')}},{passive:true});backToTopBtn.addEventListener('click',()=>{window.scrollTo({top:0,behavior:'smooth'})})}
  
  // 初始化联系表单
  initContactForm(){const contactForm=document.getElementById('contactForm');if(!contactForm)return;contactForm.addEventListener('submit',(e)=>{e.preventDefault();const formData=new FormData(contactForm);const formObject={};formData.forEach((value,key)=>{formObject[key]=value});console.log('表单提交:',formObject);const submitBtn=contactForm.querySelector('button[type="submit"]');const originalText=submitBtn.innerHTML;submitBtn.disabled=true;submitBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 提交中...';setTimeout(()=>{submitBtn.innerHTML='<i class="fas fa-check"></i> 提交成功';const successMessage=document.createElement('div');successMessage.className='alert alert-success mt-3';successMessage.innerHTML='<i class="fas fa-check-circle"></i> 您的信息已提交成功，我们将尽快与您联系！';contactForm.appendChild(successMessage);setTimeout(()=>{submitBtn.disabled=false;submitBtn.innerHTML=originalText;contactForm.reset();successMessage.remove()},3000)},1500)})}
  
  // 设置平滑滚动
  setupSmoothScroll(){const navLinks=document.querySelectorAll('a[href^="#"]:not([href="#"])');navLinks.forEach(link=>{link.addEventListener('click',(e)=>{e.preventDefault();const targetId=link.getAttribute('href');const targetElement=document.querySelector(targetId);if(targetElement){targetElement.scrollIntoView({behavior:'smooth',block:'start'});const navbarCollapse=document.querySelector('.navbar-collapse.show');if(navbarCollapse){navbarCollapse.classList.remove('show')}}})})}
  
  // 处理导航栏滚动
  handleNavbarScroll(){const navbar=document.querySelector('.navbar');if(!navbar)return;if(window.scrollY>50){navbar.classList.add('navbar-scrolled')}else{navbar.classList.remove('navbar-scrolled')}}
  
  // 跟踪电话点击
  trackPhoneCall(){console.log('电话咨询点击');if(typeof gtag!=='undefined'){gtag('event','phone_call',{event_category:'contact',event_label:'phone_click'})}}
  
  // 事件监听器设置
  setupEventListeners(){const filterButtons=document.querySelectorAll('.filter-btn');filterButtons.forEach(btn=>{btn.addEventListener('click',(e)=>{this.handleFilter(e.target.dataset.filter)})});const throttledNavbarScroll=throttle(()=>{this.handleNavbarScroll()},16);window.addEventListener('scroll',throttledNavbarScroll,{passive:true});const contactForm=document.getElementById('contactForm');if(contactForm){contactForm.addEventListener('submit',(e)=>{e.preventDefault();this.initContactForm()})};const phoneLinks=document.querySelectorAll('a[href^="tel:"]');phoneLinks.forEach(link=>{link.addEventListener('click',()=>{this.trackPhoneCall()})});const navbarToggler=document.querySelector('.navbar-toggler');const navbarCollapse=document.querySelector('.navbar-collapse');if(navbarToggler&&navbarCollapse){navbarToggler.addEventListener('click',()=>{navbarCollapse.classList.toggle('show')});const navLinks=document.querySelectorAll('.navbar-nav .nav-link');navLinks.forEach(link=>{link.addEventListener('click',()=>{navbarCollapse.classList.remove('show')})})}}  
  
  // 楼盘筛选
  handleFilter(filter){this.currentFilter=filter;document.querySelectorAll('.filter-btn').forEach(btn=>{btn.classList.remove('active')});document.querySelector(`[data-filter="${filter}"]`).classList.add('active');if(filter==='all'){this.filteredProperties=[...this.properties]}else{this.filteredProperties=this.properties.filter(property=>property.type===filter)};this.renderProperties()}
  
  // 渲染楼盘列表
  renderProperties(){const container=document.getElementById('propertiesGrid');if(!container)return;const fragment=document.createDocumentFragment();if(this.filteredProperties.length===0){const noResults=document.createElement('div');noResults.className='col-12 text-center';noResults.innerHTML=`<div class="no-results"><i class="fas fa-search fa-3x text-muted mb-3"></i><h4>暂无相关楼盘</h4><p class="text-muted">请尝试其他筛选条件或联系我们获取更多信息</p><a href="#contact" class="btn btn-primary">联系我们</a></div>`;fragment.appendChild(noResults)}else{this.filteredProperties.forEach((property,index)=>{const propertyCard=this.createPropertyCard(property);propertyCard.style.animationDelay=`${index*0.1}s`;fragment.appendChild(propertyCard)})};container.innerHTML='';container.appendChild(fragment)}
  
  // 创建楼盘卡片
  createPropertyCard(property){const col=document.createElement('div');col.className='col-lg-4 col-md-6 mb-4 fade-in-up';const typeNames={'new':'新房','second-hand':'二手房','rental':'租赁'};col.innerHTML=`<div class="property-card"><div class="property-image"><img src="${property.image}" alt="${property.title}" loading="lazy" onerror="this.src='assets/images/placeholder.jpg'"><div class="property-badge">${property.badge}</div></div><div class="property-content"><h4 class="property-title">${property.title}</h4><div class="property-location"><i class="fas fa-map-marker-alt"></i>${property.location}</div><div class="property-features"><span><i class="fas fa-bed"></i> ${property.features.rooms}</span><span><i class="fas fa-expand-arrows-alt"></i> ${property.features.area}</span><span><i class="fas fa-building"></i> ${property.features.floor}</span></div><div class="property-price">¥${property.price}<small>${property.priceUnit}</small></div><p class="property-description">${property.description}</p><div class="property-actions"><button class="btn btn-outline-primary btn-sm me-2" onclick="yijiaApp.viewProperty(${property.id})"><i class="fas fa-eye me-1"></i>查看详情</button><button class="btn btn-primary btn-sm" onclick="yijiaApp.contactAboutProperty(${property.id})"><i class="fas fa-phone me-1"></i>立即咨询</button></div></div></div>`;return col}
  
  // 查看楼盘详情
  viewProperty(id){const property=this.properties.find(p=>p.id===id);if(property){this.showPropertyModal(property)}}
  
  // 显示楼盘详情模态框
  showPropertyModal(property){const modal=document.createElement('div');modal.className='modal fade show';modal.style.display='block';modal.style.backgroundColor='rgba(0,0,0,0.5)';modal.innerHTML=`<div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">${property.title}</h5><button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button></div><div class="modal-body"><div class="row"><div class="col-md-6"><img src="${property.image}" alt="${property.title}" class="img-fluid rounded"></div><div class="col-md-6"><h6>楼盘信息</h6><ul class="list-unstyled"><li><strong>位置：</strong>${property.location}</li><li><strong>类型：</strong>${property.type==='new'?'新房':property.type==='second-hand'?'二手房':'租赁'}</li><li><strong>价格：</strong>¥${property.price}${property.priceUnit}</li><li><strong>户型：</strong>${property.features.rooms}</li><li><strong>面积：</strong>${property.features.area}</li><li><strong>楼层：</strong>${property.features.floor}</li></ul><p>${property.description}</p><button class="btn btn-primary" onclick="yijiaApp.contactAboutProperty(${property.id})"><i class="fas fa-phone me-1"></i>预约看房</button></div></div></div></div></div>`;document.body.appendChild(modal);document.body.style.overflow='hidden';modal.addEventListener('click',(e)=>{if(e.target===modal){document.body.removeChild(modal);document.body.style.overflow=''}})}
  
  // 联系咨询楼盘
  contactAboutProperty(id){const property=this.properties.find(p=>p.id===id);if(property){const contactForm=document.getElementById('contactForm');if(contactForm){const serviceSelect=contactForm.querySelector('#service');if(serviceSelect){serviceSelect.value=property.type==='new'?'新房购买':property.type==='second-hand'?'二手房交易':'房屋租赁'};const messageArea=contactForm.querySelector('#message');if(messageArea){messageArea.value=`我对${property.title}（${property.location}）很感兴趣，请联系我详细了解。`}};document.querySelector('#contact').scrollIntoView({behavior:'smooth'})}}
  
  // 初始化应用
  init(){this.loadProperties();this.setupEventListeners();this.setupScrollEffects();this.setupBackToTop();this.initContactForm();this.setupSmoothScroll()}
}

// 初始化应用
const yijiaApp = new YijiaRealEstate();
yijiaApp.init();