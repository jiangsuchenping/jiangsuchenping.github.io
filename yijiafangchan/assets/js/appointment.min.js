/**
 * 在线预约看房系统 - 优化版
 */
class AppointmentSystem{constructor(){this.currentStep=1;this.maxSteps=5;this.appointmentData={property:null,date:null,timeSlot:null,advisor:null,customer:{}};this.properties=[];this.advisors=[];this.timeSlots=["09:00","10:00","11:00","14:00","15:00","16:00","17:00"];this.init()}init(){this.loadData();this.setupDatePicker();this.renderProperties();this.renderTimeSlots();this.renderAdvisors();this.updateUI();console.log("[AppointmentSystem] 预约系统初始化完成")}loadData(){this.properties=[{id:1,name:"金桂花园",location:"大丰区新丰镇",price:"150万起",image:"assets/images/property1.jpg"},{id:2,name:"维罗纳花园",location:"大丰区维罗纳步行街",price:"8800元/㎡起",image:"assets/images/property-1.jpg"},{id:3,name:"建发珺和府",location:"大丰区新城区",price:"9200元/㎡起",image:"assets/images/property-2.jpg"},{id:4,name:"月湖花城",location:"大丰区南环路",price:"7500元/㎡",image:"assets/images/property-3.jpg"},{id:5,name:"杰仕豪庭",location:"大丰区人民路",price:"8200元/㎡",image:"assets/images/property-4.jpg"},{id:6,name:"馥桂名居",location:"大丰区西环路",price:"2200元/月",image:"assets/images/property-5.jpg"}];this.advisors=[{id:1,name:"张经理",title:"资深置业顾问",experience:"8年",image:"assets/images/advisor1.jpg",specialties:["新房","学区房"]},{id:2,name:"李顾问",title:"高级置业顾问",experience:"5年",image:"assets/images/advisor2.jpg",specialties:["二手房","投资房"]},{id:3,name:"王顾问",title:"置业顾问",experience:"3年",image:"assets/images/advisor3.jpg",specialties:["租赁","商铺"]},{id:4,name:"赵经理",title:"资深置业顾问",experience:"7年",image:"assets/images/advisor4.jpg",specialties:["别墅","豪宅"]}]}setupDatePicker(){const datePickerContainer=document.getElementById("date-picker-container");if(!datePickerContainer)return;const today=new Date();const calendar=document.createElement("div");calendar.className="calendar";const monthNames=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"];const weekDays=["日","一","二","三","四","五","六"];let currentMonth=today.getMonth();let currentYear=today.getFullYear();const renderCalendar=()=>{const firstDay=new Date(currentYear,currentMonth,1).getDay();const daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();const prevMonthDays=new Date(currentYear,currentMonth,0).getDate();calendar.innerHTML=`
                <div class="calendar-header">
                    <button class="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <h5>${currentYear}年 ${monthNames[currentMonth]}</h5>
                    <button class="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="weekdays">
                    ${weekDays.map(day=>`<div>${day}</div>`).join("")}
                </div>
                <div class="days"></div>
            `;const daysContainer=calendar.querySelector(".days");for(let i=firstDay;i>0;i--){const dayElement=document.createElement("div");dayElement.className="day prev-month-day";dayElement.textContent=prevMonthDays-i+1;daysContainer.appendChild(dayElement)}for(let i=1;i<=daysInMonth;i++){const dayElement=document.createElement("div");dayElement.className="day";dayElement.textContent=i;const date=new Date(currentYear,currentMonth,i);const isToday=date.toDateString()===today.toDateString();const isPast=date<today&&!isToday;if(isToday){dayElement.classList.add("today")}if(isPast){dayElement.classList.add("past");dayElement.classList.add("disabled")}else{dayElement.addEventListener("click",()=>{document.querySelectorAll(".day.selected").forEach(el=>el.classList.remove("selected"));dayElement.classList.add("selected");this.appointmentData.date=new Date(currentYear,currentMonth,i);this.updateUI()})}daysContainer.appendChild(dayElement)}const nextMonthDays=42-firstDay-daysInMonth;for(let i=1;i<=nextMonthDays;i++){const dayElement=document.createElement("div");dayElement.className="day next-month-day";dayElement.textContent=i;daysContainer.appendChild(dayElement)}calendar.querySelector(".prev-month").addEventListener("click",()=>{currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--}renderCalendar()});calendar.querySelector(".next-month").addEventListener("click",()=>{currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++}renderCalendar()})};renderCalendar();datePickerContainer.appendChild(calendar)}renderProperties(){const propertiesContainer=document.getElementById("properties-container");if(!propertiesContainer)return;propertiesContainer.innerHTML="";this.properties.forEach(property=>{const propertyCard=document.createElement("div");propertyCard.className="col-md-4 mb-4";propertyCard.innerHTML=`
                <div class="card property-card h-100">
                    <img src="${property.image}" class="card-img-top" alt="${property.name}">
                    <div class="card-body">
                        <h5 class="card-title">${property.name}</h5>
                        <p class="card-text"><i class="fas fa-map-marker-alt"></i> ${property.location}</p>
                        <p class="card-text"><i class="fas fa-tag"></i> ${property.price}</p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-outline-primary select-property" data-id="${property.id}">选择此房源</button>
                    </div>
                </div>
            `;propertiesContainer.appendChild(propertyCard)});document.querySelectorAll(".select-property").forEach(button=>{button.addEventListener("click",()=>{const propertyId=parseInt(button.getAttribute("data-id"));this.appointmentData.property=this.properties.find(p=>p.id===propertyId);document.querySelectorAll(".property-card").forEach(card=>{card.classList.remove("selected")});button.closest(".property-card").classList.add("selected");this.updateUI()})})}renderTimeSlots(){const timeSlotsContainer=document.getElementById("time-slots-container");if(!timeSlotsContainer)return;timeSlotsContainer.innerHTML="";const timeSlotRow=document.createElement("div");timeSlotRow.className="row";this.timeSlots.forEach(slot=>{const timeSlotCol=document.createElement("div");timeSlotCol.className="col-md-3 mb-3";timeSlotCol.innerHTML=`
                <div class="card time-slot-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">${slot}</h5>
                        <p class="card-text">可预约</p>
                        <button class="btn btn-outline-primary select-time-slot" data-slot="${slot}">选择此时段</button>
                    </div>
                </div>
            `;timeSlotRow.appendChild(timeSlotCol)});timeSlotsContainer.appendChild(timeSlotRow);document.querySelectorAll(".select-time-slot").forEach(button=>{button.addEventListener("click",()=>{const timeSlot=button.getAttribute("data-slot");this.appointmentData.timeSlot=timeSlot;document.querySelectorAll(".time-slot-card").forEach(card=>{card.classList.remove("selected")});button.closest(".time-slot-card").classList.add("selected");this.updateUI()})})}renderAdvisors(){const advisorsContainer=document.getElementById("advisors-container");if(!advisorsContainer)return;advisorsContainer.innerHTML="";this.advisors.forEach(advisor=>{const advisorCard=document.createElement("div");advisorCard.className="col-md-3 mb-4";advisorCard.innerHTML=`
                <div class="card advisor-card h-100">
                    <img src="${advisor.image}" class="card-img-top" alt="${advisor.name}">
                    <div class="card-body">
                        <h5 class="card-title">${advisor.name}</h5>
                        <p class="card-text">${advisor.title}</p>
                        <p class="card-text"><small class="text-muted">从业经验: ${advisor.experience}</small></p>
                        <div class="advisor-specialties">
                            ${advisor.specialties.map(specialty=>`<span class="badge bg-light text-dark me-1">${specialty}</span>`).join("")}
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-outline-primary select-advisor" data-id="${advisor.id}">选择此顾问</button>
                    </div>
                </div>
            `;advisorsContainer.appendChild(advisorCard)});document.querySelectorAll(".select-advisor").forEach(button=>{button.addEventListener("click",()=>{const advisorId=parseInt(button.getAttribute("data-id"));this.appointmentData.advisor=this.advisors.find(a=>a.id===advisorId);document.querySelectorAll(".advisor-card").forEach(card=>{card.classList.remove("selected")});button.closest(".advisor-card").classList.add("selected");this.updateUI()})})}updateUI(){this.updateStepIndicator();this.updateStepContent();this.updateNavButtons()}updateStepIndicator(){document.querySelectorAll(".step-indicator .step").forEach((step,index)=>{const stepNumber=index+1;if(stepNumber<this.currentStep){step.classList.add("completed");step.classList.remove("active")}else if(stepNumber===this.currentStep){step.classList.add("active");step.classList.remove("completed")}else{step.classList.remove("active","completed")}})}updateStepContent(){document.querySelectorAll(".step-content").forEach((content,index)=>{const stepNumber=index+1;if(stepNumber===this.currentStep){content.classList.add("active")}else{content.classList.remove("active")}})}updateNavButtons(){const prevButton=document.getElementById("prev-step");const nextButton=document.getElementById("next-step");if(this.currentStep===1){prevButton.disabled=true}else{prevButton.disabled=false}if(this.currentStep===this.maxSteps){nextButton.textContent="提交预约";nextButton.classList.add("btn-success");nextButton.classList.remove("btn-primary")}else{nextButton.textContent="下一步";nextButton.classList.add("btn-primary");nextButton.classList.remove("btn-success")}nextButton.disabled=!this.canProceedToNextStep()}canProceedToNextStep(){switch(this.currentStep){case 1:return this.appointmentData.property!==null;case 2:return this.appointmentData.date!==null;case 3:return this.appointmentData.timeSlot!==null;case 4:return this.appointmentData.advisor!==null;case 5:const customer=this.appointmentData.customer;return customer.name&&customer.phone&&customer.email;default:return false}}nextStep(){if(!this.canProceedToNextStep()){this.showValidationError();return}if(this.currentStep===this.maxSteps){this.submitAppointment();return}this.currentStep++;this.updateUI()}prevStep(){if(this.currentStep>1){this.currentStep--;this.updateUI()}}showValidationError(){let errorMessage="";switch(this.currentStep){case 1:errorMessage="请选择一个房源";break;case 2:errorMessage="请选择看房日期";break;case 3:errorMessage="请选择看房时间段";break;case 4:errorMessage="请选择置业顾问";break;case 5:errorMessage="请填写完整的个人信息";break}const alertContainer=document.getElementById("alert-container");alertContainer.innerHTML=`
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${errorMessage}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `}submitAppointment(){const form=document.getElementById("customer-info-form");if(!form)return;const formData=new FormData(form);this.appointmentData.customer={name:formData.get("name"),phone:formData.get("phone"),email:formData.get("email"),message:formData.get("message")};console.log("提交预约信息:",this.appointmentData);const appointmentSummary=document.getElementById("appointment-summary");if(appointmentSummary){appointmentSummary.innerHTML=`
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">预约成功</h5>
                    </div>
                    <div class="card-body">
                        <h5>预约详情</h5>
                        <p><strong>房源:</strong> ${this.appointmentData.property.name}</p>
                        <p><strong>日期:</strong> ${this.appointmentData.date.toLocaleDateString()}</p>
                        <p><strong>时间:</strong> ${this.appointmentData.timeSlot}</p>
                        <p><strong>置业顾问:</strong> ${this.appointmentData.advisor.name}</p>
                        <p><strong>联系人:</strong> ${this.appointmentData.customer.name}</p>
                        <p><strong>联系电话:</strong> ${this.appointmentData.customer.phone}</p>
                        <p><strong>电子邮箱:</strong> ${this.appointmentData.customer.email}</p>
                        ${this.appointmentData.customer.message?`<p><strong>留言:</strong> ${this.appointmentData.customer.message}</p>`:""}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i> 我们的置业顾问将在24小时内与您联系确认预约详情。
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <a href="index.html" class="btn btn-primary">返回首页</a>
                    <button class="btn btn-outline-primary" id="new-appointment">新的预约</button>
                </div>
            `}document.getElementById("appointment-form-container").style.display="none";document.getElementById("appointment-success-container").style.display="block";document.getElementById("new-appointment").addEventListener("click",()=>{this.resetForm()})}}resetForm(){this.currentStep=1;this.appointmentData={property:null,date:null,timeSlot:null,advisor:null,customer:{}};document.getElementById("appointment-form-container").style.display="block";document.getElementById("appointment-success-container").style.display="none";document.querySelectorAll(".property-card, .time-slot-card, .advisor-card").forEach(card=>{card.classList.remove("selected")});document.querySelectorAll(".day.selected").forEach(day=>{day.classList.remove("selected")});document.getElementById("customer-info-form").reset();this.updateUI()}}document.addEventListener("DOMContentLoaded",function(){const appointmentSystem=new AppointmentSystem;document.getElementById("next-step").addEventListener("click",()=>{appointmentSystem.nextStep()});document.getElementById("prev-step").addEventListener("click",()=>{appointmentSystem.prevStep()})})