<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL转Java类 - 在线工具箱</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .tool-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .button-group {
            margin-bottom: 20px;
        }
        
        .button-group button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-right: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .button-group button:hover {
            background-color: #2980b9;
        }
        
        .result-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            min-height: 100px;
        }
        
        .error {
            color: #e74c3c;
            background-color: #fdf2f2;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .options-group {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
        }
        
        .option-item input {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>SQL转Java类</h1>
            <p>在线将SQL表结构转换为Java实体类</p>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="../../index.html">首页</a></li>
                <li><a href="../sql-to-java/index.html">SQL转Java类</a></li>
            </ul>
        </div>
    </nav>

    <main class="tool-container">
        <div class="input-group">
            <label for="sql-input">输入SQL建表语句：</label>
            <textarea id="sql-input" placeholder="CREATE TABLE Users (\n    Id INT PRIMARY KEY,\n    Username VARCHAR(50) NOT NULL,\n    Email VARCHAR(100),\n    CreatedAt DATETIME\n);\n"></textarea>
        </div>

        <div class="options-group">
            <div class="option-item">
                <input type="checkbox" id="add-annotations" checked>
                <label for="add-annotations">添加JPA注解</label>
            </div>
            <div class="option-item">
                <input type="checkbox" id="add-lombok" checked>
                <label for="add-lombok">使用Lombok</label>
            </div>
            <div class="option-item">
                <input type="checkbox" id="camel-case" checked>
                <label for="camel-case">使用驼峰命名法</label>
            </div>
            <div class="option-item">
                <input type="checkbox" id="add-getters-setters" checked>
                <label for="add-getters-setters">生成Getter/Setter</label>
            </div>
        </div>

        <div class="button-group">
            <button onclick="convertToJava()">转换为Java类</button>
            <button onclick="clearAll()">清空</button>
        </div>

        <div id="result-container">
            <div class="input-group">
                <label for="sql-output">Java类定义：</label>
                <textarea id="sql-output" readonly></textarea>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 在线工具箱 - SQL转Java类工具</p>
        </div>
    </footer>

    <script src="../../js/main.js"></script>
    <script>
        // 工具ID，用于保存选项
        const TOOL_ID = 'sql-to-java';
        /**
         * 将SQL转换为Java类定义
         * 根据SQL表结构生成对应的Java实体类
         */
        function convertToJava() {
            const input = document.getElementById('sql-input').value;
            const output = document.getElementById('sql-output');
            const addAnnotations = document.getElementById('add-annotations').checked;
            const addLombok = document.getElementById('add-lombok').checked;
            const camelCase = document.getElementById('camel-case').checked;
            const addGettersSetters = document.getElementById('add-getters-setters').checked;
            
            if (!input.trim()) {
                output.value = '请输入SQL建表语句';
                return;
            }
            
            try {
                // 解析SQL语句
                const tableInfo = parseSqlCreateTable(input);
                if (!tableInfo) {
                    output.value = '无法解析SQL语句，请确保输入了正确的CREATE TABLE语句';
                    return;
                }
                
                // 生成Java类
                const result = generateJavaClass(tableInfo, {
                    addAnnotations,
                    addLombok,
                    camelCase,
                    addGettersSetters
                });
                
                output.value = result;
                
                // 保存选项设置
                saveOption(TOOL_ID, 'add-annotations', addAnnotations);
                saveOption(TOOL_ID, 'add-lombok', addLombok);
                saveOption(TOOL_ID, 'camel-case', camelCase);
                saveOption(TOOL_ID, 'add-getters-setters', addGettersSetters);
                
                // 记录使用频次
                if (typeof recordToolUsage === 'function') {
                    recordToolUsage('tools/sql-to-java/index.html');
                }
            } catch (error) {
                output.value = 'SQL解析错误或转换失败: ' + error.message;
            }
        }

        /**
         * 清空输入和输出
         */
        function clearAll() {
            document.getElementById('sql-input').value = '';
            document.getElementById('sql-output').value = '';
            // 记录工具使用频次
            if (typeof recordToolUsage === 'function') {
                recordToolUsage('tools/sql-to-java/index.html');
            }
        }

        /**
         * 解析SQL CREATE TABLE语句
         * @param {string} sql - SQL CREATE TABLE语句
         * @returns {object} - 包含表名和列信息的对象
         */
        function parseSqlCreateTable(sql) {
            const tableNameMatch = /CREATE TABLE\s+(`?)([^`\s]+)\1\s*\(/i.exec(sql);
            if (!tableNameMatch) {
                return null;
            }
            const tableName = tableNameMatch[2];

            const columns = [];
            // 匹配列定义，考虑了各种数据类型、约束和默认值
            const columnRegex = /\s*(`?)([^`\s]+)\1\s+([a-zA-Z0-9_]+(?:\([^)]+\))?)(?:\s+NOT NULL)?(?:\s+PRIMARY KEY)?(?:\s+DEFAULT\s+[^,\s]+)?(?:\s+AUTO_INCREMENT)?(?:\s+COMMENT\s+'[^']+')?(?:\s*,|$)/gi;
            let match;
            let remainingSql = sql.substring(sql.indexOf('(') + 1);
            remainingSql = remainingSql.substring(0, remainingSql.lastIndexOf(')'));

            while ((match = columnRegex.exec(remainingSql)) !== null) {
                if (match[2]) { // 确保匹配到列名
                    const columnName = match[2];
                    const columnType = match[3].toLowerCase();
                    const isNullable = !/NOT NULL/i.test(match[0]);
                    const isPrimaryKey = /PRIMARY KEY/i.test(match[0]);
                    columns.push({ name: columnName, type: columnType, isNullable, isPrimaryKey });
                }
            }
            return { tableName, columns };
        }

        /**
         * 将SQL数据类型映射到Java数据类型
         * @param {string} sqlType - SQL数据类型
         * @returns {string} - 对应的Java数据类型
         */
        function mapSqlTypeToJavaType(sqlType) {
            switch (sqlType) {
                case 'int':
                case 'integer':
                case 'tinyint':
                case 'smallint':
                case 'mediumint':
                    return 'Integer';
                case 'bigint':
                    return 'Long';
                case 'float':
                    return 'Float';
                case 'double':
                case 'decimal':
                case 'numeric':
                    return 'BigDecimal';
                case 'bit':
                case 'boolean':
                    return 'Boolean';
                case 'char':
                case 'varchar':
                case 'text':
                case 'nchar':
                case 'nvarchar':
                case 'ntext':
                case 'uniqueidentifier':
                    return 'String';
                case 'date':
                case 'datetime':
                case 'timestamp':
                case 'smalldatetime':
                    return 'java.util.Date'; // 或者 java.time.LocalDateTime/LocalDate
                case 'time':
                    return 'java.sql.Time'; // 或者 java.time.LocalTime
                case 'binary':
                case 'varbinary':
                case 'image':
                    return 'byte[]';
                case 'json':
                    return 'String'; // JSON通常作为字符串处理
                default:
                    return 'Object'; // 未知类型默认为Object
            }
        }

        /**
         * 将字符串转换为驼峰命名法
         * @param {string} str - 输入字符串
         * @returns {string} - 驼峰命名法字符串
         */
        function toCamelCase(str) {
            return str.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
        }

        /**
         * 将字符串转换为PascalCase
         * @param {string} str - 输入字符串
         * @returns {string} - PascalCase字符串
         */
        function toPascalCase(str) {
            return str.replace(/(?:^|_)([a-z])/g, (_, c) => c.toUpperCase());
        }

        /**
         * 生成Java类定义
         * @param {object} tableInfo - 表信息对象
         * @param {object} options - 选项
         * @param {boolean} options.addAnnotations - 是否添加JPA注解
         * @param {boolean} options.addLombok - 是否使用Lombok
         * @param {boolean} options.camelCase - 是否使用驼峰命名法
         * @param {boolean} options.addGettersSetters - 是否生成Getter/Setter
         * @returns {string} - Java类定义字符串
         */
        function generateJavaClass(tableInfo, options) {
            const className = options.camelCase ? toPascalCase(tableInfo.tableName) : tableInfo.tableName;
            let classDefinition = '';

            if (options.addLombok) {
                classDefinition += 'import lombok.Data;\n';
                classDefinition += 'import lombok.NoArgsConstructor;\n';
                classDefinition += 'import lombok.AllArgsConstructor;\n';
            }
            if (options.addAnnotations) {
                classDefinition += 'import javax.persistence.*;\n';
                classDefinition += 'import java.math.BigDecimal;\n';
                classDefinition += 'import java.util.Date;\n';
            }
            classDefinition += '\n';

            if (options.addLombok) {
                classDefinition += '@Data\n';
                classDefinition += '@NoArgsConstructor\n';
                classDefinition += '@AllArgsConstructor\n';
            }
            if (options.addAnnotations) {
                classDefinition += `@Entity\n`;
                classDefinition += `@Table(name = "${tableInfo.tableName}")\n`;
            }
            classDefinition += `public class ${className} {\n\n`;

            tableInfo.columns.forEach(col => {
                let javaType = mapSqlTypeToJavaType(col.type);
                let memberName = options.camelCase ? toCamelCase(col.name) : col.name;

                if (options.addAnnotations) {
                    if (col.isPrimaryKey) {
                        classDefinition += `    @Id\n`;
                        classDefinition += `    @GeneratedValue(strategy = GenerationType.IDENTITY)\n`;
                    }
                    classDefinition += `    @Column(name = "${col.name}"`;
                    if (!col.isNullable) {
                        classDefinition += `, nullable = false`;
                    }
                    classDefinition += `)\n`;
                }
                classDefinition += `    private ${javaType} ${memberName};\n\n`;
            });

            if (!options.addLombok && options.addGettersSetters) {
                tableInfo.columns.forEach(col => {
                    let javaType = mapSqlTypeToJavaType(col.type);
                    let memberName = options.camelCase ? toCamelCase(col.name) : col.name;
                    let pascalMemberName = toPascalCase(memberName);

                    // Getter
                    classDefinition += `    public ${javaType} get${pascalMemberName}() {\n`;
                    classDefinition += `        return ${memberName};\n`;
                    classDefinition += `    }\n\n`;

                    // Setter
                    classDefinition += `    public void set${pascalMemberName}(${javaType} ${memberName}) {\n`;
                    classDefinition += `        this.${memberName} = ${memberName};\n`;
                    classDefinition += `    }\n\n`;
                });
            }

            classDefinition += `}\n`;
            return classDefinition;
        }

        // 页面加载时恢复选项设置
        document.addEventListener('DOMContentLoaded', function() {
            loadOption(TOOL_ID, 'add-annotations', true);
            loadOption(TOOL_ID, 'add-lombok', true);
            loadOption(TOOL_ID, 'camel-case', true);
            loadOption(TOOL_ID, 'add-getters-setters', true);
            console.log('SQL转Java类工具已加载');
        });
    </script>
</body>
</html>