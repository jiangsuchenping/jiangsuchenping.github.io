<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>索引命名工具 - 在线工具箱</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .tool-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .button-group {
            margin-bottom: 20px;
        }
        
        .button-group button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-right: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .button-group button:hover {
            background-color: #2980b9;
        }
        
        .result-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            min-height: 100px;
        }
        
        .error {
            color: #e74c3c;
            background-color: #fdf2f2;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .options-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .options-group label {
            margin-right: 15px;
            display: inline-block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>索引命名工具</h1>
            <p>根据创建索引的SQL代码自动生成规范的索引名称</p>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="../../index.html">首页</a></li>
                <li><a href="#generate">生成</a></li>
            </ul>
        </div>
    </nav>

    <main class="tool-container">
        <div class="input-group">
            <label for="sql-input">输入创建索引的SQL代码：</label>
            <textarea id="sql-input" placeholder="CREATE INDEX ON table_name (column1, column2);"></textarea>
        </div>
        
        <div class="options-group">
            <h3>命名选项</h3>
            <label>
                <input type="radio" name="naming-convention" value="idx_table_columns" checked>
                idx_表名_列名 (idx_user_name_email)
            </label>
            <label>
                <input type="radio" name="naming-convention" value="ix_table_columns">
                ix_表名_列名 (ix_user_name_email)
            </label>
            <label>
                <input type="radio" name="naming-convention" value="table_columns_idx">
                表名_列名_idx (user_name_email_idx)
            </label>
            <label>
                <input type="checkbox" id="include-index-type">
                包含索引类型 (idx_user_name_email_u 表示唯一索引)
            </label>
        </div>

        <div class="button-group">
            <button onclick="generateIndexName()">生成索引名称</button>
            <button onclick="clearAll()">清空</button>
        </div>

        <div id="result-container" class="result-container">
            <div id="result-output"></div>
        </div>
        
        <div class="info">
            <h3>说明</h3>
            <ul>
                <li>支持解析标准的CREATE INDEX语句</li>
                <li>支持解析CREATE UNIQUE INDEX语句</li>
                <li>支持多种索引命名规范</li>
                <li>自动处理列名过长的情况</li>
                <li>可以批量处理多条SQL语句（每行一条）</li>
            </ul>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 在线工具箱 - 索引命名工具</p>
        </div>
    </footer>

    <script>
        /**
         * 生成索引名称
         * 根据输入的SQL代码和选择的命名规范生成索引名称
         */
        function generateIndexName() {
            const sqlInput = document.getElementById('sql-input').value;
            const resultOutput = document.getElementById('result-output');
            
            if (!sqlInput.trim()) {
                resultOutput.innerHTML = '<div class="error">请输入创建索引的SQL代码</div>';
                return;
            }
            
            try {
                // 获取命名规范选项
                const namingConvention = document.querySelector('input[name="naming-convention"]:checked').value;
                const includeIndexType = document.getElementById('include-index-type').checked;
                
                // 按行分割SQL语句
                const sqlStatements = sqlInput.split(/\r?\n/).filter(line => line.trim());
                let results = [];
                
                for (const sql of sqlStatements) {
                    const result = processSqlStatement(sql, namingConvention, includeIndexType);
                    if (result) {
                        results.push(result);
                    }
                }
                
                if (results.length === 0) {
                    resultOutput.innerHTML = '<div class="error">未能识别有效的创建索引语句</div>';
                    return;
                }
                
                // 显示结果
                let resultHtml = '<h3>生成的索引名称：</h3><ul>';
                for (const result of results) {
                    resultHtml += `<li><strong>${result.indexName}</strong> - <code>${result.originalSql}</code></li>`;
                }
                resultHtml += '</ul>';
                
                // 生成可复制的SQL
                resultHtml += '<h3>修改后的SQL：</h3><pre>';
                for (const result of results) {
                    resultHtml += result.newSql + '\n';
                }
                resultHtml += '</pre>';
                
                resultOutput.innerHTML = resultHtml;
            } catch (error) {
                resultOutput.innerHTML = `<div class="error">处理错误: ${error.message}</div>`;
                console.error('索引命名错误:', error);
            }
        }
        
        /**
         * 处理单条SQL语句
         * @param {string} sql - SQL语句
         * @param {string} namingConvention - 命名规范
         * @param {boolean} includeIndexType - 是否包含索引类型
         * @returns {Object|null} 处理结果，包含索引名称和新SQL
         */
        function processSqlStatement(sql, namingConvention, includeIndexType) {
            // 匹配CREATE INDEX或CREATE UNIQUE INDEX语句
            const indexRegex = /CREATE\s+(UNIQUE\s+)?INDEX\s+(?:([\w_]+)\s+)?ON\s+([\w_\.]+)\s*\(([^)]+)\)/i;
            const match = sql.match(indexRegex);
            
            if (!match) {
                return null;
            }
            
            const isUnique = !!match[1];
            const existingName = match[2] || '';
            let tableName = match[3];
            const columns = match[4];
            
            // 处理表名（移除schema前缀）
            if (tableName.includes('.')) {
                tableName = tableName.split('.').pop();
            }
            
            // 处理列名
            const columnNames = columns.split(',').map(col => {
                // 提取列名，移除ASC/DESC和其他修饰符
                const colName = col.trim().split(/\s+/)[0];
                // 移除引号
                return colName.replace(/["'\[\]`]/g, '');
            });
            
            // 生成索引名称
            let indexName = '';
            const typeIndicator = isUnique && includeIndexType ? '_u' : '';
            
            switch (namingConvention) {
                case 'idx_table_columns':
                    indexName = 'idx_' + tableName + '_' + columnNames.join('_') + typeIndicator;
                    break;
                case 'ix_table_columns':
                    indexName = 'ix_' + tableName + '_' + columnNames.join('_') + typeIndicator;
                    break;
                case 'table_columns_idx':
                    indexName = tableName + '_' + columnNames.join('_') + '_idx' + typeIndicator;
                    break;
            }
            
            // 处理名称过长的情况（数据库通常限制标识符长度）
            if (indexName.length > 63) { // PostgreSQL的限制是63字符
                // 截断列名部分
                const parts = indexName.split('_');
                const prefix = parts.slice(0, 2).join('_'); // 保留前缀（idx_table或table）
                const suffix = parts.slice(-1)[0].includes('idx') ? parts.slice(-1)[0] : ''; // 保留后缀（如果有idx）
                
                // 对列名进行缩写处理
                const columnsSection = parts.slice(2, suffix ? -1 : undefined).join('_');
                const shortenedColumns = shortenColumnsName(columnsSection, 63 - prefix.length - (suffix ? suffix.length + 1 : 0) - 1);
                
                indexName = prefix + '_' + shortenedColumns + (suffix ? '_' + suffix : '');
            }
            
            // 生成新的SQL语句
            let newSql = sql;
            if (existingName) {
                // 替换现有的索引名
                newSql = sql.replace(new RegExp(`CREATE\\s+(UNIQUE\\s+)?INDEX\\s+${existingName}`, 'i'), `CREATE $1INDEX ${indexName}`);
            } else {
                // 插入新的索引名
                newSql = sql.replace(new RegExp('CREATE\\s+(UNIQUE\\s+)?INDEX', 'i'), `CREATE $1INDEX ${indexName}`);
            }
            
            return {
                indexName,
                originalSql: sql,
                newSql
            };
        }
        
        /**
         * 缩短列名部分以适应长度限制
         * @param {string} columnsStr - 列名字符串
         * @param {number} maxLength - 最大长度
         * @returns {string} 缩短后的列名
         */
        function shortenColumnsName(columnsStr, maxLength) {
            if (columnsStr.length <= maxLength) {
                return columnsStr;
            }
            
            // 将列名拆分为数组
            const columns = columnsStr.split('_');
            
            // 如果只有一个列名但仍然太长
            if (columns.length === 1) {
                return columnsStr.substring(0, maxLength);
            }
            
            // 计算每个列名可以保留的平均长度
            const avgLength = Math.floor(maxLength / columns.length);
            if (avgLength < 1) {
                // 如果平均长度小于1，只保留每个列的第一个字符
                return columns.map(col => col.charAt(0)).join('');
            }
            
            // 缩短每个列名
            return columns.map(col => {
                if (col.length <= avgLength) {
                    return col;
                }
                return col.substring(0, avgLength);
            }).join('_');
        }
        
        /**
         * 清空所有输入和输出
         */
        function clearAll() {
            document.getElementById('sql-input').value = '';
            document.getElementById('result-output').innerHTML = '';
        }
    </script>
</body>
</html>