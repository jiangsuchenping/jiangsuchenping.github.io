<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>索引命名工具 - 在线工具箱</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        .tool-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .button-group {
            margin-bottom: 20px;
        }
        
        .button-group button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-right: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .button-group button:hover {
            background-color: #2980b9;
        }
        
        .result-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            min-height: 100px;
        }
        
        .error {
            color: #e74c3c;
            background-color: #fdf2f2;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .options-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .options-group label {
            margin-right: 15px;
            display: inline-block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>索引命名工具</h1>
            <p>根据创建索引的SQL代码自动生成规范的索引名称</p>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="../../index.html">首页</a></li>
                <li><a href="#generate">生成</a></li>
            </ul>
        </div>
    </nav>

    <main class="tool-container">
        <div class="input-group">
            <label for="sql-input">输入创建索引的SQL代码：</label>
            <textarea id="sql-input" placeholder="CREATE INDEX ON table_name (column1, column2);"></textarea>
        </div>
        
        <div class="options-group">
            <h3>命名选项</h3>
            <label>
                <input type="radio" name="naming-convention" value="idx_table_columns" checked>
                idx_表名_列名 (idx_user_name_email)
            </label>
            <label>
                <input type="radio" name="naming-convention" value="ix_table_columns">
                ix_表名_列名 (ix_user_name_email)
            </label>
            <label>
                <input type="radio" name="naming-convention" value="table_columns_idx">
                表名_列名_idx (user_name_email_idx)
            </label>
            <label>
                <input type="checkbox" id="include-index-type">
                包含索引类型 (idx_user_name_email_u 表示唯一索引)
            </label>
        </div>

        <div class="button-group">
            <button onclick="generateIndexName()">生成索引名称</button>
            <button onclick="clearAll()">清空</button>
        </div>

        <div id="result-container" class="result-container">
            <div id="result-output"></div>
        </div>
        
        <div class="info">
            <h3>说明</h3>
            <ul>
                <li>支持解析标准的CREATE INDEX语句</li>
                <li>支持解析CREATE UNIQUE INDEX语句</li>
                <li>支持多种索引命名规范</li>
                <li>自动处理列名过长的情况</li>
                <li>可以批量处理多条SQL语句（每行一条）</li>
            </ul>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 在线工具箱 - 索引命名工具</p>
        </div>
    </footer>

    <script>
        /**
         * 生成索引名称
         * 根据输入的SQL代码和选择的命名规范生成索引名称
         */
        function recordToolUsage(toolName) {
            // 检查浏览器是否支持 navigator.sendBeacon 或 XMLHttpRequest
            if (navigator.sendBeacon) {
                // 使用 sendBeacon 异步发送数据，不影响页面卸载
                navigator.sendBeacon('https://jiangsuchenping.github.io/recordToolUsage.html?tool=' + toolName);
            } else {
                // 降级方案：使用 XMLHttpRequest
                var xhr = new XMLHttpRequest();
                xhr.open('GET', 'https://jiangsuchenping.github.io/recordToolUsage.html?tool=' + toolName, true);
                xhr.send();
            }
        }
        recordToolUsage('tools/index-namer/index.html');

        function generateIndexName() {
            const sqlInput = document.getElementById('sql-input').value;
            const resultOutput = document.getElementById('result-output');
            
            if (!sqlInput.trim()) {
                resultOutput.innerHTML = '<div class="error">请输入创建索引的SQL代码</div>';
                return;
            }
            
            try {
                // 获取命名规范选项
                // 记录工具使用频次
                if (typeof recordToolUsage === 'function') {
                    recordToolUsage('索引命名', 'tools/index-namer/index.html');
                }
                const namingConvention = document.querySelector('input[name="naming-convention"]:checked').value;
                const includeIndexType = document.getElementById('include-index-type').checked;
                
                // 按行分割SQL语句
                const sqlStatements = sqlInput.split(/\r?\n/).filter(line => line.trim());
                let results = [];
                
                for (const sql of sqlStatements) {
                    const result = processSqlStatement(sql, namingConvention, includeIndexType);
                    if (result) {
                        results.push(result);
                    }
                }
                
                if (results.length === 0) {
                    resultOutput.innerHTML = '<div class="error">未能识别有效的创建索引语句</div>';
                    return;
                }
                
                // 显示结果
                let resultHtml = '<h3>生成的索引名称：</h3><ul>';
                for (const result of results) {
                    resultHtml += `<li><strong>${result.indexName}</strong> - <code>${result.originalSql}</code></li>`;
                }
                resultHtml += '</ul>';
                
                resultOutput.innerHTML = resultHtml;

            } catch (error) {
                resultOutput.innerHTML = `<div class="error">处理错误: ${error.message}</div>`;
            }
        }

        /**
         * 处理单条SQL语句，生成索引名称
         * @param {string} sql - SQL语句
         * @param {string} namingConvention - 命名规范
         * @param {boolean} includeIndexType - 是否包含索引类型
         * @returns {object|null} - 包含索引名称和原始SQL的对象，如果无法解析则返回null
         */
        function processSqlStatement(sql, namingConvention, includeIndexType) {
            const createIndexRegex = /CREATE\s+(UNIQUE\s+)?INDEX(?:\s+([a-zA-Z0-9_]+))?\s+ON\s+([a-zA-Z0-9_]+)\s*\(([^)]+)\)/i;
            const match = sql.match(createIndexRegex);

            if (!match) {
                return null; // 无法解析的SQL语句
            }

            const isUnique = match[1] !== undefined;
            const tableName = match[3];
            const columns = match[4].split(',').map(col => col.trim().replace(/['`"\[\]]/g, '')); // 移除列名中的引号和括号

            let indexName = '';
            const columnPart = columns.join('_').toLowerCase();

            switch (namingConvention) {
                case 'idx_table_columns':
                    indexName = `idx_${tableName.toLowerCase()}_${columnPart}`;
                    break;
                case 'ix_table_columns':
                    indexName = `ix_${tableName.toLowerCase()}_${columnPart}`;
                    break;
                case 'table_columns_idx':
                    indexName = `${tableName.toLowerCase()}_${columnPart}_idx`;
                    break;
                default:
                    indexName = `idx_${tableName.toLowerCase()}_${columnPart}`;
            }

            if (includeIndexType && isUnique) {
                indexName += '_u'; // 添加唯一索引标识
            }

            // 限制索引名称长度，避免过长
            const MAX_LENGTH = 64; // 常见数据库索引名称最大长度
            if (indexName.length > MAX_LENGTH) {
                // 简单截断，或者更复杂的哈希/缩写逻辑
                indexName = indexName.substring(0, MAX_LENGTH - 4) + '_etc'; 
            }

            return { indexName: indexName, originalSql: sql };
        }

        function clearAll() {
            document.getElementById('sql-input').value = '';
            document.getElementById('result-output').innerHTML = '';
            // 记录工具使用频次
            if (typeof recordToolUsage === 'function') {
                recordToolUsage('索引命名', 'tools/index-namer/index.html');
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('索引命名工具已加载');
        });
    </script>
</body>
</html>