<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒ - å¹¼å„¿æ•°å­¦ç»ƒä¹ å·¥å…·</title>
    <meta name="description" content="ä¸“ä¸ºå¹¼å„¿è®¾è®¡çš„30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒå·¥å…·ï¼Œå¸®åŠ©å­©å­è½»æ¾æŒæ¡åŸºç¡€æ•°å­¦è¿ç®—ã€‚">
    <meta name="keywords" content="å¹¼å„¿æ•°å­¦,åŠ å‡æ³•ç»ƒä¹ ,30ä»¥å†…åŠ å‡æ³•,æ•°å­¦è®­ç»ƒ,å„¿ç«¥æ•™è‚²">
    <meta name="author" content="jiangsuchenping">
    <meta property="og:title" content="30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒ - å¹¼å„¿æ•°å­¦ç»ƒä¹ å·¥å…·">
    <meta property="og:description" content="ä¸“ä¸ºå¹¼å„¿è®¾è®¡çš„30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒå·¥å…·ï¼Œå¸®åŠ©å­©å­è½»æ¾æŒæ¡åŸºç¡€æ•°å­¦è¿ç®—ã€‚">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jiangsuchenping.github.io/youeryuan/math-training.html">
    <meta property="og:image" content="https://jiangsuchenping.github.io/youeryuan/math-training-preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒ - å¹¼å„¿æ•°å­¦ç»ƒä¹ å·¥å…·">
    <meta name="twitter:description" content="ä¸“ä¸ºå¹¼å„¿è®¾è®¡çš„30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒå·¥å…·ï¼Œå¸®åŠ©å­©å­è½»æ¾æŒæ¡åŸºç¡€æ•°å­¦è¿ç®—ã€‚">
    <meta name="twitter:image" content="https://jiangsuchenping.github.io/youeryuan/math-training-preview.png">
    <!-- é¢„è¿æ¥å…³é”®CDNåŸŸå -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- å…³é”®CSSèµ„æºé¢„åŠ è½½ -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- å¤‡ç”¨CSSåŠ è½½ -->
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"></noscript>
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"></noscript>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 800px;
            padding: 30px;
        }
        
        .question-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(240, 147, 251, 0.3);
        }
        
        .answer-btn {
            font-size: 1.5rem;
            padding: 20px;
            margin: 10px;
            border-radius: 15px;
            border: none;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .answer-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .correct {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
            color: white;
        }
        
        .incorrect {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%) !important;
            color: white;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .daily-limit {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
        }
        
        .emoji-feedback {
            font-size: 3rem;
            margin: 20px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        /* è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿å¤ä¹ æé†’æ ·å¼ */
        #reviewAlert {
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* å¤ä¹ é¢˜ç›®æ ‡è®°æ ·å¼ */
        .badge.bg-warning {
            font-size: 0.8rem;
            padding: 0.3rem 0.5rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <h1 class="text-center mb-4">
                <i class="bi bi-calculator-fill text-primary"></i>
                30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒ
            </h1>
            
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card">
                        <h5><i class="bi bi-graph-up"></i> ä»Šæ—¥ç»Ÿè®¡</h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 id="todayTotal" class="text-primary">0</h3>
                                <small>æ€»é¢˜æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="todayCorrect" class="text-success">0</h3>
                                <small>æ­£ç¡®æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="todayAccuracy" class="text-warning">0%</h3>
                                <small>æ­£ç¡®ç‡</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card">
                        <h5><i class="bi bi-trophy"></i> æ€»ç»Ÿè®¡</h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 id="totalQuestions" class="text-primary">0</h3>
                                <small>æ€»é¢˜æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="totalCorrect" class="text-success">0</h3>
                                <small>æ­£ç¡®æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="totalAccuracy" class="text-warning">0%</h3>
                                <small>æ­£ç¡®ç‡</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ¯æ—¥é™åˆ¶æç¤º -->
            <div id="dailyLimitAlert" class="daily-limit hidden">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="limitText">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        ä»Šæ—¥è®­ç»ƒå·²è¾¾åˆ°ä¸Šé™ï¼ˆ20é¢˜ï¼‰ï¼Œæ˜å¤©å†æ¥ç»§ç»­å§ï¼
                    </div>
                    <div>
                        <button id="resetLimitBtn" class="btn btn-sm btn-warning">
                            <i class="bi bi-plus-circle"></i> å¢åŠ ä¸Šé™
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- è®­ç»ƒåŒºåŸŸ -->
             <div id="trainingArea" class="text-center">
                 <div class="question-card" id="questionCard">
                     <span id="question">å‡†å¤‡å¼€å§‹</span>
                 </div>
                 
                 <div id="answerOptions" class="row">
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionA">A</button>
                     </div>
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionB">B</button>
                     </div>
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionC">C</button>
                     </div>
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionD">D</button>
                     </div>
                 </div>
                 
                 <div id="feedback" class="emoji-feedback hidden"></div>
             </div>
            
            <!-- å†å²è®°å½• -->
            <div class="mt-5">
                <h4><i class="bi bi-clock-history"></i> ä»Šæ—¥ç­”é¢˜è®°å½•</h4>
                <div id="historyList" class="mt-3"></div>
            </div>
            
            <!-- æ‰€æœ‰å†å²è®°å½• -->
            <div class="mt-5">
                <h4><i class="bi bi-clock-history"></i> å†å²ç»Ÿè®¡</h4>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>ç´¯è®¡ç­”é¢˜</h5>
                            <h3 id="allTimeTotal" class="text-primary">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>æ­£ç¡®ç­”é¢˜</h5>
                            <h3 id="allTimeCorrect" class="text-success">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>æ­£ç¡®ç‡</h5>
                            <h3 id="allTimeAccuracy" class="text-warning">0%</h3>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="showAllHistoryBtn" class="btn btn-info">
                        <i class="bi bi-list"></i> æŸ¥çœ‹è¯¦ç»†å†å²è®°å½•
                    </button>
                    <div id="allHistoryContainer" class="mt-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>è¯¦ç»†å†å²è®°å½•</h5>
                            <button id="hideAllHistoryBtn" class="btn btn-sm btn-secondary">
                                <i class="bi bi-eye-slash"></i> éšè—
                            </button>
                        </div>
                        <div id="allHistoryList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼‚æ­¥åŠ è½½Bootstrap JSï¼Œå¸¦ç¼“å­˜å’Œé”™è¯¯å¤„ç† -->
    <script>
        /**
         * å¼‚æ­¥åŠ è½½Bootstrap Bundle JS
         * ä½¿ç”¨CDNå¤±è´¥æ—¶çš„æœ¬åœ°å›é€€æœºåˆ¶
         */
        (function() {
            const cdnUrl = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
            const fallbackUrl = '/assets/js/bootstrap.bundle.min.js';
            
            // åˆ›å»ºè„šæœ¬å…ƒç´ 
            const script = document.createElement('script');
            script.src = cdnUrl;
            script.async = true;
            script.crossOrigin = 'anonymous';
            
            // è®¾ç½®åŠ è½½è¶…æ—¶
            const timeout = setTimeout(() => {
                console.warn('Bootstrap JS CDNåŠ è½½è¶…æ—¶ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°å›é€€');
                loadFallback();
            }, 5000);
            
            // æˆåŠŸåŠ è½½
            script.onload = () => {
                clearTimeout(timeout);
                console.log('Bootstrap JS CDNåŠ è½½æˆåŠŸ');
            };
            
            // åŠ è½½å¤±è´¥
            script.onerror = () => {
                clearTimeout(timeout);
                console.warn('Bootstrap JS CDNåŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°å›é€€');
                loadFallback();
            };
            
            // åŠ è½½æœ¬åœ°å›é€€
            function loadFallback() {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = fallbackUrl;
                fallbackScript.async = true;
                document.head.appendChild(fallbackScript);
            }
            
            document.head.appendChild(script);
        })();
    </script>
    <script>
        /**
         * 30ä»¥å†…åŠ å‡æ³•æ™ºèƒ½è®­ç»ƒç³»ç»Ÿ
         * åŠŸèƒ½ï¼šæ™ºèƒ½å‡ºé¢˜ã€å†å²è®°å½•ã€æ¯æ—¥é™åˆ¶ã€è‡ªé€‚åº”éš¾åº¦
         */
        class MathTrainingSystem {
            constructor() {
                this.dailyLimit = 20; // æ¯æ—¥è®­ç»ƒä¸Šé™
                this.currentQuestion = null;
                this.answers = [];
                this.history = this.loadHistory();
                this.today = new Date().toISOString().split('T')[0];
                
                // ç¼“å­˜DOMå…ƒç´ ä»¥æé«˜æ€§èƒ½
                this.domCache = {
                    dailyLimitAlert: document.getElementById('dailyLimitAlert'),
                    trainingArea: document.getElementById('trainingArea'),
                    answerOptions: document.getElementById('answerOptions'),
                    nextBtn: document.getElementById('nextBtn'),
                    feedback: document.getElementById('feedback'),
                    historyList: document.getElementById('historyList'),
                    question: document.getElementById('question'),
                    optionA: document.getElementById('optionA'),
                    optionB: document.getElementById('optionB'),
                    optionC: document.getElementById('optionC'),
                    optionD: document.getElementById('optionD'),
                    todayTotal: document.getElementById('todayTotal'),
                    todayCorrect: document.getElementById('todayCorrect'),
                    todayAccuracy: document.getElementById('todayAccuracy'),
                    totalQuestions: document.getElementById('totalQuestions'),
                    totalCorrect: document.getElementById('totalCorrect'),
                    totalAccuracy: document.getElementById('totalAccuracy'),
                    resetBtn: document.getElementById('resetBtn')
                };
                
                // ç¼“å­˜æ‰€æœ‰å†å²è®°å½•ç›¸å…³DOMå…ƒç´ 
                this.domCache.allTimeTotal = document.getElementById('allTimeTotal');
                this.domCache.allTimeCorrect = document.getElementById('allTimeCorrect');
                this.domCache.allTimeAccuracy = document.getElementById('allTimeAccuracy');
                this.domCache.showAllHistoryBtn = document.getElementById('showAllHistoryBtn');
                this.domCache.hideAllHistoryBtn = document.getElementById('hideAllHistoryBtn');
                this.domCache.allHistoryContainer = document.getElementById('allHistoryContainer');
                this.domCache.allHistoryList = document.getElementById('allHistoryList');
                
                // ç¼“å­˜ä»Šæ—¥å†å²è®°å½•ä»¥é¿å…é‡å¤è¿‡æ»¤
                this.todayHistory = this.history.filter(h => h.date === this.today);
                
                // åŠ è½½è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
                this.ebbinghausData = this.loadEbbinghausData();
                
                // é˜²æŠ–å’ŒèŠ‚æµç¼“å­˜
                this.debounceTimer = null;
                this.throttleTimer = null;
                this.lastThrottleTime = 0;
                
                this.initializeEventListeners();
                this.updateStats();
                this.updateAllTimeStats();
                this.updateHistoryList(); // ç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå†å²è®°å½•
                
                // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®
                this.checkTodayReviews();
                
                // æ£€æŸ¥æ¯æ—¥è®­ç»ƒä¸Šé™å¹¶è‡ªåŠ¨å¼€å§‹è®­ç»ƒ
                const isLimited = this.checkDailyLimit();
                if (!isLimited) {
                    // è‡ªåŠ¨å¼€å§‹è®­ç»ƒ
                    this.startTraining();
                }
            }
            
            /**
             * åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
             */
            initializeEventListeners() {
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–æ€§èƒ½
                this.domCache.answerOptions.addEventListener('click', (e) => {
                    if (e.target.classList.contains('answer-btn')) {
                        this.checkAnswer(e.target);
                    }
                });
                
                // æ·»åŠ é‡ç½®æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                const resetLimitBtn = document.getElementById('resetLimitBtn');
                if (resetLimitBtn) {
                    resetLimitBtn.addEventListener('click', () => this.resetDailyLimit());
                }
                
                // æ·»åŠ å†å²è®°å½•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                this.domCache.showAllHistoryBtn.addEventListener('click', () => {
                    this.domCache.allHistoryContainer.style.display = 'block';
                    this.updateAllHistoryList();
                });
                
                this.domCache.hideAllHistoryBtn.addEventListener('click', () => {
                    this.domCache.allHistoryContainer.style.display = 'none';
                });
            }
            
            /**
             * æ£€æŸ¥æ¯æ—¥è®­ç»ƒä¸Šé™ï¼ˆæ”¯æŒé¢å¤–å¢åŠ çš„é¢˜ç›®æ•°é‡ï¼‰
             */
            checkDailyLimit() {
                // æ›´æ–°ç¼“å­˜çš„ä»Šæ—¥å†å²è®°å½•
                this.todayHistory = this.history.filter(h => h.date === this.today);
                
                // è·å–é¢å¤–å¢åŠ çš„é¢˜ç›®æ•°é‡
                const extraKey = `mathTrainingExtra_${this.today}`;
                const extraCount = parseInt(localStorage.getItem(extraKey) || '0');
                
                // è®¡ç®—å®é™…çš„ä¸Šé™ï¼ˆåŸºç¡€ä¸Šé™ + é¢å¤–å¢åŠ çš„é¢˜ç›®ï¼‰
                const actualLimit = this.dailyLimit + extraCount;
                
                // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²è¾¾åˆ°è®­ç»ƒä¸Šé™
                if (this.todayHistory.length >= actualLimit) {
                    // æ˜¾ç¤ºæ¯æ—¥é™åˆ¶æç¤º
                    this.domCache.dailyLimitAlert.classList.remove('hidden');
                    
                    // éšè—è®­ç»ƒåŒºåŸŸ
                    this.domCache.trainingArea.classList.add('hidden');
                    
                    // éšè—ç­”æ¡ˆé€‰é¡¹åŒºåŸŸ
                    this.domCache.answerOptions.classList.add('hidden');
                    
                    // æ›´æ–°æç¤ºä¿¡æ¯
                    const limitText = document.getElementById('limitText');
                    if (limitText) {
                        if (extraCount > 0) {
                            limitText.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ä»Šæ—¥å·²ç­”${this.todayHistory.length}é¢˜ï¼Œå·²è¾¾åˆ°${actualLimit}é¢˜ä¸Šé™ï¼ˆå«${extraCount}é“é¢å¤–é¢˜ç›®ï¼‰ï¼`;
                        } else {
                            limitText.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ä»Šæ—¥è®­ç»ƒå·²è¾¾åˆ°ä¸Šé™ï¼ˆ${this.dailyLimit}é¢˜ï¼‰ï¼Œæ˜å¤©å†æ¥ç»§ç»­å§ï¼`;
                        }
                    }
                    
                    return true; // å·²è¾¾åˆ°é™åˆ¶
                } else {
                    // æœªè¾¾åˆ°ä¸Šé™ï¼Œéšè—é™åˆ¶æç¤º
                    this.domCache.dailyLimitAlert.classList.add('hidden');
                    this.domCache.trainingArea.classList.remove('hidden');
                    
                    // æ˜¾ç¤ºç­”æ¡ˆé€‰é¡¹åŒºåŸŸ
                    this.domCache.answerOptions.classList.remove('hidden');
                    
                    return false; // æœªè¾¾åˆ°é™åˆ¶
                }
            }
            
            /**
             * å¢åŠ å½“æ—¥è®­ç»ƒä¸Šé™ï¼ˆæ¯æ¬¡å¢åŠ 10é“é¢˜ï¼‰
             */
            resetDailyLimit() {
                // ç¡®è®¤ç”¨æˆ·æ˜¯å¦è¦å¢åŠ è®­ç»ƒä¸Šé™
                if (confirm(`ç¡®å®šè¦å¢åŠ ä»Šæ—¥è®­ç»ƒä¸Šé™å—ï¼Ÿå°†é¢å¤–å¢åŠ 10é“é¢˜ï¼ˆå½“å‰å·²ç­”ï¼š${this.todayHistory.length}é“ï¼‰`)) {
                    // åœ¨localStorageä¸­å­˜å‚¨å¢åŠ çš„é¢˜ç›®æ•°é‡
                    const extraKey = `mathTrainingExtra_${this.today}`;
                    let extraCount = parseInt(localStorage.getItem(extraKey) || '0');
                    extraCount += 10; // æ¯æ¬¡å¢åŠ 10é“é¢˜
                    localStorage.setItem(extraKey, extraCount.toString());
                    
                    // éšè—æ¯æ—¥é™åˆ¶æç¤º
                    this.domCache.dailyLimitAlert.classList.add('hidden');
                    
                    // æ˜¾ç¤ºè®­ç»ƒåŒºåŸŸ
                    this.domCache.trainingArea.classList.remove('hidden');
                    
                    // æ˜¾ç¤ºå¢åŠ æˆåŠŸçš„åé¦ˆ
                    this.showFeedback(`âœ… ä»Šæ—¥è®­ç»ƒä¸Šé™å·²å¢åŠ 10é“é¢˜ï¼ï¼ˆé¢å¤–ï¼š${extraCount}é“ï¼‰`, 'success');
                    
                    // ç”Ÿæˆç¬¬ä¸€é¢˜
                    this.generateNextQuestion();
                }
            }
            
            /**
             * å¼€å§‹è®­ç»ƒ
             */
            startTraining() {
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¯æ—¥é™åˆ¶
                const isLimited = this.checkDailyLimit();
                
                // å¦‚æœæœªè¾¾åˆ°é™åˆ¶ï¼Œåˆ™å¼€å§‹è®­ç»ƒ
                if (!isLimited) {
                    // æ˜¾ç¤ºç­”æ¡ˆé€‰é¡¹åŒºåŸŸ
                    this.domCache.answerOptions.classList.remove('hidden');
                    // ç”Ÿæˆç¬¬ä¸€ä¸ªé—®é¢˜
                    this.generateNextQuestion();
                }
                
                // æ›´æ–°å¤ä¹ æé†’çŠ¶æ€
                this.updateReviewAlert();
            }
            
            /**
             * ç”Ÿæˆä¸‹ä¸€é¢˜
             */
            nextQuestion() {
                this.currentQuestion = this.generateSmartQuestion();
                this.displayQuestion();
                
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('feedback').classList.add('hidden');
                this.enableAnswerButtons();
            }
            
            /**
             * æ ¹æ®å†å²ç­”é¢˜æƒ…å†µæ™ºèƒ½ç”Ÿæˆé¢˜ç›®
             */
            /**
             * ç”Ÿæˆæ™ºèƒ½é¢˜ç›®
             * æ ¹æ®ç”¨æˆ·ç­”é¢˜å†å²ã€æ¨¡å¼åˆ†æå’Œè‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿è°ƒæ•´éš¾åº¦å’Œé¢˜å‹
             */
            generateSmartQuestion() {
                // é»˜è®¤å‚æ•°
                let maxNumber = 30;
                let isAddition = Math.random() > 0.5; // é»˜è®¤éšæœºé€‰æ‹©åŠ å‡æ³•
                let useWeakNumbers = false;
                let weakNumbers = [];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®ï¼ˆè‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ï¼‰
                const reviewQuestion = this.getReviewQuestionByEbbinghaus();
                if (reviewQuestion) {
                    // è¿”å›éœ€è¦å¤ä¹ çš„é¢˜ç›®
                    return reviewQuestion;
                }
                
                // è·å–ä»Šæ—¥å†å²è®°å½•å’Œæœ€è¿‘å†å²è®°å½•
                const todayHistory = this.history.filter(h => h.date === this.today);
                const recentHistory = this.history.slice(-20); // æœ€è¿‘20é“é¢˜
                
                // åˆ†æç”¨æˆ·ç­”é¢˜æ¨¡å¼
                const pattern = this.analyzeUserPattern();
                
                if (pattern && pattern.weakNumbers.length > 0) {
                    // ä½¿ç”¨é«˜çº§åˆ†æç»“æœ
                    
                    // æ ¹æ®åŠ å‡æ³•æ­£ç¡®ç‡è°ƒæ•´éš¾åº¦å’Œé¢˜å‹
                    if (pattern.additionAccuracy > 0.8 && pattern.subtractionAccuracy > 0.8) {
                        maxNumber = 30; // ä¸¤ç§é¢˜å‹éƒ½æŒæ¡å¾—å¾ˆå¥½ï¼Œå¢åŠ éš¾åº¦
                    } else if (pattern.additionAccuracy < 0.5 && pattern.subtractionAccuracy < 0.5) {
                        maxNumber = 15; // ä¸¤ç§é¢˜å‹éƒ½æŒæ¡ä¸å¥½ï¼Œé™ä½éš¾åº¦
                    } else {
                        maxNumber = 20; // ä¿æŒä¸­ç­‰éš¾åº¦
                    }
                    
                    // æ ¹æ®å°æ•°å­—å’Œå¤§æ•°å­—çš„æ­£ç¡®ç‡è¿›ä¸€æ­¥è°ƒæ•´
                    if (pattern.smallNumberAccuracy > 0.8 && pattern.largeNumberAccuracy < 0.6) {
                        // å°æ•°å­—æŒæ¡å¥½ä½†å¤§æ•°å­—ä¸è¡Œï¼Œé€‚å½“é™ä½éš¾åº¦
                        maxNumber = Math.min(maxNumber, 20);
                    }
                    
                    // ç¡®å®šé¢˜ç›®ç±»å‹ï¼Œä¼˜å…ˆé€‰æ‹©æ­£ç¡®ç‡è¾ƒä½çš„ç±»å‹
                    if (Math.abs(pattern.additionAccuracy - pattern.subtractionAccuracy) > 0.2) {
                        // 70%çš„æ¦‚ç‡å‡ºç°æ­£ç¡®ç‡è¾ƒä½çš„é¢˜å‹
                        if (Math.random() < 0.7) {
                            isAddition = pattern.additionAccuracy > pattern.subtractionAccuracy ? false : true;
                        }
                    }
                    
                    // ä½¿ç”¨å¼±ç‚¹æ•°å­—
                    weakNumbers = pattern.weakNumbers;
                    useWeakNumbers = Math.random() < 0.4; // 40%æ¦‚ç‡ä½¿ç”¨å¼±ç‚¹æ•°å­—
                } else if (todayHistory.length > 0) {
                    // ä½¿ç”¨åŸºæœ¬åˆ†æç»“æœ
                    const accuracy = todayHistory.filter(h => h.correct).length / todayHistory.length;
                    
                    // æ ¹æ®æ­£ç¡®ç‡è°ƒæ•´éš¾åº¦
                    if (accuracy < 0.6) {
                        maxNumber = 15; // é™ä½éš¾åº¦
                    } else if (accuracy > 0.9) {
                        maxNumber = 30; // ä¿æŒé«˜éš¾åº¦
                    }
                    
                    // åˆ†æåŠ å‡æ³•çš„æ­£ç¡®ç‡ï¼Œé’ˆå¯¹å¼±é¡¹è¿›è¡Œå¼ºåŒ–è®­ç»ƒ
                    if (recentHistory.length >= 5) {
                        const additionHistory = recentHistory.filter(h => h.type === 'addition');
                        const subtractionHistory = recentHistory.filter(h => h.type === 'subtraction');
                        
                        // åªæœ‰å½“æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®æ—¶æ‰è¿›è¡Œåˆ†æ
                        if (additionHistory.length >= 3 && subtractionHistory.length >= 3) {
                            const additionAccuracy = additionHistory.filter(h => h.correct).length / additionHistory.length;
                            const subtractionAccuracy = subtractionHistory.filter(h => h.correct).length / subtractionHistory.length;
                            
                            // å¦‚æœåŠ å‡æ³•æ­£ç¡®ç‡å·®å¼‚æ˜æ˜¾ï¼Œå¢åŠ å¼±é¡¹çš„å‡ºé¢˜æ¦‚ç‡
                            if (Math.abs(additionAccuracy - subtractionAccuracy) > 0.2) {
                                // 70%çš„æ¦‚ç‡å‡ºç°æ­£ç¡®ç‡è¾ƒä½çš„é¢˜å‹
                                if (Math.random() < 0.7) {
                                    isAddition = additionAccuracy > subtractionAccuracy ? false : true;
                                }
                            }
                        }
                    }
                    
                    // åˆ†æé”™è¯¯çš„é¢˜ç›®ï¼Œæ‰¾å‡ºéœ€è¦å¼ºåŒ–çš„æ•°å­—èŒƒå›´
                    const wrongAnswers = recentHistory.filter(h => !h.correct);
                    if (wrongAnswers.length > 0) {
                        // æå–é”™è¯¯é¢˜ç›®ä¸­çš„æ•°å­—
                        wrongAnswers.forEach(record => {
                            // ä»é—®é¢˜ä¸­æå–æ•°å­—
                            const numbers = record.question.match(/\d+/g);
                            if (numbers && numbers.length >= 2) {
                                weakNumbers.push(parseInt(numbers[0]), parseInt(numbers[1]));
                            }
                        });
                        
                        // å¦‚æœæœ‰é”™è¯¯çš„æ•°å­—ï¼Œ30%çš„æ¦‚ç‡ä½¿ç”¨è¿™äº›æ•°å­—èŒƒå›´å‡ºé¢˜
                        if (weakNumbers.length > 0) {
                            useWeakNumbers = Math.random() < 0.3;
                            // è®¡ç®—é”™è¯¯æ•°å­—çš„å¹³å‡å€¼ä½œä¸ºéš¾åº¦å‚è€ƒ
                            const avgWrongNumber = weakNumbers.reduce((a, b) => a + b, 0) / weakNumbers.length;
                            // æ ¹æ®å¹³å‡å€¼è°ƒæ•´æœ€å¤§æ•°å­—èŒƒå›´
                            maxNumber = Math.min(30, Math.max(15, Math.round(avgWrongNumber * 1.5)));
                        }
                    }
                }
                
                // ç”Ÿæˆé¢˜ç›®æ•°å­—
                let num1, num2;
                
                if (useWeakNumbers && weakNumbers.length > 0) {
                    // ä½¿ç”¨å¼±ç‚¹æ•°å­—ä½œä¸ºå…¶ä¸­ä¸€ä¸ªæ“ä½œæ•°
                    num1 = weakNumbers[Math.floor(Math.random() * weakNumbers.length)];
                    // ç¡®ä¿æ•°å­—åœ¨åˆç†èŒƒå›´å†…
                    num1 = Math.min(num1, maxNumber);
                    num2 = Math.floor(Math.random() * maxNumber) + 1;
                } else {
                    num1 = Math.floor(Math.random() * maxNumber) + 1;
                    num2 = Math.floor(Math.random() * maxNumber) + 1;
                }
                
                let question, answer, type;
                if (isAddition) {
                    question = `${num1} + ${num2} = ?`;
                    answer = num1 + num2;
                    type = 'addition';
                } else {
                    // ç¡®ä¿å‡æ³•ç»“æœä¸ºæ­£æ•°
                    const larger = Math.max(num1, num2);
                    const smaller = Math.min(num1, num2);
                    question = `${larger} - ${smaller} = ?`;
                    answer = larger - smaller;
                    type = 'subtraction';
                    num1 = larger;
                    num2 = smaller;
                }
                
                return { question, answer, num1, num2, type, isAddition }; // æ·»åŠ typeå­—æ®µä»¥ä¾¿è®°å½•
            }
            
            /**
             * ç”Ÿæˆå…·æœ‰è¿·æƒ‘æ€§çš„å¹²æ‰°é€‰é¡¹
             */
            generateOptions(correctAnswer) {
                const options = [correctAnswer];
                const todayHistory = this.history.filter(h => h.date === this.today);
                
                // æ ¹æ®å†å²é”™è¯¯æ¨¡å¼ç”Ÿæˆå¹²æ‰°é¡¹
                const commonMistakes = this.getCommonMistakes();
                
                while (options.length < 4) {
                    let wrongOption;
                    const mistakeType = Math.random();
                    
                    if (mistakeType < 0.4 && commonMistakes.length > 0) {
                        // ä½¿ç”¨å¸¸è§é”™è¯¯æ¨¡å¼ï¼ˆå¢åŠ æƒé‡ï¼‰
                        const mistake = commonMistakes[Math.floor(Math.random() * commonMistakes.length)];
                        wrongOption = correctAnswer + mistake.offset;
                    } else if (mistakeType < 0.7) {
                        // ç›¸é‚»æ•°å­—é”™è¯¯
                        wrongOption = correctAnswer + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 3) + 1);
                    } else {
                        // è®¡ç®—é”™è¯¯
                        wrongOption = correctAnswer + (Math.random() > 0.5 ? 10 : -10);
                    }
                    
                    // ç¡®ä¿é€‰é¡¹åœ¨åˆç†èŒƒå›´å†…ä¸”å”¯ä¸€
                    wrongOption = Math.max(0, Math.min(60, wrongOption));
                    if (!options.includes(wrongOption)) {
                        options.push(wrongOption);
                    }
                }
                
                return this.shuffleArray(options);
            }
            
            /**
             * è·å–å¸¸è§é”™è¯¯æ¨¡å¼
             * åˆ†æå†å²é”™è¯¯ç­”æ¡ˆï¼Œç»Ÿè®¡é”™è¯¯åç§»é‡åŠå…¶é¢‘ç‡
             */
            getCommonMistakes() {
                const mistakeMap = {};
                const wrongAnswers = this.history.filter(h => !h.correct);
                
                // ç»Ÿè®¡æ¯ç§é”™è¯¯åç§»é‡çš„å‡ºç°æ¬¡æ•°
                wrongAnswers.forEach(record => {
                    const offset = record.selectedAnswer - record.correctAnswer;
                    // åªå…³æ³¨è¾ƒå°çš„åç§»é‡ï¼Œè¿™äº›æ›´å¯èƒ½æ˜¯è®¡ç®—é”™è¯¯è€ŒééšæœºçŒœæµ‹
                    if (Math.abs(offset) <= 5) {
                        const key = offset.toString();
                        if (!mistakeMap[key]) {
                            mistakeMap[key] = { offset, count: 0 };
                        }
                        mistakeMap[key].count += 1;
                    }
                });
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰å‡ºç°é¢‘ç‡æ’åº
                const mistakes = Object.values(mistakeMap);
                mistakes.sort((a, b) => b.count - a.count);
                
                // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„é”™è¯¯è®°å½•ï¼Œæ·»åŠ ä¸€äº›å¸¸è§é”™è¯¯æ¨¡å¼
                if (mistakes.length < 2) {
                    // åŠ ä¸€é”™è¯¯
                    if (!mistakeMap['1']) mistakes.push({ offset: 1, count: 1 });
                    // å‡ä¸€é”™è¯¯
                    if (!mistakeMap['-1']) mistakes.push({ offset: -1, count: 1 });
                    // åŠ åé”™è¯¯ï¼ˆè¿›ä½é—®é¢˜ï¼‰
                    if (!mistakeMap['10']) mistakes.push({ offset: 10, count: 1 });
                }
                
                return mistakes;
            }
            
            /**
             * æ˜¾ç¤ºé¢˜ç›®
             * æ”¯æŒæ˜¾ç¤ºæ™®é€šé¢˜ç›®å’Œè‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿å¤ä¹ é¢˜ç›®
             */
            displayQuestion() {
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¤ä¹ é¢˜ç›®
                const isReviewQuestion = this.currentQuestion.isReview;
                
                // è®¾ç½®é¢˜ç›®æ–‡æœ¬
                if (isReviewQuestion) {
                    // ä¸ºå¤ä¹ é¢˜ç›®æ·»åŠ ç‰¹æ®Šæ ‡è®°
                    const reviewStage = this.currentQuestion.reviewStage || 0;
                    const reviewLabel = `<span class="badge bg-warning text-dark me-2">å¤ä¹  ${reviewStage + 1}/6</span>`;
                    this.domCache.question.innerHTML = reviewLabel + this.currentQuestion.question;
                } else {
                    this.domCache.question.textContent = this.currentQuestion.question;
                }
                
                const options = this.generateOptions(this.currentQuestion.answer);
                const buttons = [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD];
                
                buttons.forEach((button, index) => {
                    button.textContent = options[index];
                    // ä¸ºå¤ä¹ é¢˜ç›®çš„æŒ‰é’®æ·»åŠ ç‰¹æ®Šæ ·å¼
                    if (isReviewQuestion) {
                        button.className = 'btn btn-outline-warning answer-btn';
                    } else {
                        button.className = 'btn btn-primary answer-btn';
                    }
                    button.disabled = false;
                });
            }
            
            /**
             * æ£€æŸ¥ç­”æ¡ˆ
             */
            checkAnswer(button) {
                const selectedAnswer = parseInt(button.textContent);
                const isCorrect = selectedAnswer === this.currentQuestion.answer;
                
                // æ›´æ–°æŒ‰é’®æ ·å¼
                if (isCorrect) {
                    button.classList.add('correct');
                    this.showFeedback('ğŸ‰ å¤ªæ£’äº†ï¼', 'success');
                } else {
                    button.classList.add('incorrect');
                    // æ ‡è®°æ­£ç¡®ç­”æ¡ˆ
                    const buttons = [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD];
                    buttons.forEach(btn => {
                        if (parseInt(btn.textContent) === this.currentQuestion.answer) {
                            btn.classList.add('correct');
                        }
                    });
                    this.showFeedback('ğŸ’ª å†è¯•ä¸€æ¬¡ï¼', 'danger');
                }
                
                // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
                this.disableAnswerButtons();
                
                // è®°å½•ç­”é¢˜å†å²
                this.recordAnswer(isCorrect, selectedAnswer);
                
                // å¦‚æœæ˜¯å¤ä¹ é¢˜ç›®ï¼Œæ›´æ–°å¤ä¹ çŠ¶æ€
                if (this.currentQuestion.isReview) {
                    this.updateReviewStatus(this.currentQuestion.reviewItem, isCorrect);
                    // æ›´æ–°ä»Šæ—¥å¤ä¹ æé†’
                    this.updateReviewAlert();
                }
                
                // å»¶è¿Ÿåè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜æˆ–æ£€æŸ¥é™åˆ¶
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¯æ—¥é™åˆ¶
                    const isLimited = this.checkDailyLimit();
                    
                    if (isLimited) {
                        // å·²è¾¾åˆ°é™åˆ¶ï¼Œä¸éœ€è¦åšä»»ä½•äº‹æƒ…ï¼Œæç¤ºä¿¡æ¯å·²ç»æ˜¾ç¤º
                    } else {
                        // æœªè¾¾åˆ°é™åˆ¶ï¼Œè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
                        this.generateNextQuestion();
                    }
                }, 1000);
            }

            /**
             * ç”Ÿæˆä¸‹ä¸€é¢˜
             */
            generateNextQuestion() {
                this.currentQuestion = this.generateSmartQuestion();
                this.displayQuestion();
                
                // éšè—åé¦ˆä¿¡æ¯
                this.domCache.feedback.classList.add('hidden');
                
                // å¯ç”¨ç­”æ¡ˆæŒ‰é’®
                this.enableAnswerButtons();
                
                // æ›´æ–°å¤ä¹ æé†’çŠ¶æ€
                this.updateReviewAlert();
            }
            
            /**
             * è®°å½•ç­”é¢˜å†å²
             * ä¿å­˜ç­”é¢˜è®°å½•å¹¶æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
             * æ”¯æŒè‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿å¤ä¹ é¢˜ç›®çš„è®°å½•
             */
            recordAnswer(isCorrect, selectedAnswer) {
                const record = {
                    date: this.today,
                    time: new Date().toLocaleTimeString(),
                    question: this.currentQuestion.question,
                    correctAnswer: this.currentQuestion.answer,
                    selectedAnswer: selectedAnswer,
                    correct: isCorrect,
                    isReview: this.currentQuestion.isReview || false, // æ˜¯å¦ä¸ºå¤ä¹ é¢˜ç›®
                    reviewStage: this.currentQuestion.reviewStage || 0, // å¤ä¹ é˜¶æ®µ
                    type: this.currentQuestion.type || (this.currentQuestion.isAddition ? 'addition' : 'subtraction')
                };
                
                this.history.push(record);
                this.saveHistory();
                // æ›´æ–°ç¼“å­˜çš„ä»Šæ—¥å†å²è®°å½•
                this.todayHistory = this.history.filter(h => h.date === this.today);
                this.updateStats();
                
                // æ¯5é“é¢˜åˆ†æä¸€æ¬¡ç”¨æˆ·æ¨¡å¼ï¼Œä»¥ä¾¿æ›´å¥½åœ°è°ƒæ•´å‡ºé¢˜ç­–ç•¥
                if (this.todayHistory.length % 5 === 0) {
                    this.analyzeUserPattern();
                }
                this.updateAllTimeStats();
                this.updateHistoryList();
                this.checkDailyLimit();
                
                // å¦‚æœæ˜¯å¤ä¹ é¢˜ç›®ï¼Œæ›´æ–°ä»Šæ—¥å¤ä¹ æé†’
                if (this.currentQuestion.isReview) {
                    this.updateReviewAlert();
                }
            }
            
            /**
             * é˜²æŠ–å‡½æ•°ï¼šå»¶è¿Ÿæ‰§è¡Œ
             */
            debounce(func, delay) {
                return (...args) => {
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => func.apply(this, args), delay);
                };
            }
            
            /**
             * èŠ‚æµå‡½æ•°ï¼šé™åˆ¶æ‰§è¡Œé¢‘ç‡
             */
            throttle(func, limit) {
                return (...args) => {
                    const now = Date.now();
                    if (now - this.lastThrottleTime >= limit) {
                        this.lastThrottleTime = now;
                        return func.apply(this, args);
                    }
                };
            }
            
            /**
             * æ‰¹é‡DOMæ›´æ–°ï¼šå‡å°‘é‡æ’é‡ç»˜
             */
            batchDOMUpdate(updateFn) {
                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ¸²æŸ“
                if (window.requestAnimationFrame) {
                    requestAnimationFrame(updateFn);
                } else {
                    updateFn();
                }
            }
            
            /**
             * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨é˜²æŠ–ï¼‰
             */
            updateStats() {
                // ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹æ›´æ–°
                const debouncedUpdate = this.debounce(() => {
                    const totalToday = this.todayHistory.length;
                    const correctToday = this.todayHistory.filter(h => h.correct).length;
                    const accuracyToday = totalToday > 0 ? Math.round((correctToday / totalToday) * 100) : 0;
                    
                    const totalAll = this.history.length;
                    const correctAll = this.history.filter(h => h.correct).length;
                    const accuracyAll = totalAll > 0 ? Math.round((correctAll / totalAll) * 100) : 0;
                    
                    // æ‰¹é‡æ›´æ–°DOMï¼Œå‡å°‘é‡æ’é‡ç»˜
                    this.batchDOMUpdate(() => {
                        this.domCache.todayTotal.textContent = totalToday;
                        this.domCache.todayCorrect.textContent = correctToday;
                        this.domCache.todayAccuracy.textContent = accuracyToday + '%';
                        
                        this.domCache.totalQuestions.textContent = totalAll;
                        this.domCache.totalCorrect.textContent = correctAll;
                        this.domCache.totalAccuracy.textContent = accuracyAll + '%';
                    });
                }, 50);
                
                debouncedUpdate();
            }
            
            /**
             * æ›´æ–°æ‰€æœ‰æ—¶é—´ç»Ÿè®¡ä¿¡æ¯
             */
            updateAllTimeStats() {
                const totalAll = this.history.length;
                const correctAll = this.history.filter(h => h.correct).length;
                const accuracyAll = totalAll > 0 ? Math.round((correctAll / totalAll) * 100) : 0;
                
                // æ›´æ–°æ‰€æœ‰æ—¶é—´ç»Ÿè®¡
                this.batchDOMUpdate(() => {
                    this.domCache.allTimeTotal.textContent = totalAll;
                    this.domCache.allTimeCorrect.textContent = correctAll;
                    this.domCache.allTimeAccuracy.textContent = accuracyAll + '%';
                });
            }
            
            /**
             * æ›´æ–°å†å²è®°å½•åˆ—è¡¨ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨æ–‡æ¡£ç‰‡æ®µï¼‰
             */
            updateHistoryList() {
                const todayHistory = this.todayHistory.slice(-5);
                
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMæ“ä½œ
                const fragment = document.createDocumentFragment();
                
                // æ¸…ç©ºå†å²è®°å½•åˆ—è¡¨
                this.domCache.historyList.innerHTML = '';
                
                // æ‰¹é‡åˆ›å»ºå…ƒç´ 
                todayHistory.reverse().forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'history-item fade-in';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${record.question}</strong>
                                <br>
                                <small class="text-muted">${record.time}</small>
                            </div>
                            <div>
                                <span class="badge ${record.correct ? 'bg-success' : 'bg-danger'}">
                                    ${record.correct ? 'âœ“' : 'âœ—'} ${record.selectedAnswer}
                                </span>
                            </div>
                        </div>
                    `;
                    fragment.appendChild(item);
                });
                
                // ä¸€æ¬¡æ€§æ·»åŠ åˆ°DOM
                this.domCache.historyList.appendChild(fragment);
            }
            
            /**
             * æ›´æ–°æ‰€æœ‰å†å²è®°å½•åˆ—è¡¨
             */
            updateAllHistoryList() {
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMæ“ä½œ
                const fragment = document.createDocumentFragment();
                
                // æ¸…ç©ºå†å²è®°å½•åˆ—è¡¨
                this.domCache.allHistoryList.innerHTML = '';
                
                // å¦‚æœæ²¡æœ‰å†å²è®°å½•
                if (this.history.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'history-item text-center';
                    item.innerHTML = '<p class="mb-0">æš‚æ— å†å²è®°å½•</p>';
                    fragment.appendChild(item);
                    this.domCache.allHistoryList.appendChild(fragment);
                    return;
                }
                
                // æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤ºå†å²è®°å½•
                const groupedHistory = {};
                this.history.forEach(record => {
                    if (!groupedHistory[record.date]) {
                        groupedHistory[record.date] = [];
                    }
                    groupedHistory[record.date].push(record);
                });
                
                // æŒ‰æ—¥æœŸå€’åºæ˜¾ç¤º
                const sortedDates = Object.keys(groupedHistory).sort().reverse();
                
                sortedDates.forEach(date => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'alert alert-secondary mt-3 mb-2 py-2';
                    dateHeader.innerHTML = `<strong>${date}</strong>`;
                    fragment.appendChild(dateHeader);
                    
                    groupedHistory[date].reverse().forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'history-item fade-in';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${record.question}</strong>
                                    <br>
                                    <small class="text-muted">${record.time}</small>
                                </div>
                                <div>
                                    <span class="badge ${record.correct ? 'bg-success' : 'bg-danger'}">
                                        ${record.correct ? 'âœ“' : 'âœ—'} ${record.selectedAnswer}
                                    </span>
                                </div>
                            </div>
                        `;
                        fragment.appendChild(item);
                    });
                });
                
                // ä¸€æ¬¡æ€§æ·»åŠ åˆ°DOM
                this.domCache.allHistoryList.appendChild(fragment);
            }
            
            /**
             * æ˜¾ç¤ºåé¦ˆä¿¡æ¯
             */
            showFeedback(message, type) {
                this.domCache.feedback.textContent = message;
                this.domCache.feedback.className = `emoji-feedback fade-in text-${type}`;
                this.domCache.feedback.classList.remove('hidden');
            }
            
            /**
             * å¯ç”¨ç­”æ¡ˆæŒ‰é’®
             */
            enableAnswerButtons() {
                [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD].forEach(button => {
                    button.disabled = false;
                });
            }
            
            /**
             * ç¦ç”¨ç­”æ¡ˆæŒ‰é’®
             */
            disableAnswerButtons() {
                [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD].forEach(button => {
                    button.disabled = true;
                });
            }
            
            /**
             * éšè—è®­ç»ƒåŒºåŸŸ
             */
            hideTrainingArea() {
                this.domCache.trainingArea.classList.add('hidden');
                this.domCache.answerOptions.classList.add('hidden');
            }
            
            /**
             * åˆ†æç”¨æˆ·ç­”é¢˜æ¨¡å¼
             * ç”¨äºæ™ºèƒ½å‡ºé¢˜ç³»ç»Ÿåˆ†æç”¨æˆ·çš„ç­”é¢˜ä¹ æƒ¯å’Œå¼±ç‚¹
             */
            analyzeUserPattern() {
                // è·å–æœ€è¿‘çš„ç­”é¢˜è®°å½•
                const recentHistory = this.history.slice(-30); // æœ€è¿‘30é“é¢˜
                if (recentHistory.length < 5) return null; // æ•°æ®ä¸è¶³ï¼Œæ— æ³•åˆ†æ
                
                const result = {
                    additionAccuracy: 0,
                    subtractionAccuracy: 0,
                    smallNumberAccuracy: 0, // 10ä»¥å†…çš„å°æ•°å­—
                    largeNumberAccuracy: 0, // 10ä»¥ä¸Šçš„å¤§æ•°å­—
                    commonMistakes: [],
                    weakNumbers: [] // ç»å¸¸å‡ºé”™çš„æ•°å­—
                };
                
                // åˆ†æåŠ å‡æ³•æ­£ç¡®ç‡
                const additionHistory = recentHistory.filter(h => h.type === 'addition');
                const subtractionHistory = recentHistory.filter(h => h.type === 'subtraction');
                
                if (additionHistory.length > 0) {
                    result.additionAccuracy = additionHistory.filter(h => h.correct).length / additionHistory.length;
                }
                
                if (subtractionHistory.length > 0) {
                    result.subtractionAccuracy = subtractionHistory.filter(h => h.correct).length / subtractionHistory.length;
                }
                
                // åˆ†æä¸åŒæ•°å­—èŒƒå›´çš„æ­£ç¡®ç‡
                const smallNumberQuestions = recentHistory.filter(record => {
                    const numbers = record.question.match(/\d+/g);
                    return numbers && numbers.every(num => parseInt(num) <= 10);
                });
                
                const largeNumberQuestions = recentHistory.filter(record => {
                    const numbers = record.question.match(/\d+/g);
                    return numbers && numbers.some(num => parseInt(num) > 10);
                });
                
                if (smallNumberQuestions.length > 0) {
                    result.smallNumberAccuracy = smallNumberQuestions.filter(h => h.correct).length / smallNumberQuestions.length;
                }
                
                if (largeNumberQuestions.length > 0) {
                    result.largeNumberAccuracy = largeNumberQuestions.filter(h => h.correct).length / largeNumberQuestions.length;
                }
                
                // è·å–å¸¸è§é”™è¯¯æ¨¡å¼
                result.commonMistakes = this.getCommonMistakes();
                
                // åˆ†æç»å¸¸å‡ºé”™çš„æ•°å­—
                const wrongAnswers = recentHistory.filter(h => !h.correct);
                const numberFrequency = {};
                
                wrongAnswers.forEach(record => {
                    const numbers = record.question.match(/\d+/g);
                    if (numbers) {
                        numbers.forEach(num => {
                            const n = parseInt(num);
                            if (!numberFrequency[n]) numberFrequency[n] = 0;
                            numberFrequency[n]++;
                        });
                    }
                });
                
                // æ‰¾å‡ºå‡ºç°é¢‘ç‡æœ€é«˜çš„æ•°å­—
                result.weakNumbers = Object.entries(numberFrequency)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(entry => parseInt(entry[0]));
                
                return result;
            }
            
            /**
             * æ‰“ä¹±æ•°ç»„é¡ºåº
             */
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            /**
             * åŠ è½½å†å²è®°å½•
             */
            loadHistory() {
                const saved = localStorage.getItem('mathTrainingHistory');
                return saved ? JSON.parse(saved) : [];
            }
            
            /**
             * ä¿å­˜å†å²è®°å½•
             */
            saveHistory() {
                localStorage.setItem('mathTrainingHistory', JSON.stringify(this.history));
                // æ›´æ–°è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
                this.updateEbbinghausData();
            }
            
            /**
             * åŠ è½½è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
             * ç”¨äºè·Ÿè¸ªéœ€è¦å¤ä¹ çš„é¢˜ç›®
             */
            loadEbbinghausData() {
                const saved = localStorage.getItem('mathTrainingEbbinghaus');
                return saved ? JSON.parse(saved) : [];
            }
            
            /**
             * ä¿å­˜è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
             */
            saveEbbinghausData(data) {
                localStorage.setItem('mathTrainingEbbinghaus', JSON.stringify(data));
            }
            
            /**
             * æ›´æ–°è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
             * æ ¹æ®ç­”é¢˜è®°å½•æ›´æ–°éœ€è¦å¤ä¹ çš„é¢˜ç›®
             */
            updateEbbinghausData() {
                // è·å–å½“å‰çš„è‰¾å®¾æµ©æ–¯æ•°æ®
                const ebbinghausData = this.loadEbbinghausData();
                
                // è·å–æœ€è¿‘çš„é”™è¯¯ç­”é¢˜è®°å½•
                const recentWrongAnswers = this.history.filter(h => !h.correct)
                    .slice(-10); // æœ€è¿‘10é“é”™é¢˜
                
                // å½“å‰æ—¥æœŸ
                const today = new Date();
                
                // è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿é—´éš”ï¼ˆå•ä½ï¼šå¤©ï¼‰
                const intervals = [1, 2, 4, 7, 15, 30];
                
                // å¤„ç†æ¯é“é”™é¢˜
                recentWrongAnswers.forEach(record => {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è®°å¿†æ›²çº¿æ•°æ®ä¸­
                    const existingIndex = ebbinghausData.findIndex(item => 
                        item.question === record.question && 
                        item.date === record.date && 
                        item.time === record.time
                    );
                    
                    if (existingIndex === -1) {
                        // æ–°çš„é”™é¢˜ï¼Œæ·»åŠ åˆ°è®°å¿†æ›²çº¿æ•°æ®ä¸­
                        const reviewDates = intervals.map(interval => {
                            const reviewDate = new Date(today);
                            reviewDate.setDate(today.getDate() + interval);
                            return reviewDate.toISOString().split('T')[0];
                        });
                        
                        ebbinghausData.push({
                            ...record,
                            reviewDates,
                            reviewStatus: Array(intervals.length).fill(false), // è®°å½•æ¯ä¸ªé˜¶æ®µæ˜¯å¦å·²å¤ä¹ 
                            stage: 0, // å½“å‰å¤„äºç¬¬å‡ ä¸ªé˜¶æ®µ
                            lastReviewDate: null, // æœ€åä¸€æ¬¡å¤ä¹ æ—¥æœŸ
                            answeredCorrectToday: false // ä»Šå¤©æ˜¯å¦å·²ç­”å¯¹
                        });
                    }
                });
                
                // ä¿å­˜æ›´æ–°åçš„è‰¾å®¾æµ©æ–¯æ•°æ®
                this.saveEbbinghausData(ebbinghausData);
            }
            
            /**
             * æ£€æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®
             * åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå¤ä¹ æç¤ºä¿¡æ¯
             */
            checkTodayReviews() {
                // è·å–è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
                const ebbinghausData = this.loadEbbinghausData();
                if (!ebbinghausData || ebbinghausData.length === 0) {
                    return; // æ²¡æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®
                }
                
                // è·å–ä¸Šæ¬¡æ£€æŸ¥æ—¥æœŸ
                const lastCheckDate = localStorage.getItem('lastCheckDate');
                const today = this.today;
                
                // å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œé‡ç½®æ‰€æœ‰é¢˜ç›®çš„answeredCorrectTodayæ ‡è®°
                if (lastCheckDate !== today) {
                    ebbinghausData.forEach(item => {
                        item.answeredCorrectToday = false;
                    });
                    
                    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
                    this.saveEbbinghausData(ebbinghausData);
                    
                    // æ›´æ–°ä¸Šæ¬¡æ£€æŸ¥æ—¥æœŸ
                    localStorage.setItem('lastCheckDate', today);
                }
                
                // æ‰¾å‡ºä»Šå¤©éœ€è¦å¤ä¹ çš„é¢˜ç›®
                const needReviewItems = ebbinghausData.filter(item => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»Šå¤©éœ€è¦å¤ä¹ çš„é˜¶æ®µ
                    const stageIndex = item.reviewDates.findIndex(date => date === today);
                    
                    // å¦‚æœæ‰¾åˆ°ä»Šå¤©éœ€è¦å¤ä¹ çš„é˜¶æ®µï¼Œå¹¶ä¸”è¯¥é˜¶æ®µå°šæœªå¤ä¹ 
                    // åŒæ—¶æ£€æŸ¥è¯¥é¢˜ç›®æ˜¯å¦å·²ç»åœ¨ä»Šå¤©è¢«å›ç­”æ­£ç¡®è¿‡
                    return stageIndex !== -1 && !item.reviewStatus[stageIndex] && !item.answeredCorrectToday;
                });
                
                // å¦‚æœæœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (needReviewItems.length > 0) {
                    // åˆ›å»ºæˆ–è·å–æç¤ºå…ƒç´ 
                    let reviewAlert = document.getElementById('reviewAlert');
                    if (!reviewAlert) {
                        reviewAlert = document.createElement('div');
                        reviewAlert.id = 'reviewAlert';
                        reviewAlert.className = 'alert alert-warning';
                        // æ’å…¥åˆ°è®­ç»ƒåŒºåŸŸä¹‹å‰
                        this.domCache.trainingArea.parentNode.insertBefore(reviewAlert, this.domCache.trainingArea);
                    }
                    
                    // è®¾ç½®æç¤ºå†…å®¹
                    reviewAlert.innerHTML = `
                        <strong>ä»Šæ—¥å¤ä¹ æé†’</strong>ï¼šæ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ï¼Œæ‚¨æœ‰ ${needReviewItems.length} é“é¢˜ç›®éœ€è¦å¤ä¹ ã€‚
                        è¿™äº›é¢˜ç›®å°†ä¼˜å…ˆå‡ºç°åœ¨æ‚¨çš„è®­ç»ƒä¸­ã€‚
                    `;
                }
            }
            
            /**
             * æ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿è·å–éœ€è¦å¤ä¹ çš„é¢˜ç›®
             * æŒ‰ç…§è®°å¿†æ›²çº¿çš„æ—¶é—´é—´éš”å®‰æ’å¤ä¹ 
             */
            getReviewQuestionByEbbinghaus() {
                // è·å–è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
                const ebbinghausData = this.loadEbbinghausData();
                if (!ebbinghausData || ebbinghausData.length === 0) {
                    return null; // æ²¡æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®
                }
                
                // å½“å‰æ—¥æœŸ
                const today = this.today;
                
                // æ‰¾å‡ºä»Šå¤©éœ€è¦å¤ä¹ çš„é¢˜ç›®
                const needReviewItems = ebbinghausData.filter(item => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»Šå¤©éœ€è¦å¤ä¹ çš„é˜¶æ®µ
                    const stageIndex = item.reviewDates.findIndex(date => date === today);
                    
                    // å¦‚æœæ‰¾åˆ°ä»Šå¤©éœ€è¦å¤ä¹ çš„é˜¶æ®µï¼Œå¹¶ä¸”è¯¥é˜¶æ®µå°šæœªå¤ä¹ 
                    return stageIndex !== -1 && !item.reviewStatus[stageIndex];
                });
                
                if (needReviewItems.length === 0) {
                    return null; // ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®
                }
                
                // éšæœºé€‰æ‹©ä¸€é“éœ€è¦å¤ä¹ çš„é¢˜ç›®
                const reviewItem = needReviewItems[Math.floor(Math.random() * needReviewItems.length)];
                
                // ä»é—®é¢˜ä¸­æå–æ•°å­—
                const numbers = reviewItem.question.match(/\d+/g);
                if (!numbers || numbers.length < 2) {
                    return null; // æ— æ³•è§£æé¢˜ç›®
                }
                
                // è§£æé¢˜ç›®ç±»å‹å’Œæ•°å­—
                const num1 = parseInt(numbers[0]);
                const num2 = parseInt(numbers[1]);
                const isAddition = reviewItem.question.includes('+');
                const type = isAddition ? 'addition' : 'subtraction';
                
                // æ„å»ºå¤ä¹ é¢˜ç›®
                const question = reviewItem.question;
                const answer = isAddition ? (num1 + num2) : (num1 - num2);
                
                // ä¸å†åœ¨è¿™é‡Œæ›´æ–°å¤ä¹ çŠ¶æ€ï¼Œåªåœ¨ç”¨æˆ·å®é™…ç­”é¢˜æ—¶æ›´æ–°
                // this.updateReviewStatus(reviewItem);
                
                // è¿”å›å¤ä¹ é¢˜ç›®ï¼Œå¹¶æ ‡è®°ä¸ºå¤ä¹ é¢˜
                return { 
                    question, 
                    answer, 
                    num1, 
                    num2, 
                    type, 
                    isAddition,
                    isReview: true, // æ ‡è®°ä¸ºå¤ä¹ é¢˜
                    reviewStage: reviewItem.stage, // å½“å‰å¤ä¹ é˜¶æ®µ
                    reviewItem: reviewItem // ä¼ é€’reviewItemç”¨äºåç»­æ›´æ–°çŠ¶æ€
                };
            }
            
            /**
             * æ›´æ–°é¢˜ç›®çš„å¤ä¹ çŠ¶æ€
             */
            updateReviewStatus(reviewItem, isCorrect = true) {
                // è·å–è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
                const ebbinghausData = this.loadEbbinghausData();
                
                // æ‰¾åˆ°å¯¹åº”çš„é¢˜ç›®
                const itemIndex = ebbinghausData.findIndex(item => 
                    item.question === reviewItem.question && 
                    item.date === reviewItem.date && 
                    item.time === reviewItem.time
                );
                
                if (itemIndex !== -1) {
                    // å½“å‰æ—¥æœŸ
                    const today = this.today;
                    
                    // æ‰¾å‡ºä»Šå¤©å¯¹åº”çš„å¤ä¹ é˜¶æ®µ
                    const stageIndex = ebbinghausData[itemIndex].reviewDates.findIndex(date => date === today);
                    
                    if (stageIndex !== -1) {
                        // æ ‡è®°è¯¥é˜¶æ®µå·²å¤ä¹ 
                        ebbinghausData[itemIndex].reviewStatus[stageIndex] = true;
                        // æ›´æ–°å½“å‰é˜¶æ®µ
                        ebbinghausData[itemIndex].stage = stageIndex + 1;
                        // æ›´æ–°æœ€åå¤ä¹ æ—¥æœŸ
                        ebbinghausData[itemIndex].lastReviewDate = today;
                        
                        // å¦‚æœå›ç­”æ­£ç¡®ï¼Œæ ‡è®°è¯¥é¢˜ç›®ä»Šå¤©å·²ç»å›ç­”æ­£ç¡®ï¼Œé¿å…å†æ¬¡å‡ºç°
                        if (isCorrect) {
                            ebbinghausData[itemIndex].answeredCorrectToday = true;
                        }
                        
                        // ä¿å­˜æ›´æ–°åçš„æ•°æ®
                        this.saveEbbinghausData(ebbinghausData);
                    }
                }
            }
            
            /**
             * æ›´æ–°ä»Šæ—¥å¤ä¹ æé†’
             * åœ¨ç”¨æˆ·å›ç­”å¤ä¹ é¢˜ç›®åæ›´æ–°æé†’ä¸­çš„å‰©ä½™é¢˜ç›®æ•°é‡
             * å½“å…¨éƒ¨å¤ä¹ å®Œæˆåï¼Œç§»é™¤æé†’
             */
            updateReviewAlert() {
                // è·å–è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿æ•°æ®
                const ebbinghausData = this.loadEbbinghausData();
                if (!ebbinghausData || ebbinghausData.length === 0) {
                    return; // æ²¡æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®
                }
                
                // å½“å‰æ—¥æœŸ
                const today = this.today;
                
                // æ‰¾å‡ºä»Šå¤©éœ€è¦å¤ä¹ çš„é¢˜ç›®
                const needReviewItems = ebbinghausData.filter(item => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»Šå¤©éœ€è¦å¤ä¹ çš„é˜¶æ®µ
                    const stageIndex = item.reviewDates.findIndex(date => date === today);
                    
                    // å¦‚æœæ‰¾åˆ°ä»Šå¤©éœ€è¦å¤ä¹ çš„é˜¶æ®µï¼Œå¹¶ä¸”è¯¥é˜¶æ®µå°šæœªå¤ä¹ 
                    // åŒæ—¶æ£€æŸ¥è¯¥é¢˜ç›®æ˜¯å¦å·²ç»åœ¨ä»Šå¤©è¢«å›ç­”æ­£ç¡®è¿‡
                    return stageIndex !== -1 && !item.reviewStatus[stageIndex] && !item.answeredCorrectToday;
                });
                
                // è·å–æç¤ºå…ƒç´ 
                let reviewAlert = document.getElementById('reviewAlert');
                
                // å¦‚æœæœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®ï¼Œæ›´æ–°æç¤ºä¿¡æ¯
                if (needReviewItems.length > 0) {
                    // å¦‚æœæç¤ºå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                    if (!reviewAlert) {
                        reviewAlert = document.createElement('div');
                        reviewAlert.id = 'reviewAlert';
                        reviewAlert.className = 'alert alert-warning';
                        // æ’å…¥åˆ°è®­ç»ƒåŒºåŸŸä¹‹å‰
                        this.domCache.trainingArea.parentNode.insertBefore(reviewAlert, this.domCache.trainingArea);
                    }
                    
                    // æ›´æ–°æç¤ºå†…å®¹
                    reviewAlert.innerHTML = `
                        <strong>ä»Šæ—¥å¤ä¹ æé†’</strong>ï¼šæ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ï¼Œæ‚¨æœ‰ ${needReviewItems.length} é“é¢˜ç›®éœ€è¦å¤ä¹ ã€‚
                        è¿™äº›é¢˜ç›®å°†ä¼˜å…ˆå‡ºç°åœ¨æ‚¨çš„è®­ç»ƒä¸­ã€‚
                    `;
                } else if (reviewAlert) {
                    // å¦‚æœæ²¡æœ‰éœ€è¦å¤ä¹ çš„é¢˜ç›®äº†ï¼Œç§»é™¤æç¤º
                    reviewAlert.remove();
                }
            }
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', () => {
            new MathTrainingSystem();
        });
    </script>
</body>
</html>

    <!-- æ™ºèƒ½CDNåŠ è½½å’Œé”™è¯¯å¤„ç† -->
    <script>
        /**
         * æ™ºèƒ½CDNèµ„æºåŠ è½½å™¨
         * æä¾›CDNå¤±è´¥æ—¶çš„æœ¬åœ°å›é€€æœºåˆ¶
         */
        class SmartCDNLoader {
            constructor() {
                this.cdnUrls = {
                    bootstrap: {
                        css: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css',
                        js: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'
                    },
                    bootstrapIcons: {
                        css: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css'
                    }
                };
                this.localFallbacks = {
                    bootstrap: {
                        css: '/youeryuan/assets/css/bootstrap.min.css',
                        js: '/youeryuan/assets/js/bootstrap.bundle.min.js'
                    },
                    bootstrapIcons: {
                        css: '/youeryuan/assets/css/bootstrap-icons.css'
                    }
                };
                this.loadTimeout = 5000; // 5ç§’è¶…æ—¶
            }

            /**
             * åŠ è½½CSSèµ„æº
             * @param {string} name - èµ„æºåç§°
             * @returns {Promise} åŠ è½½ç»“æœ
             */
            async loadCSS(name) {
                const url = this.cdnUrls[name]?.css;
                const fallback = this.localFallbacks[name]?.css;
                
                if (!url) return false;

                return this.loadResource(url, fallback, 'css');
            }

            /**
             * é€šç”¨èµ„æºåŠ è½½æ–¹æ³•
             * @param {string} url - CDNèµ„æºURL
             * @param {string} fallback - æœ¬åœ°å›é€€URL
             * @param {string} type - èµ„æºç±»å‹
             * @returns {Promise} åŠ è½½ç»“æœ
             */
            async loadResource(url, fallback, type) {
                return new Promise((resolve) => {
                    const timeoutId = setTimeout(() => {
                        console.warn(`CDNèµ„æºåŠ è½½è¶…æ—¶: ${url}`);
                        this.loadFallback(fallback, type, resolve);
                    }, this.loadTimeout);

                    if (type === 'css') {
                        this.loadCSSResource(url, () => {
                            clearTimeout(timeoutId);
                            resolve(true);
                        }, () => {
                            clearTimeout(timeoutId);
                            this.loadFallback(fallback, type, resolve);
                        });
                    }
                });
            }

            /**
             * åŠ è½½CSSèµ„æº
             * @param {string} url - CSSæ–‡ä»¶URL
             * @param {Function} onSuccess - æˆåŠŸå›è°ƒ
             * @param {Function} onError - å¤±è´¥å›è°ƒ
             */
            loadCSSResource(url, onSuccess, onError) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = url;
                link.onload = onSuccess;
                link.onerror = onError;
                document.head.appendChild(link);
            }

            /**
             * åŠ è½½æœ¬åœ°å›é€€èµ„æº
             * @param {string} url - æœ¬åœ°èµ„æºURL
             * @param {string} type - èµ„æºç±»å‹
             * @param {Function} resolve - å®Œæˆå›è°ƒ
             */
            loadFallback(url, type, resolve) {
                if (!url) {
                    resolve(false);
                    return;
                }

                console.log(`åŠ è½½æœ¬åœ°å›é€€èµ„æº: ${url}`);
                
                if (type === 'css') {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = url;
                    link.onload = () => resolve(true);
                    link.onerror = () => resolve(false);
                    document.head.appendChild(link);
                } else if (type === 'js') {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => resolve(true);
                    script.onerror = () => resolve(false);
                    document.head.appendChild(script);
                }
            }

            /**
             * éªŒè¯Bootstrapæ˜¯å¦æˆåŠŸåŠ è½½
             * @returns {boolean} éªŒè¯ç»“æœ
             */
            verifyBootstrap() {
                return typeof bootstrap !== 'undefined' || 
                       (document.querySelector('.container') && 
                        getComputedStyle(document.querySelector('.container')).maxWidth !== 'none');
            }

            /**
             * éªŒè¯Bootstrap Iconsæ˜¯å¦æˆåŠŸåŠ è½½
             * @returns {boolean} éªŒè¯ç»“æœ
             */
            verifyBootstrapIcons() {
                const testElement = document.createElement('i');
                testElement.className = 'bi bi-heart';
                document.body.appendChild(testElement);
                const loaded = getComputedStyle(testElement).fontFamily?.includes('bootstrap-icons');
                document.body.removeChild(testElement);
                return loaded;
            }
        }

        // åˆå§‹åŒ–CDNåŠ è½½å™¨
        window.addEventListener('DOMContentLoaded', async () => {
            const loader = new SmartCDNLoader();
            
            // é¢„åŠ è½½å…³é”®èµ„æº
            await Promise.all([
                loader.loadCSS('bootstrap'),
                loader.loadCSS('bootstrapIcons')
            ]);
            
            // åŠ è½½Bootstrap JavaScriptèµ„æº
            const bootstrapJsLoaded = await new Promise((resolve) => {
                const timeoutId = setTimeout(() => {
                    console.warn('CDN Bootstrap JSåŠ è½½è¶…æ—¶');
                    loader.loadFallback(loader.localFallbacks.bootstrap.js, 'js', resolve);
                }, loader.loadTimeout);
                
                const url = loader.cdnUrls.bootstrap.js;
                if (url) {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => {
                        clearTimeout(timeoutId);
                        resolve(true);
                    };
                    script.onerror = () => {
                        clearTimeout(timeoutId);
                        loader.loadFallback(loader.localFallbacks.bootstrap.js, 'js', resolve);
                    };
                    document.head.appendChild(script);
                } else {
                    resolve(false);
                }
            });
            
            console.log('Bootstrap JSåŠ è½½çŠ¶æ€:', bootstrapJsLoaded);
            
            // éªŒè¯åŠ è½½ç»“æœ
            setTimeout(() => {
                if (!loader.verifyBootstrap()) {
                    console.warn('BootstrapéªŒè¯å¤±è´¥ï¼Œå°è¯•åŠ è½½å›é€€èµ„æº');
                    loader.loadFallback(loader.localFallbacks.bootstrap.css, 'css', () => {});
                }
                
                if (!loader.verifyBootstrapIcons()) {
                    console.warn('Bootstrap IconséªŒè¯å¤±è´¥ï¼Œå°è¯•åŠ è½½å›é€€èµ„æº');
                    loader.loadFallback(loader.localFallbacks.bootstrapIcons.css, 'css', () => {});
                }
            }, 1000);
        });
    </script>
</head>
    <!-- æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜æ§åˆ¶ -->
    <meta http-equiv="Cache-Control" content="max-age=31536000, public">
    <meta http-equiv="Expires" content="Sat, 31 Dec 2024 23:59:59 GMT">
    <meta name="theme-color" content="#667eea">
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æ•°å­¦è®­ç»ƒ">
</head>
    <!-- Service Workeræ³¨å†Œ -->
    <script>
        /**
         * Service Workeræ³¨å†Œ
         * æä¾›PWAç¦»çº¿æ”¯æŒå’Œç¼“å­˜ç®¡ç†
         */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/youeryuan/sw.js')
                    .then((registration) => {
                        console.log('Service Workeræ³¨å†ŒæˆåŠŸ:', registration.scope);
                        
                        // ç›‘å¬Service Workeræ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('å‘ç°æ–°ç‰ˆæœ¬çš„Service Worker');
                                    // å¯ä»¥åœ¨è¿™é‡Œæç¤ºç”¨æˆ·æ›´æ–°
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Workeræ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }
        
        /**
         * PWAå®‰è£…æç¤º
         */
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // é˜²æ­¢Chrome 67åŠæ›´æ—©ç‰ˆæœ¬è‡ªåŠ¨æ˜¾ç¤ºå®‰è£…æç¤º
            e.preventDefault();
            // ä¿å­˜äº‹ä»¶ä»¥ä¾¿ç¨åè§¦å‘
            deferredPrompt = e;
            
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰çš„å®‰è£…æç¤ºUI
            console.log('PWAå®‰è£…æç¤ºå·²å‡†å¤‡');
        });
        
        /**
         * åº”ç”¨å®‰è£…åçš„äº‹ä»¶
         */
        window.addEventListener('appinstalled', () => {
            console.log('PWAå·²å®‰è£…');
            deferredPrompt = null;
        });
    </script>
</body>
</html>