<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10ä»¥å†…è¿ç»­åŠ å‡æ³•æ··åˆè¿ç®—è®­ç»ƒ</title>
    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" href="/youeryuan/assets/images/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- å…¨å±€é”™è¯¯å¤„ç† -->
    <script>
        // å…¨å±€æœªæ•è·Promiseé”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªæ•è·çš„Promiseé”™è¯¯:', event.reason);
            // é˜²æ­¢é”™è¯¯ä¼ æ’­
            event.preventDefault();
        });
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯:', event.message, 'åœ¨', event.filename, 'ç¬¬', event.lineno, 'è¡Œ');
            // é˜²æ­¢é”™è¯¯ä¼ æ’­
            event.preventDefault();
        });
    </script>
    
    <!-- é¢„è¿æ¥å…³é”®CDNåŸŸå -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- å…³é”®CSSèµ„æºé¢„åŠ è½½ -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- å¤‡ç”¨CSSåŠ è½½ -->
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"></noscript>
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"></noscript>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 800px;
            padding: 30px;
        }
        
        .question-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(240, 147, 251, 0.3);
        }
        
        .answer-btn {
            font-size: 1.5rem;
            padding: 20px;
            margin: 10px;
            border-radius: 15px;
            border: none;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .answer-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .correct {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
            color: white;
        }
        
        .incorrect {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%) !important;
            color: white;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .daily-limit {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
        }
        
        .emoji-feedback {
            font-size: 3rem;
            margin: 20px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨transform3då¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
        .answer-btn {
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }
        
        .answer-btn:hover {
            transform: translate3d(0, -3px, 0);
        }
        
        /* é¢„åŠ è½½çŠ¶æ€ */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* é”®ç›˜å¯¼èˆªæ”¯æŒ */
        .answer-btn:focus {
            outline: 3px solid #007bff;
            outline-offset: 2px;
        }
        
        /* å‡å°‘é‡ç»˜ */
        .stats-card {
            contain: layout style paint;
        }
        

    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <h1 class="text-center mb-4">
                <i class="bi bi-calculator-fill text-primary"></i>
                åŠ å‡æ³•æ··åˆè¿ç®—è®­ç»ƒ
            </h1>
            
            <!-- è®¾ç½®é¢æ¿ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="stats-card">
                        <h5><i class="bi bi-gear-fill"></i> è®­ç»ƒè®¾ç½®</h5>
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="rangeSelect" class="form-label">æ•°å€¼èŒƒå›´ï¼š</label>
                                <select id="rangeSelect" class="form-select">
                                    <option value="10">10ä»¥å†…</option>
                                    <option value="20">20ä»¥å†…</option>
                                    <option value="50">50ä»¥å†…</option>
                                    <option value="100">100ä»¥å†…</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="operationCount" class="form-label">è¿ç®—æ¬¡æ•°ï¼š</label>
                                <select id="operationCount" class="form-select">
                                    <option value="1-2">1-2æ¬¡è¿ç®—</option>
                                    <option value="2">å›ºå®š2æ¬¡è¿ç®—</option>
                                    <option value="3">å›ºå®š3æ¬¡è¿ç®—</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                              
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card">
                        <h5><i class="bi bi-graph-up"></i> ä»Šæ—¥ç»Ÿè®¡</h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 id="todayTotal" class="text-primary">0</h3>
                                <small>æ€»é¢˜æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="todayCorrect" class="text-success">0</h3>
                                <small>æ­£ç¡®æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="todayAccuracy" class="text-warning">0%</h3>
                                <small>æ­£ç¡®ç‡</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card">
                        <h5><i class="bi bi-trophy"></i> æ€»ç»Ÿè®¡</h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 id="totalQuestions" class="text-primary">0</h3>
                                <small>æ€»é¢˜æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="totalCorrect" class="text-success">0</h3>
                                <small>æ­£ç¡®æ•°</small>
                            </div>
                            <div class="col-4">
                                <h3 id="totalAccuracy" class="text-warning">0%</h3>
                                <small>æ­£ç¡®ç‡</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ¯æ—¥é™åˆ¶æç¤º -->
            <div id="dailyLimitAlert" class="daily-limit hidden">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="limitText">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        ä»Šæ—¥è®­ç»ƒå·²è¾¾åˆ°ä¸Šé™ï¼ˆ20é¢˜ï¼‰ï¼Œæ˜å¤©å†æ¥ç»§ç»­å§ï¼
                    </div>
                    <div>
                        <button id="resetLimitBtn" class="btn btn-sm btn-warning">
                            <i class="bi bi-plus-circle"></i> å¢åŠ ä¸Šé™
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- è®­ç»ƒåŒºåŸŸ -->
             <div id="trainingArea" class="text-center">
                 <div class="question-card" id="questionCard">
                     <span id="question">å‡†å¤‡å¼€å§‹</span>
                 </div>
                 
                 <div id="answerOptions" class="row">
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionA">A</button>
                     </div>
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionB">B</button>
                     </div>
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionC">C</button>
                     </div>
                     <div class="col-6 col-md-3">
                         <button class="btn btn-primary answer-btn" id="optionD">D</button>
                     </div>
                 </div>
                 
                 <div id="feedback" class="emoji-feedback hidden"></div>
             </div>
            
            <!-- å†å²è®°å½• -->
            <div class="mt-5">
                <h4><i class="bi bi-clock-history"></i> ä»Šæ—¥ç­”é¢˜è®°å½•</h4>
                <div id="historyList" class="mt-3"></div>
            </div>
            
            <!-- æ‰€æœ‰å†å²è®°å½• -->
            <div class="mt-5">
                <h4><i class="bi bi-clock-history"></i> å†å²ç»Ÿè®¡</h4>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>ç´¯è®¡ç­”é¢˜</h5>
                            <h3 id="allTimeTotal" class="text-primary">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>æ­£ç¡®ç­”é¢˜</h5>
                            <h3 id="allTimeCorrect" class="text-success">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>æ­£ç¡®ç‡</h5>
                            <h3 id="allTimeAccuracy" class="text-warning">0%</h3>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="showAllHistoryBtn" class="btn btn-info">
                        <i class="bi bi-list"></i> æŸ¥çœ‹è¯¦ç»†å†å²è®°å½•
                    </button>
                    <div id="allHistoryContainer" class="mt-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>è¯¦ç»†å†å²è®°å½•</h5>
                            <button id="hideAllHistoryBtn" class="btn btn-sm btn-secondary">
                                <i class="bi bi-eye-slash"></i> éšè—
                            </button>
                        </div>
                        <div id="allHistoryList"></div>
                    </div>
                </div>
            </div>
            
            <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
            <div class="text-center mt-4">
                <a href="index.html" class="btn btn-outline-secondary">
                    <i class="bi bi-house-door"></i> è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>
    </div>

    <!-- å¼‚æ­¥åŠ è½½Bootstrap JSï¼Œå¸¦ç¼“å­˜å’Œé”™è¯¯å¤„ç† -->
    <script>
        /**
         * å¼‚æ­¥åŠ è½½Bootstrap Bundle JS
         * ä½¿ç”¨CDNå¤±è´¥æ—¶çš„æœ¬åœ°å›é€€æœºåˆ¶
         */
        (function() {
            const cdnUrl = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
            const fallbackUrl = '/assets/js/bootstrap.bundle.min.js';
            
            // åˆ›å»ºè„šæœ¬å…ƒç´ 
            const script = document.createElement('script');
            script.src = cdnUrl;
            script.async = true;
            script.crossOrigin = 'anonymous';
            
            // è®¾ç½®åŠ è½½è¶…æ—¶
            const timeout = setTimeout(() => {
                console.warn('Bootstrap JS CDNåŠ è½½è¶…æ—¶ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°å›é€€');
                loadFallback();
            }, 5000);
            
            // æˆåŠŸåŠ è½½
            script.onload = () => {
                clearTimeout(timeout);
                console.log('Bootstrap JS CDNåŠ è½½æˆåŠŸ');
            };
            
            // åŠ è½½å¤±è´¥
            script.onerror = () => {
                clearTimeout(timeout);
                console.warn('Bootstrap JS CDNåŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°å›é€€');
                loadFallback();
            };
            
            // åŠ è½½æœ¬åœ°å›é€€
            function loadFallback() {
                const fallbackScript = document.createElement('script');
                fallbackScript.src = fallbackUrl;
                fallbackScript.async = true;
                document.head.appendChild(fallbackScript);
            }
            
            document.head.appendChild(script);
        })();
    </script>
    <script>
        /**
         * 10ä»¥å†…è¿ç»­åŠ å‡æ³•æ··åˆè¿ç®—è®­ç»ƒç³»ç»Ÿ
         * åŠŸèƒ½ï¼šæ™ºèƒ½å‡ºé¢˜ã€å†å²è®°å½•ã€æ¯æ—¥é™åˆ¶ã€å®æ—¶åé¦ˆ
         */
        class MixedMathTrainingSystem {
            constructor() {
                this.dailyLimit = 20; // æ¯æ—¥è®­ç»ƒä¸Šé™
                this.currentQuestion = null;
                this.answers = [];
                this.history = this.loadHistory();
                this.today = new Date().toISOString().split('T')[0];
                
                // è®­ç»ƒè®¾ç½®
                this.settings = this.loadSettings();
                this.maxNumber = this.settings.range || 10;
                this.operationMode = this.settings.operationCount || '1-2';
                
                // æ€§èƒ½ä¼˜åŒ–ï¼šé¢„è®¡ç®—ç»Ÿè®¡æ•°æ®
                this.statsCache = {
                    todayHistory: null,
                    todayStats: null,
                    allTimeStats: null,
                    lastUpdateTime: 0
                };
                
                // ç¼“å­˜DOMå…ƒç´ ä»¥æé«˜æ€§èƒ½
                this.domCache = this.initializeDOMCache();
                
                // ç¼“å­˜ä»Šæ—¥å†å²è®°å½•ä»¥é¿å…é‡å¤è¿‡æ»¤
                this.updateStatsCache();
                
                // é˜²æŠ–å‡½æ•°ç¼“å­˜
                this.debouncedUpdateHistory = this.debounce(this.updateHistoryList.bind(this), 100);
                
                // é”®ç›˜å¯¼èˆªæ”¯æŒ
                this.currentFocusIndex = 0;
                this.answerButtons = [
                    this.domCache.optionA, 
                    this.domCache.optionB, 
                    this.domCache.optionC, 
                    this.domCache.optionD
                ];
                
                this.initializeEventListeners();
                this.initializeSettingsUI(); // åˆå§‹åŒ–è®¾ç½®UI
                this.updateStats();
                this.updateAllTimeStats();
                this.updateHistoryList();
                
                // æ£€æŸ¥æ¯æ—¥è®­ç»ƒä¸Šé™å¹¶è‡ªåŠ¨å¼€å§‹è®­ç»ƒ
                const isLimited = this.checkDailyLimit();
                if (!isLimited) {
                    // å»¶è¿Ÿå¯åŠ¨ä»¥æå‡æ„ŸçŸ¥æ€§èƒ½
                    requestAnimationFrame(() => this.startTraining());
                }
            }
            
            /**
             * åˆå§‹åŒ–DOMç¼“å­˜
             */
            initializeDOMCache() {
                const elements = [
                    'dailyLimitAlert', 'trainingArea', 'answerOptions', 'feedback',
                    'historyList', 'question', 'optionA', 'optionB', 'optionC', 'optionD',
                    'todayTotal', 'todayCorrect', 'todayAccuracy', 'totalQuestions',
                    'totalCorrect', 'totalAccuracy', 'allTimeTotal', 'allTimeCorrect',
                    'allTimeAccuracy', 'showAllHistoryBtn', 'hideAllHistoryBtn',
                    'allHistoryContainer', 'allHistoryList'
                ];
                
                const cache = {};
                elements.forEach(id => {
                    cache[id] = document.getElementById(id);
                });
                
                return cache;
            }
            
            /**
             * æ›´æ–°ç»Ÿè®¡ç¼“å­˜
             */
            updateStatsCache() {
                const now = Date.now();
                // ç¼“å­˜æœ‰æ•ˆæœŸï¼š100msï¼Œé¿å…é¢‘ç¹è®¡ç®—
                if (now - this.statsCache.lastUpdateTime < 100) {
                    return;
                }
                
                this.statsCache.todayHistory = this.history.filter(h => h.date === this.today);
                
                const todayCorrect = this.statsCache.todayHistory.filter(h => h.correct).length;
                const todayTotal = this.statsCache.todayHistory.length;
                
                const allCorrect = this.history.filter(h => h.correct).length;
                const allTotal = this.history.length;
                
                this.statsCache.todayStats = {
                    total: todayTotal,
                    correct: todayCorrect,
                    accuracy: todayTotal > 0 ? Math.round((todayCorrect / todayTotal) * 100) : 0
                };
                
                this.statsCache.allTimeStats = {
                    total: allTotal,
                    correct: allCorrect,
                    accuracy: allTotal > 0 ? Math.round((allCorrect / allTotal) * 100) : 0
                };
                
                this.statsCache.lastUpdateTime = now;
            }
            
            /**
             * é˜²æŠ–å‡½æ•°
             */
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            /**
             * åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
             */
            initializeEventListeners() {
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–æ€§èƒ½ï¼Œæ·»åŠ é˜²æŠ–å¤„ç†
                this.domCache.answerOptions.addEventListener('click', this.debounce((e) => {
                    if (e.target.classList.contains('answer-btn') && !e.target.disabled) {
                        this.checkAnswer(e.target);
                    }
                }, 200));
                
                // é”®ç›˜å¯¼èˆªæ”¯æŒ
                document.addEventListener('keydown', (e) => {
                    if (this.domCache.trainingArea.classList.contains('hidden')) return;
                    
                    switch(e.key) {
                        case '1':
                        case 'a':
                        case 'A':
                            e.preventDefault();
                            this.selectAnswer(0);
                            break;
                        case '2':
                        case 'b':
                        case 'B':
                            e.preventDefault();
                            this.selectAnswer(1);
                            break;
                        case '3':
                        case 'c':
                        case 'C':
                            e.preventDefault();
                            this.selectAnswer(2);
                            break;
                        case '4':
                        case 'd':
                        case 'D':
                            e.preventDefault();
                            this.selectAnswer(3);
                            break;
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            this.navigateAnswers(-1);
                            break;
                        case 'ArrowRight':
                        case 'ArrowDown':
                            e.preventDefault();
                            this.navigateAnswers(1);
                            break;
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            if (this.answerButtons[this.currentFocusIndex] && !this.answerButtons[this.currentFocusIndex].disabled) {
                                this.checkAnswer(this.answerButtons[this.currentFocusIndex]);
                            }
                            break;
                    }
                });
                
                // æ·»åŠ é‡ç½®æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                const resetLimitBtn = document.getElementById('resetLimitBtn');
                if (resetLimitBtn) {
                    resetLimitBtn.addEventListener('click', () => this.resetDailyLimit());
                }
                
                // æ·»åŠ å†å²è®°å½•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ï¼ˆå»¶è¿ŸåŠ è½½ä¼˜åŒ–ï¼‰
                this.domCache.showAllHistoryBtn.addEventListener('click', () => {
                    this.domCache.allHistoryContainer.style.display = 'block';
                    // å»¶è¿ŸåŠ è½½å†å²è®°å½•ä»¥æå‡æ€§èƒ½
                    requestAnimationFrame(() => this.updateAllHistoryList());
                });
                
                this.domCache.hideAllHistoryBtn.addEventListener('click', () => {
                    this.domCache.allHistoryContainer.style.display = 'none';
                });
                
                // è®¾ç½®ç›¸å…³äº‹ä»¶ç›‘å¬å™¨ - è‡ªåŠ¨ä¿å­˜å’Œåº”ç”¨
                const rangeSelect = document.getElementById('rangeSelect');
                const operationCountSelect = document.getElementById('operationCount');
                
                if (rangeSelect) {
                    rangeSelect.addEventListener('change', () => this.autoApplySettings());
                }
                
                if (operationCountSelect) {
                    operationCountSelect.addEventListener('change', () => this.autoApplySettings());
                }
                
                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æš‚åœ/æ¢å¤
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        // é¡µé¢éšè—æ—¶å¯ä»¥åšä¸€äº›æ¸…ç†å·¥ä½œ
                        this.saveHistory();
                        this.saveSettings();
                    }
                });
            }
            
            /**
             * åŠ è½½è®¾ç½®
             */
            loadSettings() {
                const saved = localStorage.getItem('mixedMathTrainingSettings');
                const defaultSettings = {
                    range: 10,
                    operationCount: '1-2'
                };
                return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            }
            
            /**
             * ä¿å­˜è®¾ç½®
             */
            saveSettings() {
                localStorage.setItem('mixedMathTrainingSettings', JSON.stringify(this.settings));
            }
            
            /**
             * è‡ªåŠ¨åº”ç”¨è®¾ç½®ï¼ˆæ— éœ€æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®ï¼‰
             */
            autoApplySettings() {
                const rangeSelect = document.getElementById('rangeSelect');
                const operationCountSelect = document.getElementById('operationCount');
                
                if (rangeSelect && operationCountSelect) {
                    const newRange = parseInt(rangeSelect.value);
                    const newOperationCount = operationCountSelect.value;
                    
                    // æ›´æ–°è®¾ç½®
                    this.settings.range = newRange;
                    this.settings.operationCount = newOperationCount;
                    this.maxNumber = newRange;
                    this.operationMode = newOperationCount;
                    
                    // è‡ªåŠ¨ä¿å­˜è®¾ç½®
                    this.saveSettings();
                    
                    // æ›´æ–°æ ‡é¢˜
                    const titleRange = document.getElementById('titleRange');
                    if (titleRange) {
                        titleRange.textContent = newRange;
                    }
                    
                    // æ˜¾ç¤ºè®¾ç½®è‡ªåŠ¨åº”ç”¨çš„åé¦ˆ
                    this.showFeedback(`âš¡ è®¾ç½®å·²è‡ªåŠ¨æ›´æ–°ï¼š${newRange}ä»¥å†…è¿ç®—`, 'info');
                    
                    // å¦‚æœå½“å‰æœ‰é¢˜ç›®ä¸”æœªè¾¾åˆ°é™åˆ¶ï¼Œç«‹å³ç”Ÿæˆæ–°é¢˜ç›®
                    if (!this.checkDailyLimit()) {
                        // ä½¿ç”¨è¾ƒçŸ­çš„å»¶è¿Ÿä»¥æä¾›æ›´æµç•…çš„ä½“éªŒ
                        setTimeout(() => {
                            this.generateNextQuestion();
                        }, 500);
                    }
                }
            }
            
            /**
             * åˆå§‹åŒ–è®¾ç½®UI
             */
            initializeSettingsUI() {
                const rangeSelect = document.getElementById('rangeSelect');
                const operationCountSelect = document.getElementById('operationCount');
                const titleRange = document.getElementById('titleRange');
                
                if (rangeSelect) {
                    rangeSelect.value = this.settings.range.toString();
                }
                
                if (operationCountSelect) {
                    operationCountSelect.value = this.settings.operationCount;
                }
                
                if (titleRange) {
                    titleRange.textContent = this.settings.range;
                }
            }
            
            /**
             * é”®ç›˜å¯¼èˆªé€‰æ‹©ç­”æ¡ˆ
             */
            selectAnswer(index) {
                if (index >= 0 && index < this.answerButtons.length && !this.answerButtons[index].disabled) {
                    this.checkAnswer(this.answerButtons[index]);
                }
            }
            
            /**
             * é”®ç›˜å¯¼èˆªç­”æ¡ˆé€‰é¡¹
             */
            navigateAnswers(direction) {
                // ç§»é™¤å½“å‰ç„¦ç‚¹
                this.answerButtons[this.currentFocusIndex].blur();
                
                // è®¡ç®—æ–°çš„ç„¦ç‚¹ç´¢å¼•
                this.currentFocusIndex = (this.currentFocusIndex + direction + this.answerButtons.length) % this.answerButtons.length;
                
                // è®¾ç½®æ–°ç„¦ç‚¹
                this.answerButtons[this.currentFocusIndex].focus();
            }
            
            /**
             * æ£€æŸ¥æ¯æ—¥è®­ç»ƒä¸Šé™ï¼ˆæ”¯æŒé¢å¤–å¢åŠ çš„é¢˜ç›®æ•°é‡ï¼‰
             */
            checkDailyLimit() {
                // ä½¿ç”¨ç¼“å­˜çš„ç»Ÿè®¡æ•°æ®
                this.updateStatsCache();
                const todayTotal = this.statsCache.todayStats.total;
                
                // è·å–é¢å¤–å¢åŠ çš„é¢˜ç›®æ•°é‡
                const extraKey = `mixedMathTrainingExtra_${this.today}`;
                const extraCount = parseInt(localStorage.getItem(extraKey) || '0');
                
                // è®¡ç®—å®é™…çš„ä¸Šé™ï¼ˆåŸºç¡€ä¸Šé™ + é¢å¤–å¢åŠ çš„é¢˜ç›®ï¼‰
                const actualLimit = this.dailyLimit + extraCount;
                
                // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²è¾¾åˆ°è®­ç»ƒä¸Šé™
                if (todayTotal >= actualLimit) {
                    // æ‰¹é‡DOMæ“ä½œä»¥æå‡æ€§èƒ½
                    requestAnimationFrame(() => {
                        this.domCache.dailyLimitAlert.classList.remove('hidden');
                        this.domCache.trainingArea.classList.add('hidden');
                        this.domCache.answerOptions.classList.add('hidden');
                        
                        // æ›´æ–°æç¤ºä¿¡æ¯
                        const limitText = document.getElementById('limitText');
                        if (limitText) {
                            const message = extraCount > 0 
                                ? `<i class="bi bi-exclamation-triangle-fill"></i> ä»Šæ—¥å·²ç­”${todayTotal}é¢˜ï¼Œå·²è¾¾åˆ°${actualLimit}é¢˜ä¸Šé™ï¼ˆå«${extraCount}é“é¢å¤–é¢˜ç›®ï¼‰ï¼`
                                : `<i class="bi bi-exclamation-triangle-fill"></i> ä»Šæ—¥è®­ç»ƒå·²è¾¾åˆ°ä¸Šé™ï¼ˆ${this.dailyLimit}é¢˜ï¼‰ï¼Œæ˜å¤©å†æ¥ç»§ç»­å§ï¼`;
                            limitText.innerHTML = message;
                        }
                    });
                    
                    return true; // å·²è¾¾åˆ°é™åˆ¶
                } else {
                    // æœªè¾¾åˆ°ä¸Šé™ï¼Œæ‰¹é‡DOMæ“ä½œ
                    requestAnimationFrame(() => {
                        this.domCache.dailyLimitAlert.classList.add('hidden');
                        this.domCache.trainingArea.classList.remove('hidden');
                        this.domCache.answerOptions.classList.remove('hidden');
                    });
                    
                    return false; // æœªè¾¾åˆ°é™åˆ¶
                }
            }
            
            /**
             * å¢åŠ å½“æ—¥è®­ç»ƒä¸Šé™ï¼ˆæ¯æ¬¡å¢åŠ 10é“é¢˜ï¼‰
             */
            resetDailyLimit() {
                // ç¡®è®¤ç”¨æˆ·æ˜¯å¦è¦å¢åŠ è®­ç»ƒä¸Šé™
                if (confirm(`ç¡®å®šè¦å¢åŠ ä»Šæ—¥è®­ç»ƒä¸Šé™å—ï¼Ÿå°†é¢å¤–å¢åŠ 10é“é¢˜ï¼ˆå½“å‰å·²ç­”ï¼š${this.todayHistory.length}é“ï¼‰`)) {
                    // åœ¨localStorageä¸­å­˜å‚¨å¢åŠ çš„é¢˜ç›®æ•°é‡
                    const extraKey = `mixedMathTrainingExtra_${this.today}`;
                    let extraCount = parseInt(localStorage.getItem(extraKey) || '0');
                    extraCount += 10; // æ¯æ¬¡å¢åŠ 10é“é¢˜
                    localStorage.setItem(extraKey, extraCount.toString());
                    
                    // éšè—æ¯æ—¥é™åˆ¶æç¤º
                    this.domCache.dailyLimitAlert.classList.add('hidden');
                    
                    // æ˜¾ç¤ºè®­ç»ƒåŒºåŸŸ
                    this.domCache.trainingArea.classList.remove('hidden');
                    
                    // æ˜¾ç¤ºå¢åŠ æˆåŠŸçš„åé¦ˆ
                    this.showFeedback(`âœ… ä»Šæ—¥è®­ç»ƒä¸Šé™å·²å¢åŠ 10é“é¢˜ï¼ï¼ˆé¢å¤–ï¼š${extraCount}é“ï¼‰`, 'success');
                    
                    // ç”Ÿæˆç¬¬ä¸€é¢˜
                    this.generateNextQuestion();
                }
            }
            
            /**
             * å¼€å§‹è®­ç»ƒ
             */
            startTraining() {
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¯æ—¥é™åˆ¶
                const isLimited = this.checkDailyLimit();
                
                // å¦‚æœæœªè¾¾åˆ°é™åˆ¶ï¼Œåˆ™å¼€å§‹è®­ç»ƒ
                if (!isLimited) {
                    // æ˜¾ç¤ºç­”æ¡ˆé€‰é¡¹åŒºåŸŸ
                    this.domCache.answerOptions.classList.remove('hidden');
                    // ç”Ÿæˆç¬¬ä¸€ä¸ªé—®é¢˜
                    this.generateNextQuestion();
                }
            }
            
            /**
             * ç”Ÿæˆæ··åˆè¿ç®—é¢˜ç›®ï¼ˆæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰èŒƒå›´ï¼Œç¡®ä¿ç»“æœä¸ä¸ºè´Ÿæ•°ï¼‰
             */
            generateMixedQuestion() {
                const maxAttempts = 50; // æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯
                let attempts = 0;
                
                while (attempts < maxAttempts) {
                    attempts++;
                    
                    try {
                        // æ ¹æ®è®¾ç½®å†³å®šè¿ç®—æ¬¡æ•°
                        let operationCount;
                        if (this.operationMode === '1-2') {
                            operationCount = Math.random() > 0.3 ? 2 : 1; // 70%æ¦‚ç‡æ˜¯2æ¬¡è¿ç®—
                        } else if (this.operationMode === '2') {
                            operationCount = 2;
                        } else if (this.operationMode === '3') {
                            operationCount = 3;
                        } else {
                            operationCount = 2; // é»˜è®¤2æ¬¡è¿ç®—
                        }
                        
                        const result = this.generateValidQuestion(operationCount);
                        if (result && result.answer >= 0 && result.answer <= this.maxNumber) {
                            return result;
                        }
                    } catch (error) {
                        console.debug('é¢˜ç›®ç”Ÿæˆå°è¯•å¤±è´¥:', error);
                    }
                }
                
                // å¦‚æœå¤šæ¬¡å°è¯•å¤±è´¥ï¼Œç”Ÿæˆä¸€ä¸ªç®€å•çš„åŠ æ³•é¢˜ç›®ä½œä¸ºå¤‡ç”¨
                console.warn('é¢˜ç›®ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨é¢˜ç›®');
                return this.generateFallbackQuestion();
            }
            
            /**
             * ç”Ÿæˆæœ‰æ•ˆçš„é¢˜ç›®
             */
            generateValidQuestion(operationCount) {
                if (operationCount === 1) {
                    return this.generateSingleOperation();
                } else if (operationCount === 2) {
                    return this.generateDoubleOperation();
                } else if (operationCount === 3) {
                    return this.generateTripleOperation();
                }
                return null;
            }
            
            /**
             * ç”Ÿæˆå•æ¬¡è¿ç®—é¢˜ç›®
             */
            generateSingleOperation() {
                const isAddition = Math.random() > 0.5;
                let num1, num2, answer, question, type;
                
                if (isAddition) {
                    // åŠ æ³•ï¼šç¡®ä¿ç»“æœä¸è¶…è¿‡æœ€å¤§å€¼
                    num1 = Math.floor(Math.random() * this.maxNumber) + 1;
                    const maxNum2 = this.maxNumber - num1;
                    if (maxNum2 <= 0) {
                        num2 = 1;
                        num1 = this.maxNumber - 1;
                    } else {
                        num2 = Math.floor(Math.random() * maxNum2) + 1;
                    }
                    answer = num1 + num2;
                    question = `${num1} + ${num2} = ?`;
                    type = 'single_addition';
                } else {
                    // å‡æ³•ï¼šç¡®ä¿ç»“æœä¸ä¸ºè´Ÿæ•°
                    num1 = Math.floor(Math.random() * this.maxNumber) + 2; // è‡³å°‘ä¸º2
                    num2 = Math.floor(Math.random() * (num1 - 1)) + 1; // ç¡®ä¿num2 < num1
                    answer = num1 - num2;
                    question = `${num1} - ${num2} = ?`;
                    type = 'single_subtraction';
                }
                
                return { question, answer, num1, num2, type, operationCount: 1 };
            }
            
            /**
             * ç”Ÿæˆä¸¤æ¬¡è¿ç®—é¢˜ç›®
             */
            generateDoubleOperation() {
                // éšæœºé€‰æ‹©è¿ç®—ç¬¦ç»„åˆ
                const operations = ['+', '-'];
                const op1 = operations[Math.floor(Math.random() * operations.length)];
                const op2 = operations[Math.floor(Math.random() * operations.length)];
                
                // ä»ç»“æœåæ¨ï¼Œç¡®ä¿æ‰€æœ‰ä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœéƒ½æœ‰æ•ˆ
                const finalAnswer = Math.floor(Math.random() * this.maxNumber) + 1;
                
                let num1, num2, num3, firstResult;
                
                // æ ¹æ®ç¬¬äºŒä¸ªè¿ç®—ç¬¦ç¡®å®šç¬¬ä¸‰ä¸ªæ•°å­—å’Œç¬¬ä¸€æ­¥ç»“æœ
                if (op2 === '+') {
                    // å¦‚æœç¬¬äºŒæ­¥æ˜¯åŠ æ³•ï¼šfirstResult + num3 = finalAnswer
                    num3 = Math.floor(Math.random() * Math.min(finalAnswer, this.maxNumber)) + 1;
                    firstResult = finalAnswer - num3;
                } else {
                    // å¦‚æœç¬¬äºŒæ­¥æ˜¯å‡æ³•ï¼šfirstResult - num3 = finalAnswer
                    const maxNum3 = Math.min(this.maxNumber - finalAnswer, this.maxNumber);
                    num3 = Math.floor(Math.random() * maxNum3) + 1;
                    firstResult = finalAnswer + num3;
                }
                
                // ç¡®ä¿ç¬¬ä¸€æ­¥ç»“æœæœ‰æ•ˆ
                if (firstResult <= 0 || firstResult > this.maxNumber) {
                    return null;
                }
                
                // æ ¹æ®ç¬¬ä¸€ä¸ªè¿ç®—ç¬¦ç¡®å®šå‰ä¸¤ä¸ªæ•°å­—
                if (op1 === '+') {
                    // å¦‚æœç¬¬ä¸€æ­¥æ˜¯åŠ æ³•ï¼šnum1 + num2 = firstResult
                    num1 = Math.floor(Math.random() * Math.min(firstResult, this.maxNumber)) + 1;
                    num2 = firstResult - num1;
                } else {
                    // å¦‚æœç¬¬ä¸€æ­¥æ˜¯å‡æ³•ï¼šnum1 - num2 = firstResult
                    const maxNum1 = Math.min(firstResult + this.maxNumber, this.maxNumber);
                    num1 = Math.floor(Math.random() * (maxNum1 - firstResult)) + firstResult + 1;
                    num2 = num1 - firstResult;
                }
                
                // éªŒè¯æ‰€æœ‰æ•°å­—éƒ½åœ¨æœ‰æ•ˆèŒƒå›´å†…
                if (num1 <= 0 || num1 > this.maxNumber || 
                    num2 <= 0 || num2 > this.maxNumber || 
                    num3 <= 0 || num3 > this.maxNumber) {
                    return null;
                }
                
                const question = `${num1} ${op1} ${num2} ${op2} ${num3} = ?`;
                const type = `mixed_${op1 === '+' ? 'add' : 'sub'}_${op2 === '+' ? 'add' : 'sub'}`;
                
                return { 
                    question, 
                    answer: finalAnswer, 
                    num1, num2, num3, 
                    op1, op2, 
                    type, 
                    operationCount: 2 
                };
            }
            
            /**
             * ç”Ÿæˆä¸‰æ¬¡è¿ç®—é¢˜ç›®
             */
            generateTripleOperation() {
                const operations = ['+', '-'];
                const op1 = operations[Math.floor(Math.random() * operations.length)];
                const op2 = operations[Math.floor(Math.random() * operations.length)];
                const op3 = operations[Math.floor(Math.random() * operations.length)];
                
                // ä»ç»“æœåæ¨ï¼Œç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½æœ‰æ•ˆ
                const finalAnswer = Math.floor(Math.random() * this.maxNumber) + 1;
                
                // ç®€åŒ–å¤„ç†ï¼šç”Ÿæˆè¾ƒå°çš„æ•°å­—ä»¥ç¡®ä¿è®¡ç®—æœ‰æ•ˆ
                const maxSingleNum = Math.min(Math.floor(this.maxNumber / 3), 10);
                
                let num1 = Math.floor(Math.random() * maxSingleNum) + 1;
                let num2 = Math.floor(Math.random() * maxSingleNum) + 1;
                let num3 = Math.floor(Math.random() * maxSingleNum) + 1;
                let num4 = Math.floor(Math.random() * maxSingleNum) + 1;
                
                // è®¡ç®—ä¸­é—´ç»“æœ
                let firstResult = op1 === '+' ? num1 + num2 : Math.max(num1 - num2, 1);
                let secondResult = op2 === '+' ? firstResult + num3 : Math.max(firstResult - num3, 1);
                let finalResult = op3 === '+' ? secondResult + num4 : Math.max(secondResult - num4, 1);
                
                // å¦‚æœç»“æœè¶…å‡ºèŒƒå›´ï¼Œè°ƒæ•´æ•°å­—
                if (finalResult > this.maxNumber) {
                    return null;
                }
                
                const question = `${num1} ${op1} ${num2} ${op2} ${num3} ${op3} ${num4} = ?`;
                const type = `triple_${op1 === '+' ? 'add' : 'sub'}_${op2 === '+' ? 'add' : 'sub'}_${op3 === '+' ? 'add' : 'sub'}`;
                
                return { 
                    question, 
                    answer: finalResult, 
                    num1, num2, num3, num4,
                    op1, op2, op3,
                    type, 
                    operationCount: 3 
                };
            }
            
            /**
             * ç”Ÿæˆå¤‡ç”¨é¢˜ç›®ï¼ˆç®€å•åŠ æ³•ï¼‰
             */
            generateFallbackQuestion() {
                const num1 = Math.floor(Math.random() * Math.floor(this.maxNumber / 2)) + 1;
                const num2 = Math.floor(Math.random() * (this.maxNumber - num1)) + 1;
                const answer = num1 + num2;
                const question = `${num1} + ${num2} = ?`;
                
                return { 
                    question, 
                    answer, 
                    num1, 
                    num2, 
                    type: 'fallback_addition', 
                    operationCount: 1 
                };
            }
            
            /**
             * ç”Ÿæˆå…·æœ‰è¿·æƒ‘æ€§çš„å¹²æ‰°é€‰é¡¹ï¼ˆæ”¯æŒè‡ªå®šä¹‰èŒƒå›´ï¼‰
             */
            generateOptions(correctAnswer) {
                const options = [correctAnswer];
                const maxAttempts = 20; // é˜²æ­¢æ— é™å¾ªç¯
                let attempts = 0;
                
                while (options.length < 4 && attempts < maxAttempts) {
                    attempts++;
                    let wrongOption;
                    const mistakeType = Math.random();
                    
                    if (mistakeType < 0.3) {
                        // ç›¸é‚»æ•°å­—é”™è¯¯ï¼ˆÂ±1æˆ–Â±2ï¼‰
                        const offset = Math.random() > 0.5 ? 
                            (Math.random() > 0.5 ? 1 : 2) : 
                            (Math.random() > 0.5 ? -1 : -2);
                        wrongOption = correctAnswer + offset;
                    } else if (mistakeType < 0.6) {
                        // è¿ç®—é”™è¯¯ï¼ˆå¯èƒ½çš„è®¡ç®—é”™è¯¯ï¼‰
                        const errorRange = Math.max(3, Math.floor(this.maxNumber * 0.1));
                        const offset = Math.floor(Math.random() * errorRange * 2) - errorRange;
                        wrongOption = correctAnswer + offset;
                    } else if (mistakeType < 0.8) {
                        // åŸºäºæ­£ç¡®ç­”æ¡ˆçš„å€æ•°æˆ–åˆ†æ•°é”™è¯¯
                        if (correctAnswer > 1) {
                            wrongOption = Math.random() > 0.5 ? 
                                Math.floor(correctAnswer * 1.5) : 
                                Math.floor(correctAnswer * 0.5);
                        } else {
                            wrongOption = correctAnswer + Math.floor(Math.random() * 5) + 1;
                        }
                    } else {
                        // éšæœºé”™è¯¯ï¼ˆåœ¨åˆç†èŒƒå›´å†…ï¼‰
                        wrongOption = Math.floor(Math.random() * Math.min(this.maxNumber + 1, correctAnswer + 10));
                    }
                    
                    // ç¡®ä¿é€‰é¡¹åœ¨åˆç†èŒƒå›´å†…ä¸”å”¯ä¸€
                    wrongOption = Math.max(0, Math.min(this.maxNumber, wrongOption));
                    
                    // é¿å…ä¸æ­£ç¡®ç­”æ¡ˆç›¸åŒï¼Œä¸”ç¡®ä¿é€‰é¡¹å”¯ä¸€
                    if (wrongOption !== correctAnswer && !options.includes(wrongOption)) {
                        options.push(wrongOption);
                    }
                }
                
                // å¦‚æœä»ç„¶æ²¡æœ‰è¶³å¤Ÿçš„é€‰é¡¹ï¼Œè¡¥å……ä¸€äº›ç®€å•çš„é”™è¯¯é€‰é¡¹
                while (options.length < 4) {
                    const simpleWrong = Math.floor(Math.random() * (this.maxNumber + 1));
                    if (!options.includes(simpleWrong)) {
                        options.push(simpleWrong);
                    }
                }
                
                return this.shuffleArray(options);
            }
            
            /**
             * æ˜¾ç¤ºé¢˜ç›®
             */
            displayQuestion() {
                // ç›´æ¥æ˜¾ç¤ºé¢˜ç›®æ–‡æœ¬ï¼Œä¿æŒç®€æ´æ¸…æ™°
                this.domCache.question.textContent = this.currentQuestion.question;
                
                const options = this.generateOptions(this.currentQuestion.answer);
                const buttons = [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD];
                
                buttons.forEach((button, index) => {
                    button.textContent = options[index];
                    button.className = 'btn btn-primary answer-btn';
                    button.disabled = false;
                });
            }
            
            /**
             * æ£€æŸ¥ç­”æ¡ˆï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
             */
            checkAnswer(button) {
                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if (button.disabled || button.classList.contains('correct') || button.classList.contains('incorrect')) {
                    return;
                }
                
                const selectedAnswer = parseInt(button.textContent);
                const isCorrect = selectedAnswer === this.currentQuestion.answer;
                
                // ç«‹å³ç¦ç”¨æ‰€æœ‰æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                this.disableAnswerButtons();
                
                // æ‰¹é‡DOMæ“ä½œä»¥æå‡æ€§èƒ½
                requestAnimationFrame(() => {
                    if (isCorrect) {
                        button.classList.add('correct');
                        this.showFeedback('ğŸ‰ å¤ªæ£’äº†ï¼', 'success');
                        // æ·»åŠ æˆåŠŸéŸ³æ•ˆæç¤ºï¼ˆå¦‚æœæ”¯æŒï¼‰
                        this.playFeedbackSound('success');
                    } else {
                        button.classList.add('incorrect');
                        // é«˜æ•ˆæŸ¥æ‰¾å¹¶æ ‡è®°æ­£ç¡®ç­”æ¡ˆ
                        this.answerButtons.forEach(btn => {
                            if (parseInt(btn.textContent) === this.currentQuestion.answer) {
                                btn.classList.add('correct');
                            }
                        });
                        this.showFeedback('ğŸ’ª å†è¯•ä¸€æ¬¡ï¼', 'danger');
                        // æ·»åŠ é”™è¯¯éŸ³æ•ˆæç¤ºï¼ˆå¦‚æœæ”¯æŒï¼‰
                        this.playFeedbackSound('error');
                    }
                });
                
                // è®°å½•ç­”é¢˜å†å²
                this.recordAnswer(isCorrect, selectedAnswer);
                
                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–å»¶è¿Ÿå¤„ç†
                setTimeout(() => {
                    requestAnimationFrame(() => {
                        const isLimited = this.checkDailyLimit();
                        if (!isLimited) {
                            this.generateNextQuestion();
                        }
                    });
                }, 1000);
            }
            
            /**
             * æ’­æ”¾åé¦ˆéŸ³æ•ˆï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
             */
            playFeedbackSound(type) {
                try {
                    // ä½¿ç”¨Web Audio APIåˆ›å»ºç®€å•çš„åé¦ˆéŸ³æ•ˆ
                    if (window.AudioContext || window.webkitAudioContext) {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        if (type === 'success') {
                            // æˆåŠŸéŸ³æ•ˆï¼šé«˜éŸ³è°ƒ
                            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                        } else {
                            // é”™è¯¯éŸ³æ•ˆï¼šä½éŸ³è°ƒ
                            oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                        }
                        
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.2);
                    }
                } catch (error) {
                    // é™é»˜å¤„ç†éŸ³æ•ˆé”™è¯¯
                    console.debug('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
                }
            }

            /**
             * ç”Ÿæˆä¸‹ä¸€é¢˜
             */
            generateNextQuestion() {
                this.currentQuestion = this.generateMixedQuestion();
                this.displayQuestion();
                
                // éšè—åé¦ˆä¿¡æ¯
                this.domCache.feedback.classList.add('hidden');
                
                // å¯ç”¨ç­”æ¡ˆæŒ‰é’®
                this.enableAnswerButtons();
            }
            
            /**
             * è®°å½•ç­”é¢˜å†å²ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
             */
            recordAnswer(isCorrect, selectedAnswer) {
                const record = {
                    date: this.today,
                    time: new Date().toLocaleTimeString(),
                    question: this.currentQuestion.question,
                    correctAnswer: this.currentQuestion.answer,
                    selectedAnswer: selectedAnswer,
                    correct: isCorrect,
                    type: this.currentQuestion.type || 'mixed_operation',
                    operationCount: this.currentQuestion.operationCount || 2
                };
                
                this.history.push(record);
                
                // å¼‚æ­¥ä¿å­˜å†å²è®°å½•ä»¥é¿å…é˜»å¡UI
                requestIdleCallback(() => {
                    this.saveHistory();
                }, { timeout: 1000 });
                
                // æ‰¹é‡æ›´æ–°UI
                this.updateStatsCache(); // ç«‹å³æ›´æ–°ç¼“å­˜
                this.updateStats();
                this.updateAllTimeStats();
                this.debouncedUpdateHistory(); // ä½¿ç”¨é˜²æŠ–æ›´æ–°å†å²è®°å½•
            }
            
            /**
             * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
             */
            updateStats() {
                // ä½¿ç”¨ç¼“å­˜çš„ç»Ÿè®¡æ•°æ®
                this.updateStatsCache();
                const todayStats = this.statsCache.todayStats;
                const allTimeStats = this.statsCache.allTimeStats;
                
                // æ‰¹é‡DOMæ›´æ–°ä»¥æå‡æ€§èƒ½
                requestAnimationFrame(() => {
                    this.domCache.todayTotal.textContent = todayStats.total;
                    this.domCache.todayCorrect.textContent = todayStats.correct;
                    this.domCache.todayAccuracy.textContent = todayStats.accuracy + '%';
                    
                    this.domCache.totalQuestions.textContent = allTimeStats.total;
                    this.domCache.totalCorrect.textContent = allTimeStats.correct;
                    this.domCache.totalAccuracy.textContent = allTimeStats.accuracy + '%';
                });
            }
            
            /**
             * æ›´æ–°æ‰€æœ‰æ—¶é—´ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
             */
            updateAllTimeStats() {
                // ä½¿ç”¨ç¼“å­˜çš„ç»Ÿè®¡æ•°æ®
                this.updateStatsCache();
                const allTimeStats = this.statsCache.allTimeStats;
                
                // æ‰¹é‡DOMæ›´æ–°
                requestAnimationFrame(() => {
                    this.domCache.allTimeTotal.textContent = allTimeStats.total;
                    this.domCache.allTimeCorrect.textContent = allTimeStats.correct;
                    this.domCache.allTimeAccuracy.textContent = allTimeStats.accuracy + '%';
                });
            }
            
            /**
             * æ›´æ–°å†å²è®°å½•åˆ—è¡¨ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
             */
            updateHistoryList() {
                // ä½¿ç”¨ç¼“å­˜çš„ä»Šæ—¥å†å²è®°å½•
                this.updateStatsCache();
                const todayHistory = this.statsCache.todayHistory.slice(-5);
                
                // ä½¿ç”¨DocumentFragmentæ‰¹é‡æ“ä½œDOM
                const fragment = document.createDocumentFragment();
                
                todayHistory.reverse().forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'history-item fade-in';
                    
                    // ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ä¼˜åŒ–HTMLç”Ÿæˆ
                    const badgeClass = record.correct ? 'bg-success' : 'bg-danger';
                    const badgeIcon = record.correct ? 'âœ“' : 'âœ—';
                    
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${this.escapeHtml(record.question)}</strong>
                                <br>
                                <small class="text-muted">${record.time}</small>
                            </div>
                            <div>
                                <span class="badge ${badgeClass}">
                                    ${badgeIcon} ${record.selectedAnswer}
                                </span>
                            </div>
                        </div>
                    `;
                    fragment.appendChild(item);
                });
                
                // æ‰¹é‡æ›´æ–°DOM
                requestAnimationFrame(() => {
                    this.domCache.historyList.innerHTML = '';
                    this.domCache.historyList.appendChild(fragment);
                });
            }
            
            /**
             * HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            /**
             * æ›´æ–°æ‰€æœ‰å†å²è®°å½•åˆ—è¡¨
             */
            updateAllHistoryList() {
                // æ¸…ç©ºå†å²è®°å½•åˆ—è¡¨
                this.domCache.allHistoryList.innerHTML = '';
                
                // å¦‚æœæ²¡æœ‰å†å²è®°å½•
                if (this.history.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'history-item text-center';
                    item.innerHTML = '<p class="mb-0">æš‚æ— å†å²è®°å½•</p>';
                    this.domCache.allHistoryList.appendChild(item);
                    return;
                }
                
                // æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤ºå†å²è®°å½•
                const groupedHistory = {};
                this.history.forEach(record => {
                    if (!groupedHistory[record.date]) {
                        groupedHistory[record.date] = [];
                    }
                    groupedHistory[record.date].push(record);
                });
                
                // æŒ‰æ—¥æœŸå€’åºæ˜¾ç¤º
                const sortedDates = Object.keys(groupedHistory).sort().reverse();
                
                sortedDates.forEach(date => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'alert alert-secondary mt-3 mb-2 py-2';
                    dateHeader.innerHTML = `<strong>${date}</strong>`;
                    this.domCache.allHistoryList.appendChild(dateHeader);
                    
                    groupedHistory[date].reverse().forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'history-item fade-in';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${record.question}</strong>
                                    <br>
                                    <small class="text-muted">${record.time}</small>
                                </div>
                                <div>
                                    <span class="badge ${record.correct ? 'bg-success' : 'bg-danger'}">
                                        ${record.correct ? 'âœ“' : 'âœ—'} ${record.selectedAnswer}
                                    </span>
                                </div>
                            </div>
                        `;
                        this.domCache.allHistoryList.appendChild(item);
                    });
                });
            }
            
            /**
             * æ˜¾ç¤ºåé¦ˆä¿¡æ¯
             */
            showFeedback(message, type) {
                this.domCache.feedback.textContent = message;
                this.domCache.feedback.className = `emoji-feedback fade-in text-${type}`;
                this.domCache.feedback.classList.remove('hidden');
            }
            
            /**
             * å¯ç”¨ç­”æ¡ˆæŒ‰é’®
             */
            enableAnswerButtons() {
                [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD].forEach(button => {
                    button.disabled = false;
                });
            }
            
            /**
             * ç¦ç”¨ç­”æ¡ˆæŒ‰é’®
             */
            disableAnswerButtons() {
                [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD].forEach(button => {
                    button.disabled = true;
                });
            }
            
            /**
             * æ‰“ä¹±æ•°ç»„é¡ºåº
             */
            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            /**
             * åŠ è½½å†å²è®°å½•
             */
            loadHistory() {
                const saved = localStorage.getItem('mixedMathTrainingHistory');
                return saved ? JSON.parse(saved) : [];
            }
            
            /**
             * ä¿å­˜å†å²è®°å½•
             */
            saveHistory() {
                localStorage.setItem('mixedMathTrainingHistory', JSON.stringify(this.history));
            }
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', () => {
            new MixedMathTrainingSystem();
        });
    </script>
</body>
</html>