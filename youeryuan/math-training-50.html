<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>50以内加减法智能训练 - 幼儿数学练习工具</title>
    <meta name="description" content="专为幼儿设计的50以内加减法智能训练工具，帮助孩子轻松掌握基础数学运算。">
    <meta name="keywords" content="幼儿数学,加减法练习,50以内加减法,数学训练,儿童教育">
    <meta name="author" content="jiangsuchenping">
    <meta property="og:title" content="50以内加减法智能训练 - 幼儿数学练习工具">
    <meta property="og:description" content="专为幼儿设计的50以内加减法智能训练工具，帮助孩子轻松掌握基础数学运算。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jiangsuchenping.github.io/youeryuan/math-training-50.html">
    <meta property="og:image" content="https://jiangsuchenping.github.io/youeryuan/math-training-preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="50以内加减法智能训练 - 幼儿数学练习工具">
    <meta name="twitter:description" content="专为幼儿设计的50以内加减法智能训练工具，帮助孩子轻松掌握基础数学运算。">
    <meta name="twitter:image" content="https://jiangsuchenping.github.io/youeryuan/math-training-preview.png">
    <!-- 预连接关键CDN域名 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- 关键CSS资源预加载 -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- 备用CSS加载 -->
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"></noscript>
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"></noscript>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 800px;
            padding: 30px;
        }
        
        .question-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(240, 147, 251, 0.3);
        }
        
        .answer-btn {
            font-size: 1.5rem;
            padding: 20px;
            margin: 10px;
            border-radius: 15px;
            border: none;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .answer-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .answer-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .correct {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%) !important;
            color: white;
        }
        
        .incorrect {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%) !important;
            color: white;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .daily-limit {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #007bff;
        }
        
        .emoji-feedback {
            font-size: 3rem;
            margin: 20px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        /* 艾宾浩斯记忆曲线复习提醒样式 */
        #reviewAlert {
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* 复习题目标记样式 */
        .badge.bg-warning {
            font-size: 0.8rem;
            padding: 0.3rem 0.5rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <h1 class="text-center mb-4">
                <i class="bi bi-calculator-fill text-primary"></i>
                50以内加减法智能训练
            </h1>
            
            <!-- 统计面板 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stats-card">
                        <h5><i class="bi bi-graph-up"></i> 今日统计</h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 id="todayTotal" class="text-primary">0</h3>
                                <small>总题数</small>
                            </div>
                            <div class="col-4">
                                <h3 id="todayCorrect" class="text-success">0</h3>
                                <small>正确数</small>
                            </div>
                            <div class="col-4">
                                <h3 id="todayAccuracy" class="text-warning">0%</h3>
                                <small>正确率</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card">
                        <h5><i class="bi bi-trophy"></i> 总统计</h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <h3 id="totalQuestions" class="text-primary">0</h3>
                                <small>总题数</small>
                            </div>
                            <div class="col-4">
                                <h3 id="totalCorrect" class="text-success">0</h3>
                                <small>正确数</small>
                            </div>
                            <div class="col-4">
                                <h3 id="totalAccuracy" class="text-warning">0%</h3>
                                <small>正确率</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 复习提醒 -->
            <div id="reviewAlert" class="alert alert-warning hidden">
                <i class="bi bi-lightbulb-fill"></i>
                <span id="reviewText">今日有 <span id="reviewCount">0</span> 道题目需要复习！</span>
            </div>
            
            <!-- 每日限制提示 -->
            <div id="dailyLimitAlert" class="daily-limit hidden">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="limitText"><i class="bi bi-exclamation-triangle-fill"></i> 今日训练已达到上限！</span>
                    <button id="resetLimitBtn" class="btn btn-sm btn-outline-primary">增加10题</button>
                </div>
            </div>
            
            <!-- 训练区域 -->
            <div id="trainingArea" class="text-center">
                <div class="question-card" id="questionCard">
                    <span id="question">准备开始</span>
                </div>
                
                <div id="answerOptions" class="row">
                    <div class="col-6 col-md-3">
                        <button class="btn btn-primary answer-btn" id="optionA">A</button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button class="btn btn-primary answer-btn" id="optionB">B</button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button class="btn btn-primary answer-btn" id="optionC">C</button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button class="btn btn-primary answer-btn" id="optionD">D</button>
                    </div>
                </div>
                
                <div id="feedback" class="emoji-feedback hidden"></div>
            </div>
            
            <!-- 今日答题记录 -->
            <div class="mt-5">
                <h4><i class="bi bi-clock-history"></i> 今日答题记录</h4>
                <div id="historyList" class="mt-3"></div>
            </div>
            
            <!-- 所有历史记录 -->
            <div class="mt-5">
                <h4><i class="bi bi-clock-history"></i> 历史统计</h4>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>累计答题</h5>
                            <h3 id="allTimeTotal" class="text-primary">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>正确答题</h5>
                            <h3 id="allTimeCorrect" class="text-success">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h5>正确率</h5>
                            <h3 id="allTimeAccuracy" class="text-warning">0%</h3>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="showAllHistoryBtn" class="btn btn-info">
                        <i class="bi bi-list"></i> 查看详细历史记录
                    </button>
                    <button id="showQuestionStatsBtn" class="btn btn-success ms-2">
                        <i class="bi bi-bar-chart"></i> 题目统计详情
                    </button>
                    <div id="allHistoryContainer" class="mt-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>详细历史记录</h5>
                            <button id="hideAllHistoryBtn" class="btn btn-sm btn-secondary">
                                <i class="bi bi-eye-slash"></i> 隐藏
                            </button>
                        </div>
                        <div id="allHistoryList"></div>
                    </div>
                    <div id="questionStatsContainer" class="mt-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>题目统计详情</h5>
                            <button id="hideQuestionStatsBtn" class="btn btn-sm btn-secondary">
                                <i class="bi bi-eye-slash"></i> 隐藏
                            </button>
                        </div>
                        <div id="questionStatsList" class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>题目</th>
                                        <th>总次数</th>
                                        <th>正确次数</th>
                                        <th>错误次数</th>
                                        <th>正确率</th>
                                        <th>最后答题时间</th>
                                    </tr>
                                </thead>
                                <tbody id="questionStatsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript 资源 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * 50以内加减法智能训练系统
         * 基于艾宾浩斯记忆曲线的智能出题系统
         */
        class MathTrainingSystem50 {
            constructor() {
                this.dailyLimit = 30; // 每日训练上限
                this.history = this.loadHistory();
                this.today = new Date().toISOString().split('T')[0];
                this.currentQuestion = null;
                this.currentReviewItem = null;
                
                // 缓存DOM元素
                this.cacheDOMElements();
                
                // 缓存今日历史记录以避免重复过滤
                this.todayHistory = this.history.filter(h => h.date === this.today);
                
                // 加载艾宾浩斯记忆曲线数据
                this.ebbinghausData = this.loadEbbinghausData();
                
                this.initializeEventListeners();
                this.updateStats();
                this.updateAllTimeStats();
                this.updateHistoryList();
                
                // 检查今日是否有需要复习的题目
                this.checkTodayReviews();
                
                // 检查每日训练上限并自动开始训练
                const isLimited = this.checkDailyLimit();
                if (!isLimited) {
                    // 自动开始训练
                    this.startTraining();
                }
            }
            
            /**
             * 缓存DOM元素以提高性能
             */
            cacheDOMElements() {
                this.domCache = {
                    question: document.getElementById('question'),
                    answerOptions: document.getElementById('answerOptions'),
                    optionA: document.getElementById('optionA'),
                    optionB: document.getElementById('optionB'),
                    optionC: document.getElementById('optionC'),
                    optionD: document.getElementById('optionD'),
                    feedback: document.getElementById('feedback'),
                    trainingArea: document.getElementById('trainingArea'),
                    todayTotal: document.getElementById('todayTotal'),
                    todayCorrect: document.getElementById('todayCorrect'),
                    todayAccuracy: document.getElementById('todayAccuracy'),
                    totalQuestions: document.getElementById('totalQuestions'),
                    totalCorrect: document.getElementById('totalCorrect'),
                    totalAccuracy: document.getElementById('totalAccuracy'),
                    dailyLimitAlert: document.getElementById('dailyLimitAlert'),
                    limitText: document.getElementById('limitText'),
                    resetLimitBtn: document.getElementById('resetLimitBtn'),
                    historyList: document.getElementById('historyList'),
                    allTimeTotal: document.getElementById('allTimeTotal'),
                    allTimeCorrect: document.getElementById('allTimeCorrect'),
                    allTimeAccuracy: document.getElementById('allTimeAccuracy'),
                    showAllHistoryBtn: document.getElementById('showAllHistoryBtn'),
                    hideAllHistoryBtn: document.getElementById('hideAllHistoryBtn'),
                    allHistoryContainer: document.getElementById('allHistoryContainer'),
                    allHistoryList: document.getElementById('allHistoryList'),
                    showQuestionStatsBtn: document.getElementById('showQuestionStatsBtn'),
                    hideQuestionStatsBtn: document.getElementById('hideQuestionStatsBtn'),
                    questionStatsContainer: document.getElementById('questionStatsContainer'),
                    questionStatsTableBody: document.getElementById('questionStatsTableBody'),
                    reviewAlert: document.getElementById('reviewAlert'),
                    reviewCount: document.getElementById('reviewCount'),
                    reviewText: document.getElementById('reviewText')
                };
            }
            
            /**
             * 初始化事件监听器
             */
            initializeEventListeners() {
                // 使用事件委托优化性能
                this.domCache.answerOptions.addEventListener('click', (e) => {
                    if (e.target.classList.contains('answer-btn') && !e.target.disabled) {
                        this.checkAnswer(e.target);
                    }
                });
                
                // 添加重置按钮事件监听器
                this.domCache.resetLimitBtn.addEventListener('click', () => this.resetDailyLimit());
                
                // 添加历史记录按钮事件监听器
                this.domCache.showAllHistoryBtn.addEventListener('click', () => {
                    // 隐藏题目统计容器
                    this.domCache.questionStatsContainer.style.display = 'none';
                    // 显示历史记录容器
                    this.domCache.allHistoryContainer.style.display = 'block';
                    this.updateAllHistoryList();
                });
                
                this.domCache.hideAllHistoryBtn.addEventListener('click', () => {
                    this.domCache.allHistoryContainer.style.display = 'none';
                });
                
                // 添加题目统计详情按钮事件监听器
                this.domCache.showQuestionStatsBtn.addEventListener('click', () => {
                    // 隐藏历史记录容器
                    this.domCache.allHistoryContainer.style.display = 'none';
                    // 显示题目统计容器
                    this.domCache.questionStatsContainer.style.display = 'block';
                    this.updateQuestionStats();
                });
                
                this.domCache.hideQuestionStatsBtn.addEventListener('click', () => {
                    this.domCache.questionStatsContainer.style.display = 'none';
                });
            }
            
            /**
             * 检查每日训练上限（支持额外增加的题目数量）
             */
            checkDailyLimit() {
                // 更新缓存的今日历史记录
                this.todayHistory = this.history.filter(h => h.date === this.today);
                
                // 获取额外增加的题目数量
                const extraKey = `mathTraining50Extra_${this.today}`;
                const extraCount = parseInt(localStorage.getItem(extraKey) || '0');
                
                // 计算实际的上限（基础上限 + 额外增加的题目）
                const actualLimit = this.dailyLimit + extraCount;
                
                // 检查今日是否已达到训练上限
                if (this.todayHistory.length >= actualLimit) {
                    // 显示每日限制提示
                    this.domCache.dailyLimitAlert.classList.remove('hidden');
                    
                    // 隐藏训练区域
                    this.domCache.trainingArea.classList.add('hidden');
                    
                    // 更新提示信息
                    const limitText = this.domCache.limitText;
                    if (limitText) {
                        if (extraCount > 0) {
                            limitText.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> 今日已答${this.todayHistory.length}题，已达到${actualLimit}题上限（含${extraCount}道额外题目）！`;
                        } else {
                            limitText.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> 今日训练已达到上限（${this.dailyLimit}题），明天再来继续吧！`;
                        }
                    }
                    
                    return true; // 已达到限制
                } else {
                    // 未达到上限，隐藏限制提示
                    this.domCache.dailyLimitAlert.classList.add('hidden');
                    this.domCache.trainingArea.classList.remove('hidden');
                    
                    return false; // 未达到限制
                }
            }
            
            /**
             * 增加当日训练上限（每次增加10道题）
             */
            resetDailyLimit() {
                // 确认用户是否要增加训练上限
                if (confirm(`确定要增加今日训练上限吗？将额外增加10道题（当前已答：${this.todayHistory.length}道）`)) {
                    // 在localStorage中存储增加的题目数量
                    const extraKey = `mathTraining50Extra_${this.today}`;
                    let extraCount = parseInt(localStorage.getItem(extraKey) || '0');
                    extraCount += 10; // 每次增加10道题
                    localStorage.setItem(extraKey, extraCount.toString());
                    
                    // 隐藏每日限制提示
                    this.domCache.dailyLimitAlert.classList.add('hidden');
                    
                    // 显示训练区域
                    this.domCache.trainingArea.classList.remove('hidden');
                    
                    // 显示增加成功的反馈
                    this.showFeedback(`✅ 今日训练上限已增加10道题！（额外：${extraCount}道）`, 'success');
                    
                    // 生成第一题
                    this.generateNextQuestion();
                }
            }
            
            /**
             * 开始训练
             */
            startTraining() {
                // 检查是否达到每日限制
                const isLimited = this.checkDailyLimit();
                
                // 如果未达到限制，则开始训练
                if (!isLimited) {
                    // 显示答案选项区域
                    this.domCache.answerOptions.classList.remove('hidden');
                    // 生成第一个问题
                    this.generateNextQuestion();
                }
                
                // 更新复习提醒状态
                this.updateReviewAlert();
            }
            
            /**
             * 生成下一题（自动延迟）
             */
            generateNextQuestion() {
                setTimeout(() => {
                    this.currentQuestion = this.generateSmartQuestion();
                    this.displayQuestion();
                    this.enableAnswerButtons();
                }, 1500); // 1.5秒后自动进入下一题
            }
            
            /**
             * 根据历史答题情况智能生成题目
             */
            generateSmartQuestion() {
                // 默认参数
                let maxNumber = 50;
                let isAddition = Math.random() > 0.5;
                let useWeakNumbers = false;
                let weakNumbers = [];
                
                // 检查是否有需要复习的题目（艾宾浩斯记忆曲线）
                const reviewQuestion = this.getReviewQuestionByEbbinghaus();
                if (reviewQuestion) {
                    return reviewQuestion;
                }
                
                // 获取今日历史记录和最近历史记录
                const todayHistory = this.history.filter(h => h.date === this.today);
                const recentHistory = this.history.slice(-20); // 最近20道题
                
                // 分析用户答题模式
                const pattern = this.analyzeUserPattern();
                
                if (pattern && pattern.weakNumbers.length > 0) {
                    // 使用高级分析结果
                    
                    // 根据加减法正确率调整难度和题型
                    if (pattern.additionAccuracy > 0.8 && pattern.subtractionAccuracy > 0.8) {
                        maxNumber = 50; // 两种题型都掌握得很好，增加难度
                    } else if (pattern.additionAccuracy < 0.5 && pattern.subtractionAccuracy < 0.5) {
                        maxNumber = 25; // 两种题型都掌握不好，降低难度
                    } else {
                        maxNumber = 35; // 保持中等难度
                    }
                    
                    // 根据小数字和大数字的正确率进一步调整
                    if (pattern.smallNumberAccuracy > 0.8 && pattern.largeNumberAccuracy < 0.6) {
                        // 小数字掌握好但大数字不行，适当降低难度
                        maxNumber = Math.min(maxNumber, 35);
                    }
                    
                    // 确定题目类型，优先选择正确率较低的类型
                    if (Math.abs(pattern.additionAccuracy - pattern.subtractionAccuracy) > 0.2) {
                        // 70%的概率出现正确率较低的题型
                        if (Math.random() < 0.7) {
                            isAddition = pattern.additionAccuracy > pattern.subtractionAccuracy ? false : true;
                        }
                    }
                    
                    // 使用弱点数字
                    weakNumbers = pattern.weakNumbers;
                    useWeakNumbers = Math.random() < 0.4; // 40%概率使用弱点数字
                } else if (todayHistory.length > 0) {
                    // 使用基本分析结果
                    const accuracy = todayHistory.filter(h => h.correct).length / todayHistory.length;
                    
                    if (accuracy > 0.8) {
                        maxNumber = 50; // 正确率高，增加难度
                    } else if (accuracy < 0.5) {
                        maxNumber = 25; // 正确率低，降低难度
                    }
                }
                
                // 生成题目
                let num1, num2, question, answer;
                
                if (useWeakNumbers && weakNumbers.length > 0) {
                    // 使用弱点数字生成题目
                    const weakNum = weakNumbers[Math.floor(Math.random() * weakNumbers.length)];
                    if (isAddition) {
                        num2 = Math.floor(Math.random() * (maxNumber - weakNum)) + 1;
                        num1 = weakNum;
                        question = `${num1} + ${num2} = ?`;
                        answer = num1 + num2;
                    } else {
                        num1 = Math.max(weakNum, Math.floor(Math.random() * maxNumber) + weakNum);
                        num2 = Math.min(num1 - 1, weakNum);
                        question = `${num1} - ${num2} = ?`;
                        answer = num1 - num2;
                    }
                } else {
                    // 正常生成题目
                    if (isAddition) {
                        num1 = Math.floor(Math.random() * maxNumber) + 1;
                        num2 = Math.floor(Math.random() * (maxNumber - num1 + 1)) + 1;
                        question = `${num1} + ${num2} = ?`;
                        answer = num1 + num2;
                    } else {
                        num1 = Math.floor(Math.random() * maxNumber) + 1;
                        num2 = Math.floor(Math.random() * num1) + 1;
                        question = `${num1} - ${num2} = ?`;
                        answer = num1 - num2;
                    }
                }
                
                return { question, answer, num1, num2, type: isAddition ? 'addition' : 'subtraction', isAddition };
            }
            
            /**
             * 显示问题
             */
            displayQuestion() {
                this.domCache.question.textContent = this.currentQuestion.question;
                
                // 生成随机选项
                const answers = [this.currentQuestion.answer];
                while (answers.length < 4) {
                    const randomAnswer = Math.floor(Math.random() * 50) + 1;
                    if (!answers.includes(randomAnswer)) {
                        answers.push(randomAnswer);
                    }
                }
                
                // 打乱选项顺序
                answers.sort(() => Math.random() - 0.5);
                
                // 更新按钮文本
                const buttons = [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD];
                buttons.forEach((button, index) => {
                    button.textContent = answers[index];
                    button.className = 'btn btn-primary answer-btn';
                    button.disabled = false;
                });
                
                // 隐藏反馈
                this.domCache.feedback.className = 'emoji-feedback hidden';
            }
            
            /**
             * 检查答案
             */
            checkAnswer(button) {
                const selectedAnswer = parseInt(button.textContent);
                const isCorrect = selectedAnswer === this.currentQuestion.answer;
                
                // 禁用所有按钮
                this.disableAnswerButtons();
                
                // 显示反馈
                if (isCorrect) {
                    this.showFeedback('✅ 答对了！', 'success');
                } else {
                    this.showFeedback(`❌ 答错了！正确答案是 ${this.currentQuestion.answer}`, 'danger');
                }
                
                // 标记正确答案
                const buttons = [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD];
                buttons.forEach(btn => {
                    const btnAnswer = parseInt(btn.textContent);
                    if (btnAnswer === this.currentQuestion.answer) {
                        btn.className = 'btn btn-success answer-btn';
                    } else if (btn === button && !isCorrect) {
                        btn.className = 'btn btn-danger answer-btn';
                    } else {
                        btn.className = 'btn btn-secondary answer-btn';
                    }
                });
                
                // 记录答案
                this.recordAnswer(selectedAnswer, isCorrect);
            }
            
            /**
             * 记录答案
             */
            recordAnswer(selectedAnswer, isCorrect) {
                const record = {
                    date: this.today,
                    time: new Date().toLocaleTimeString('zh-CN', { hour12: false }),
                    question: this.currentQuestion.question,
                    correctAnswer: this.currentQuestion.answer,
                    selectedAnswer: selectedAnswer,
                    correct: isCorrect,
                    type: this.currentQuestion.type,
                    isReview: this.currentQuestion.isReview || false
                };
                
                this.history.push(record);
                this.saveHistory();
                
                // 更新缓存的今日历史记录
                this.todayHistory = this.history.filter(h => h.date === this.today);
                
                // 更新统计信息
                this.updateStats();
                this.updateAllTimeStats();
                this.updateHistoryList();
                
                // 检查每日训练上限
                const isLimited = this.checkDailyLimit();
                
                // 如果未达到上限，自动进入下一题
                if (!isLimited) {
                    this.generateNextQuestion();
                }
            }
            
            /**
             * 更新统计信息
             */
            updateStats() {
                const todayHistory = this.history.filter(h => h.date === this.today);
                const todayTotal = todayHistory.length;
                const todayCorrect = todayHistory.filter(h => h.correct).length;
                const todayAccuracy = todayTotal > 0 ? Math.round((todayCorrect / todayTotal) * 100) : 0;
                
                this.domCache.todayTotal.textContent = todayTotal;
                this.domCache.todayCorrect.textContent = todayCorrect;
                this.domCache.todayAccuracy.textContent = todayAccuracy + '%';
            }
            
            /**
             * 更新所有时间统计
             */
            updateAllTimeStats() {
                const totalAll = this.history.length;
                const correctAll = this.history.filter(h => h.correct).length;
                const accuracyAll = totalAll > 0 ? Math.round((correctAll / totalAll) * 100) : 0;
                
                this.domCache.allTimeTotal.textContent = totalAll;
                this.domCache.allTimeCorrect.textContent = correctAll;
                this.domCache.allTimeAccuracy.textContent = accuracyAll + '%';
            }
            
            /**
             * 更新历史记录列表（今日）
             */
            updateHistoryList() {
                const todayHistory = this.history.filter(h => h.date === this.today).slice(-5);
                
                // 使用文档片段减少DOM操作
                const fragment = document.createDocumentFragment();
                
                // 清空历史记录列表
                this.domCache.historyList.innerHTML = '';
                
                // 批量创建元素
                todayHistory.reverse().forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'history-item fade-in';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${record.question}</strong>
                                <br>
                                <small class="text-muted">${record.time}</small>
                            </div>
                            <div>
                                <span class="badge ${record.correct ? 'bg-success' : 'bg-danger'}">
                                    ${record.correct ? '✓' : '✗'} ${record.selectedAnswer}
                                </span>
                            </div>
                        </div>
                    `;
                    fragment.appendChild(item);
                });
                
                // 一次性添加到DOM
                this.domCache.historyList.appendChild(fragment);
            }
            
            /**
             * 更新所有历史记录列表
             */
            updateAllHistoryList() {
                // 使用文档片段减少DOM操作
                const fragment = document.createDocumentFragment();
                
                // 清空历史记录列表
                this.domCache.allHistoryList.innerHTML = '';
                
                // 如果没有历史记录
                if (this.history.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'history-item text-center';
                    item.innerHTML = '<p class="mb-0">暂无历史记录</p>';
                    fragment.appendChild(item);
                    this.domCache.allHistoryList.appendChild(fragment);
                    return;
                }
                
                // 按日期分组显示历史记录
                const groupedHistory = {};
                this.history.forEach(record => {
                    if (!groupedHistory[record.date]) {
                        groupedHistory[record.date] = [];
                    }
                    groupedHistory[record.date].push(record);
                });
                
                // 按日期倒序显示
                const sortedDates = Object.keys(groupedHistory).sort().reverse();
                
                sortedDates.forEach(date => {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'alert alert-secondary mt-3 mb-2 py-2';
                    dateHeader.innerHTML = `<strong>${date}</strong>`;
                    fragment.appendChild(dateHeader);
                    
                    groupedHistory[date].reverse().forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'history-item fade-in';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${record.question}</strong>
                                    <br>
                                    <small class="text-muted">${record.time}</small>
                                </div>
                                <div>
                                    <span class="badge ${record.correct ? 'bg-success' : 'bg-danger'}">
                                        ${record.correct ? '✓' : '✗'} ${record.selectedAnswer}
                                    </span>
                                </div>
                            </div>
                        `;
                        fragment.appendChild(item);
                    });
                });
                
                // 一次性添加到DOM
                this.domCache.allHistoryList.appendChild(fragment);
            }
            
            /**
             * 更新题目统计详情
             */
            updateQuestionStats() {
                // 使用文档片段减少DOM操作
                const fragment = document.createDocumentFragment();
                
                // 清空题目统计表格
                this.domCache.questionStatsTableBody.innerHTML = '';
                
                // 如果没有历史记录
                if (this.history.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6" class="text-center">暂无历史记录</td>';
                    fragment.appendChild(row);
                    this.domCache.questionStatsTableBody.appendChild(fragment);
                    return;
                }
                
                // 按题目分组统计
                const questionStats = {};
                this.history.forEach(record => {
                    const question = record.question;
                    if (!questionStats[question]) {
                        questionStats[question] = {
                            question: question,
                            total: 0,
                            correct: 0,
                            incorrect: 0,
                            lastTime: record.time,
                            lastDate: record.date
                        };
                    }
                    
                    // 更新统计信息
                    questionStats[question].total++;
                    if (record.correct) {
                        questionStats[question].correct++;
                    } else {
                        questionStats[question].incorrect++;
                    }
                    
                    // 更新最后答题时间（按日期和时间排序）
                    const currentDate = new Date(record.date + ' ' + record.time);
                    const lastDate = new Date(questionStats[question].lastDate + ' ' + questionStats[question].lastTime);
                    if (currentDate > lastDate) {
                        questionStats[question].lastTime = record.time;
                        questionStats[question].lastDate = record.date;
                    }
                });
                
                // 计算正确率并生成表格行
                Object.values(questionStats).forEach(stats => {
                    const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${stats.question}</td>
                        <td>${stats.total}</td>
                        <td class="text-success">${stats.correct}</td>
                        <td class="text-danger">${stats.incorrect}</td>
                        <td>
                            <span class="badge ${accuracy >= 80 ? 'bg-success' : accuracy >= 60 ? 'bg-warning' : 'bg-danger'}">
                                ${accuracy}%
                            </span>
                        </td>
                        <td>${stats.lastDate} ${stats.lastTime}</td>
                    `;
                    fragment.appendChild(row);
                });
                
                // 一次性添加到DOM
                this.domCache.questionStatsTableBody.appendChild(fragment);
            }
            
            /**
             * 显示反馈信息
             */
            showFeedback(message, type) {
                this.domCache.feedback.textContent = message;
                this.domCache.feedback.className = `emoji-feedback fade-in text-${type}`;
                this.domCache.feedback.classList.remove('hidden');
            }
            
            /**
             * 启用答案按钮
             */
            enableAnswerButtons() {
                [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD].forEach(button => {
                    button.disabled = false;
                });
            }
            
            /**
             * 禁用答案按钮
             */
            disableAnswerButtons() {
                [this.domCache.optionA, this.domCache.optionB, this.domCache.optionC, this.domCache.optionD].forEach(button => {
                    button.disabled = true;
                });
            }
            
            /**
             * 分析用户答题模式
             */
            analyzeUserPattern() {
                // 获取最近的答题记录
                const recentHistory = this.history.slice(-30); // 最近30道题
                if (recentHistory.length < 5) return null; // 数据不足，无法分析
                
                const result = {
                    additionAccuracy: 0,
                    subtractionAccuracy: 0,
                    smallNumberAccuracy: 0,
                    largeNumberAccuracy: 0,
                    weakNumbers: []
                };
                
                // 分析加减法正确率
                const additionHistory = recentHistory.filter(h => h.type === 'addition');
                const subtractionHistory = recentHistory.filter(h => h.type === 'subtraction');
                
                if (additionHistory.length > 0) {
                    result.additionAccuracy = additionHistory.filter(h => h.correct).length / additionHistory.length;
                }
                
                if (subtractionHistory.length > 0) {
                    result.subtractionAccuracy = subtractionHistory.filter(h => h.correct).length / subtractionHistory.length;
                }
                
                // 分析不同数字范围的正确率
                const smallNumberQuestions = recentHistory.filter(record => {
                    const numbers = record.question.match(/\d+/g);
                    return numbers && numbers.every(num => parseInt(num) <= 10);
                });
                
                const largeNumberQuestions = recentHistory.filter(record => {
                    const numbers = record.question.match(/\d+/g);
                    return numbers && numbers.some(num => parseInt(num) > 10);
                });
                
                if (smallNumberQuestions.length > 0) {
                    result.smallNumberAccuracy = smallNumberQuestions.filter(h => h.correct).length / smallNumberQuestions.length;
                }
                
                if (largeNumberQuestions.length > 0) {
                    result.largeNumberAccuracy = largeNumberQuestions.filter(h => h.correct).length / largeNumberQuestions.length;
                }
                
                return result;
            }
            
            /**
             * 检查今日是否有需要复习的题目
             */
            checkTodayReviews() {
                const ebbinghausData = this.loadEbbinghausData();
                if (!ebbinghausData || ebbinghausData.length === 0) {
                    this.domCache.reviewAlert.classList.add('hidden');
                    return;
                }
                
                const today = this.today;
                const todayReviews = ebbinghausData.filter(item => 
                    item.reviewDates.includes(today) && 
                    !item.reviewStatus[item.reviewDates.indexOf(today)] &&
                    !item.answeredCorrectToday
                );
                
                if (todayReviews.length > 0) {
                    this.domCache.reviewCount.textContent = todayReviews.length;
                    this.domCache.reviewText.textContent = `今日有 ${todayReviews.length} 道题目需要复习！`;
                    this.domCache.reviewAlert.classList.remove('hidden');
                } else {
                    this.domCache.reviewAlert.classList.add('hidden');
                }
            }
            
            /**
             * 根据艾宾浩斯记忆曲线获取复习题目
             */
            getReviewQuestionByEbbinghaus() {
                const ebbinghausData = this.loadEbbinghausData();
                if (!ebbinghausData || ebbinghausData.length === 0) return null;
                
                const today = this.today;
                const todayReviews = ebbinghausData.filter(item => 
                    item.reviewDates.includes(today) && 
                    !item.reviewStatus[item.reviewDates.indexOf(today)] &&
                    !item.answeredCorrectToday
                );
                
                if (todayReviews.length === 0) return null;
                
                // 随机选择一道复习题目
                const reviewItem = todayReviews[Math.floor(Math.random() * todayReviews.length)];
                
                // 解析题目
                const match = reviewItem.question.match(/(\d+)\s*([+\-])\s*(\d+)\s*=/);
                if (!match) return null;
                
                const num1 = parseInt(match[1]);
                const operator = match[2];
                const num2 = parseInt(match[3]);
                
                const isAddition = operator === '+';
                const answer = isAddition ? num1 + num2 : num1 - num2;
                
                return {
                    question: reviewItem.question,
                    answer: answer,
                    num1: num1,
                    num2: num2,
                    type: isAddition ? 'addition' : 'subtraction',
                    isAddition: isAddition,
                    isReview: true,
                    reviewItem: reviewItem
                };
            }
            
            /**
             * 更新复习提醒状态
             */
            updateReviewAlert() {
                this.checkTodayReviews();
            }
            
            /**
             * 加载历史记录
             */
            loadHistory() {
                try {
                    const saved = localStorage.getItem('mathTraining50History');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    console.error('加载历史记录失败:', e);
                    return [];
                }
            }
            
            /**
             * 保存历史记录
             */
            saveHistory() {
                try {
                    localStorage.setItem('mathTraining50History', JSON.stringify(this.history));
                } catch (e) {
                    console.error('保存历史记录失败:', e);
                }
            }
            
            /**
             * 加载艾宾浩斯记忆曲线数据
             */
            loadEbbinghausData() {
                try {
                    const saved = localStorage.getItem('mathTraining50Ebbinghaus');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    console.error('加载艾宾浩斯数据失败:', e);
                    return [];
                }
            }
            
            /**
             * 保存艾宾浩斯记忆曲线数据
             */
            saveEbbinghausData(data) {
                try {
                    localStorage.setItem('mathTraining50Ebbinghaus', JSON.stringify(data));
                } catch (e) {
                    console.error('保存艾宾浩斯数据失败:', e);
                }
            }
        }
        
        // 初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            new MathTrainingSystem50();
        });
    </script>
</body>
</html>